var ue=(s=>(s[s.Max=2]="Max",s[s.Min=.8]="Min",s))(ue||{}),Yt=(s=>(s[s.Left=-1]="Left",s[s.Right=1]="Right",s[s.Bottom=-1]="Bottom",s[s.Top=1]="Top",s))(Yt||{}),wt=(s=>(s[s.Left=-2]="Left",s[s.Right=2]="Right",s[s.Bottom=-2]="Bottom",s[s.Top=2]="Top",s))(wt||{}),ft=(s=>(s.Idle="Idle",s.TapBody="TapBody",s.TapLeft="TapLeft",s.TapRight="TapRight",s.Tap="Tap",s))(ft||{}),R=(s=>(s.Head="Head",s.Body="Body",s.Left="Left",s.Right="Right",s.Other="Other",s))(R||{}),K=(s=>(s[s.None=0]="None",s[s.Idle=1]="Idle",s[s.Normal=2]="Normal",s[s.Force=3]="Force",s))(K||{});const ht=globalThis.document||{},F={canvas:{width:280,height:360},scale:1,debug:!1,target:ht.body,source:{path:"",models:[]},cubismCorePath:"/live2d/core/live2dCubismCore.min.js"},Ls=s=>{F.target=ht.body,Object.keys(s).forEach(t=>{F.hasOwnProperty(t)&&(F[t]=s[t])})};class x{constructor(t=0){t<1?(this._ptr=[],this._capacity=0,this._size=0):(this._ptr=new Array(t),this._capacity=t,this._size=0)}at(t){return this._ptr[t]}set(t,e){this._ptr[t]=e}get(t=0){const e=new Array;for(let i=t;i<this._size;i++)e.push(this._ptr[i]);return e}pushBack(t){this._size>=this._capacity&&this.prepareCapacity(this._capacity==0?x.s_defaultSize:this._capacity*2),this._ptr[this._size++]=t}clear(){this._ptr.length=0,this._size=0}getSize(){return this._size}assign(t,e){this._size<t&&this.prepareCapacity(t);for(let r=0;r<t;r++)this._ptr[r]=e;this._size=t}resize(t,e=null){this.updateSize(t,e,!0)}updateSize(t,e=null,i=!0){if(this._size<t)if(this.prepareCapacity(t),i)for(let a=this._size;a<t;a++)typeof e=="function"?this._ptr[a]=JSON.parse(JSON.stringify(new e)):this._ptr[a]=e;else for(let a=this._size;a<t;a++)this._ptr[a]=e;else{const a=this._size-t;this._ptr.splice(this._size-a,a)}this._size=t}insert(t,e,i){let r=t._index;const a=e._index,o=i._index,n=o-a;this.prepareCapacity(this._size+n);const l=this._size-r;if(l>0)for(let u=0;u<l;u++)this._ptr.splice(r+u,0,null);for(let u=a;u<o;u++,r++)this._ptr[r]=e._vector._ptr[u];this._size=this._size+n}remove(t){return t<0||this._size<=t?!1:(this._ptr.splice(t,1),--this._size,!0)}erase(t){const e=t._index;return e<0||this._size<=e?t:(this._ptr.splice(e,1),--this._size,new jt(this,e))}prepareCapacity(t){t>this._capacity&&(this._capacity==0?(this._ptr=new Array(t),this._capacity=t):(this._ptr.length=t,this._capacity=t))}begin(){return this._size==0?this.end():new jt(this,0)}end(){return new jt(this,this._size)}getOffset(t){const e=new x;return e._ptr=this.get(t),e._size=this.get(t).length,e._capacity=this.get(t).length,e}_ptr;_size;_capacity;static s_defaultSize=10}let jt=class Ee{constructor(t,e){this._vector=t??null,this._index=e??0}set(t){return this._index=t._index,this._vector=t._vector,this}preIncrement(){return++this._index,this}preDecrement(){return--this._index,this}increment(){return new Ee(this._vector,this._index++)}decrement(){return new Ee(this._vector,this._index--)}ptr(){return this._vector._ptr[this._index]}substitution(t){return this._index=t._index,this._vector=t._vector,this}notEqual(t){return this._index!=t._index||this._vector!=t._vector}_index;_vector};var De;(s=>{s.csmVector=x,s.iterator=jt})(De||(De={}));class U{append(t,e){return this.s+=e!==void 0?t.substr(0,e):t,this}expansion(t,e){for(let i=0;i<t;i++)this.append(e);return this}getBytes(){return encodeURIComponent(this.s).replace(/%../g,"x").length}getLength(){return this.s.length}isLess(t){return this.s<t.s}isGreat(t){return this.s>t.s}isEqual(t){return this.s==t}isEmpty(){return this.s.length==0}constructor(t){this.s=t}s}var ke;(s=>{s.csmString=U})(ke||(ke={}));class Xt{getString(){return this._id}constructor(t){if(typeof t=="string"){this._id=new U(t);return}this._id=t}isEqual(t){return typeof t=="string"?this._id.isEqual(t):t instanceof U?this._id.isEqual(t.s):t instanceof Xt?this._id.isEqual(t._id.s):!1}isNotEqual(t){return typeof t=="string"?!this._id.isEqual(t):t instanceof U?!this._id.isEqual(t.s):t instanceof Xt?!this._id.isEqual(t._id.s):!1}_id}var Oe;(s=>{s.CubismId=Xt})(Oe||(Oe={}));class Ne{constructor(){this._ids=new x}release(){for(let t=0;t<this._ids.getSize();++t)this._ids.set(t,void 0);this._ids=null}registerIds(t){for(let e=0;e<t.length;e++)this.registerId(t[e])}registerId(t){let e=null;if(typeof t=="string"){if((e=this.findId(t))!=null)return e;e=new Xt(t),this._ids.pushBack(e)}else return this.registerId(t.s);return e}getId(t){return this.registerId(t)}isExist(t){return typeof t=="string"?this.findId(t)!=null:this.isExist(t.s)}findId(t){for(let e=0;e<this._ids.getSize();++e)if(this._ids.at(e).getString().isEqual(t))return this._ids.at(e);return null}_ids}var Ue;(s=>{s.CubismIdManager=Ne})(Ue||(Ue={}));class E{constructor(){this._tr=new Float32Array(16),this.loadIdentity()}static multiply(t,e,i){const r=new Float32Array([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]),a=4;for(let o=0;o<a;++o)for(let n=0;n<a;++n)for(let l=0;l<a;++l)r[n+o*4]+=t[l+o*4]*e[n+l*4];for(let o=0;o<16;++o)i[o]=r[o]}loadIdentity(){const t=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]);this.setMatrix(t)}setMatrix(t){for(let e=0;e<16;++e)this._tr[e]=t[e]}getArray(){return this._tr}getScaleX(){return this._tr[0]}getScaleY(){return this._tr[5]}getTranslateX(){return this._tr[12]}getTranslateY(){return this._tr[13]}transformX(t){return this._tr[0]*t+this._tr[12]}transformY(t){return this._tr[5]*t+this._tr[13]}invertTransformX(t){return(t-this._tr[12])/this._tr[0]}invertTransformY(t){return(t-this._tr[13])/this._tr[5]}translateRelative(t,e){const i=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,t,e,0,1]);E.multiply(i,this._tr,this._tr)}translate(t,e){this._tr[12]=t,this._tr[13]=e}translateX(t){this._tr[12]=t}translateY(t){this._tr[13]=t}scaleRelative(t,e){const i=new Float32Array([t,0,0,0,0,e,0,0,0,0,1,0,0,0,0,1]);E.multiply(i,this._tr,this._tr)}scale(t,e){this._tr[0]=t,this._tr[5]=e}multiplyByMatrix(t){E.multiply(t.getArray(),this._tr,this._tr)}clone(){const t=new E;for(let e=0;e<this._tr.length;e++)t._tr[e]=this._tr[e];return t}_tr}var ze;(s=>{s.CubismMatrix44=E})(ze||(ze={}));class Gt{static create(){return null}static delete(t){}initialize(t){this._model=t}drawModel(){this.getModel()!=null&&(this.saveProfile(),this.doDrawModel(),this.restoreProfile())}setMvpMatrix(t){this._mvpMatrix4x4.setMatrix(t.getArray())}getMvpMatrix(){return this._mvpMatrix4x4}setModelColor(t,e,i,r){t<0?t=0:t>1&&(t=1),e<0?e=0:e>1&&(e=1),i<0?i=0:i>1&&(i=1),r<0?r=0:r>1&&(r=1),this._modelColor.R=t,this._modelColor.G=e,this._modelColor.B=i,this._modelColor.A=r}getModelColor(){return JSON.parse(JSON.stringify(this._modelColor))}setIsPremultipliedAlpha(t){this._isPremultipliedAlpha=t}isPremultipliedAlpha(){return this._isPremultipliedAlpha}setIsCulling(t){this._isCulling=t}isCulling(){return this._isCulling}setAnisotropy(t){this._anisotropy=t}getAnisotropy(){return this._anisotropy}getModel(){return this._model}useHighPrecisionMask(t){this._useHighPrecisionMask=t}isUsingHighPrecisionMask(){return this._useHighPrecisionMask}constructor(){this._isCulling=!1,this._isPremultipliedAlpha=!1,this._anisotropy=0,this._model=null,this._modelColor=new Z,this._useHighPrecisionMask=!1,this._mvpMatrix4x4=new E,this._mvpMatrix4x4.loadIdentity()}static staticRelease;_mvpMatrix4x4;_modelColor;_isCulling;_isPremultipliedAlpha;_anisotropy;_model;_useHighPrecisionMask}var G=(s=>(s[s.CubismBlendMode_Normal=0]="CubismBlendMode_Normal",s[s.CubismBlendMode_Additive=1]="CubismBlendMode_Additive",s[s.CubismBlendMode_Multiplicative=2]="CubismBlendMode_Multiplicative",s))(G||{});class Z{constructor(){this.R=1,this.G=1,this.B=1,this.A=1}R;G;B;A}var Xe;(s=>{s.CubismBlendMode=G,s.CubismRenderer=Gt,s.CubismTextureColor=Z})(Xe||(Xe={}));const Ds=(s,t,e)=>{Ye.print(s,"[CSM]"+t,e)},Ht=(s,t,e)=>{Ds(s,t+`
`,e)},H=s=>{console.assert(s)};let Rt,Q,st,k;Rt=(s,...t)=>{Ht(Mt.LogLevel_Debug,"[D]"+s,t)},Q=(s,...t)=>{Ht(Mt.LogLevel_Info,"[I]"+s,t)},st=(s,...t)=>{Ht(Mt.LogLevel_Warning,"[W]"+s,t)},k=(s,...t)=>{Ht(Mt.LogLevel_Error,"[E]"+s,t)};class Ye{static print(t,e,i){if(t<V.getLoggingLevel())return;const r=V.coreLogFunction;if(!r)return;const a=e.replace(/\{(\d+)\}/g,(o,n)=>i[n]);r(a)}static dumpBytes(t,e,i){for(let r=0;r<i;r++)r%16==0&&r>0?this.print(t,`
`):r%8==0&&r>0&&this.print(t,"  "),this.print(t,"{0} ",[e[r]&255]);this.print(t,`
`)}constructor(){}}var je;(s=>{s.CubismDebug=Ye})(je||(je={}));class Ge{constructor(t,e){this.first=t??null,this.second=e??null}first;second}class O{constructor(t){t!=null?t<1?(this._keyValues=[],this._dummyValue=null,this._size=0):(this._keyValues=new Array(t),this._size=t):(this._keyValues=[],this._dummyValue=null,this._size=0)}release(){this.clear()}appendKey(t){this.prepareCapacity(this._size+1,!1),this._keyValues[this._size]=new Ge(t),this._size+=1}getValue(t){let e=-1;for(let i=0;i<this._size;i++)if(this._keyValues[i].first==t){e=i;break}return e>=0?this._keyValues[e].second:(this.appendKey(t),this._keyValues[this._size-1].second)}setValue(t,e){let i=-1;for(let r=0;r<this._size;r++)if(this._keyValues[r].first==t){i=r;break}i>=0?this._keyValues[i].second=e:(this.appendKey(t),this._keyValues[this._size-1].second=e)}isExist(t){for(let e=0;e<this._size;e++)if(this._keyValues[e].first==t)return!0;return!1}clear(){this._keyValues=void 0,this._keyValues=null,this._keyValues=[],this._size=0}getSize(){return this._size}prepareCapacity(t,e){t>this._keyValues.length&&(this._keyValues.length==0?(!e&&t<O.DefaultSize&&(t=O.DefaultSize),this._keyValues.length=t):(!e&&t<this._keyValues.length*2&&(t=this._keyValues.length*2),this._keyValues.length=t))}begin(){return new mt(this,0)}end(){return new mt(this,this._size)}erase(t){const e=t._index;return e<0||this._size<=e?t:(this._keyValues.splice(e,1),--this._size,new mt(this,e))}dumpAsInt(){for(let t=0;t<this._size;t++)Rt("{0} ,",this._keyValues[t]),Rt(`
`)}static DefaultSize=10;_keyValues;_dummyValue;_size}class mt{constructor(t,e){this._map=t??new O,this._index=e??0}set(t){return this._index=t._index,this._map=t._map,this}preIncrement(){return++this._index,this}preDecrement(){return--this._index,this}increment(){return new mt(this._map,this._index++)}decrement(){const t=new mt(this._map,this._index);return this._map=t._map,this._index=t._index,this}ptr(){return this._map._keyValues[this._index]}notEqual(t){return this._index!=t._index||this._map!=t._map}_index;_map}var He;(s=>{s.csmMap=O,s.csmPair=Ge,s.iterator=mt})(He||(He={}));class re{static parseJsonObject(t,e){return Object.keys(t).forEach(i=>{typeof t[i]=="boolean"?e.put(i,new X(t[i])):typeof t[i]=="string"?e.put(i,new yt(t[i])):typeof t[i]=="number"?e.put(i,new $t(t[i])):t[i]instanceof Array?e.put(i,re.parseJsonArray(t[i])):t[i]instanceof Object?e.put(i,re.parseJsonObject(t[i],new xt)):t[i]==null?e.put(i,new St):e.put(i,t[i])}),e}static parseJsonArray(t){const e=new he;return Object.keys(t).forEach(i=>{const r=Number(i);if(typeof r=="number")typeof t[r]=="boolean"?e.add(new X(t[r])):typeof t[r]=="string"?e.add(new yt(t[r])):typeof t[r]=="number"?e.add(new $t(t[r])):t[i]instanceof Array?e.add(this.parseJsonArray(t[i])):t[i]instanceof Object?e.add(this.parseJsonObject(t[i],new xt)):t[i]==null?e.add(new St):e.add(t[i]);else if(t[i]instanceof Array)e.add(this.parseJsonArray(t[i]));else if(t[i]instanceof Object)e.add(this.parseJsonObject(t[i],new xt));else if(t[i]==null)e.add(new St);else for(let a=0;a<t[i].length;a++)e.add(t[i][a])}),e}}const Wt="Error: type mismatch",ks="Error: index out of bounds";let L=class ${constructor(){}getRawString(t,e){return this.getString(t,e)}toInt(t=0){return t}toFloat(t=0){return t}toBoolean(t=!1){return t}getSize(){return 0}getArray(t=null){return t}getVector(t=new x){return t}getMap(t){return t}getValueByIndex(t){return $.errorValue.setErrorNotForClientCall(Wt)}getValueByString(t){return $.nullValue.setErrorNotForClientCall(Wt)}getKeys(){return $.s_dummyKeys}isError(){return!1}isNull(){return!1}isBool(){return!1}isFloat(){return!1}isString(){return!1}isArray(){return!1}isMap(){return!1}equals(t){return!1}isStatic(){return!1}setErrorNotForClientCall(t){return Et.errorValue}static staticInitializeNotForClientCall(){X.trueValue=new X(!0),X.falseValue=new X(!1),$.errorValue=new Et("ERROR",!0),$.nullValue=new St,$.s_dummyKeys=new x}static staticReleaseNotForClientCall(){X.trueValue=null,X.falseValue=null,$.errorValue=null,$.nullValue=null,$.s_dummyKeys=null}_stringBuffer;static s_dummyKeys;static errorValue;static nullValue};class A{constructor(t,e){this._error=null,this._lineCount=0,this._root=null,t!=null&&this.parseBytes(t,e,this._parseCallback)}static create(t,e){const i=new A;return i.parseBytes(t,e,i._parseCallback)?i:(A.delete(i),null)}static delete(t){}getRoot(){return this._root}static arrayBufferToString(t){const e=new Uint8Array(t);let i="";for(let r=0,a=e.length;r<a;++r)i+="%"+this.pad(e[r].toString(16));return i=decodeURIComponent(i),i}static pad(t){return t.length<2?"0"+t:t}parseBytes(t,e,i){const r=new Array(1),a=A.arrayBufferToString(t);if(i==null?this._root=this.parseValue(a,e,0,r):this._root=i(JSON.parse(a),new xt),this._error){let o="\0";return o="Json parse error : @line "+(this._lineCount+1)+`
`,this._root=new yt(o),Q("{0}",this._root.getRawString()),!1}else if(this._root==null)return this._root=new Et(new U(this._error),!1),!1;return!0}getParseError(){return this._error}checkEndOfFile(){return this._root.getArray()[1].equals("EOF")}parseValue(t,e,i,r){if(this._error)return null;let a=null,o=i,n;for(;o<e;o++)switch(t[o]){case"-":case".":case"0":case"1":case"2":case"3":case"4":case"5":case"6":case"7":case"8":case"9":{const u=new Array(1);return n=Os(t.slice(o),u),r[0]=t.indexOf(u[0]),new $t(n)}case'"':return new yt(this.parseString(t,e,o+1,r));case"[":return a=this.parseArray(t,e,o+1,r),a;case"{":return a=this.parseObject(t,e,o+1,r),a;case"n":return o+3<e?(a=new St,r[0]=o+4):this._error="parse null",a;case"t":return o+3<e?(a=X.trueValue,r[0]=o+4):this._error="parse true",a;case"f":return o+4<e?(a=X.falseValue,r[0]=o+5):this._error="illegal ',' position",a;case",":return this._error="illegal ',' position",null;case"]":return r[0]=o,null;case`
`:this._lineCount++}return this._error="illegal end of value",null}parseString(t,e,i,r){if(this._error)return null;let a=i,o,n;const l=new U("");let u=i;for(;a<e;a++)switch(o=t[a],o){case'"':return r[0]=a+1,l.append(t.slice(u),a-u),l.s;case"//":if(a++,a-1>u&&l.append(t.slice(u),a-u),u=a+1,a<e)switch(n=t[a],n){case"\\":l.expansion(1,"\\");break;case'"':l.expansion(1,'"');break;case"/":l.expansion(1,"/");break;case"b":l.expansion(1,"\b");break;case"f":l.expansion(1,"\f");break;case"n":l.expansion(1,`
`);break;case"r":l.expansion(1,"\r");break;case"t":l.expansion(1,"	");break;case"u":this._error="parse string/unicord escape not supported";break}else this._error="parse string/escape error"}return this._error="parse string/illegal end",null}parseObject(t,e,i,r){if(this._error)return null;const a=new xt;let o="",n=i,l="";const u=Array(1);let h=!1;for(;n<e;n++){t:for(;n<e;n++)switch(l=t[n],l){case'"':if(o=this.parseString(t,e,n+1,u),this._error)return null;n=u[0],h=!0;break t;case"}":return r[0]=n+1,a;case":":this._error="illegal ':' position";break;case`
`:this._lineCount++}if(!h)return this._error="key not found",null;h=!1;t:for(;n<e;n++)switch(l=t[n],l){case":":h=!0,n++;break t;case"}":this._error="illegal '}' position";break;case`
`:this._lineCount++}if(!h)return this._error="':' not found",null;const m=this.parseValue(t,e,n,u);if(this._error)return null;n=u[0],a.put(o,m);t:for(;n<e;n++)switch(l=t[n],l){case",":break t;case"}":return r[0]=n+1,a;case`
`:this._lineCount++}}return this._error="illegal end of perseObject",null}parseArray(t,e,i,r){if(this._error)return null;let a=new he,o=i,n;const l=new Array(1);for(;o<e;o++){const u=this.parseValue(t,e,o,l);if(this._error)return null;o=l[0],u&&a.add(u);t:for(;o<e;o++)switch(n=t[o],n){case",":break t;case"]":return r[0]=o+1,a;case`
`:++this._lineCount}}return a=void 0,this._error="illegal end of parseObject",null}_parseCallback=re.parseJsonObject;_error;_lineCount;_root}class $t extends L{constructor(t){super(),this._value=t}isFloat(){return!0}getString(t,e){const i="\0";return this._value=parseFloat(i),this._stringBuffer=i,this._stringBuffer}toInt(t=0){return parseInt(this._value.toString())}toFloat(t=0){return this._value}equals(t){return typeof t=="number"?Math.round(t)?!1:t==this._value:!1}_value}class X extends L{isBool(){return!0}toBoolean(t=!1){return this._boolValue}getString(t,e){return this._stringBuffer=this._boolValue?"true":"false",this._stringBuffer}equals(t){return typeof t=="boolean"?t==this._boolValue:!1}isStatic(){return!0}constructor(t){super(),this._boolValue=t}static trueValue;static falseValue;_boolValue}class yt extends L{constructor(t){super(),typeof t=="string"&&(this._stringBuffer=t),t instanceof U&&(this._stringBuffer=t.s)}isString(){return!0}getString(t,e){return this._stringBuffer}equals(t){return typeof t=="string"?this._stringBuffer==t:t instanceof U?this._stringBuffer==t.s:!1}}class Et extends yt{isStatic(){return this._isStatic}setErrorNotForClientCall(t){return this._stringBuffer=t,this}constructor(t,e){typeof t=="string"?super(t):super(t),this._isStatic=e}isError(){return!0}_isStatic}class St extends L{isNull(){return!0}getString(t,e){return this._stringBuffer}isStatic(){return!0}setErrorNotForClientCall(t){return this._stringBuffer=t,Et.nullValue}constructor(){super(),this._stringBuffer="NullValue"}}class he extends L{constructor(){super(),this._array=new x}release(){for(let t=this._array.begin();t.notEqual(this._array.end());t.preIncrement()){let e=t.ptr();e&&!e.isStatic()&&(e=void 0,e=null)}}isArray(){return!0}getValueByIndex(t){if(t<0||this._array.getSize()<=t)return L.errorValue.setErrorNotForClientCall(ks);const e=this._array.at(t);return e??L.nullValue}getValueByString(t){return L.errorValue.setErrorNotForClientCall(Wt)}getString(t,e){const i=e+`[
`;for(let r=this._array.begin();r.notEqual(this._array.end());r.increment()){const a=r.ptr();this._stringBuffer+=e+""+a.getString(e+" ")+`
`}return this._stringBuffer=i+e+`]
`,this._stringBuffer}add(t){this._array.pushBack(t)}getVector(t=null){return this._array}getSize(){return this._array.getSize()}_array}class xt extends L{constructor(){super(),this._map=new O}release(){const t=this._map.begin();for(;t.notEqual(this._map.end());){let e=t.ptr().second;e&&!e.isStatic()&&(e=void 0,e=null),t.preIncrement()}}isMap(){return!0}getValueByString(t){if(t instanceof U){const e=this._map.getValue(t.s);return e??L.nullValue}for(let e=this._map.begin();e.notEqual(this._map.end());e.preIncrement())if(e.ptr().first==t)return e.ptr().second==null?L.nullValue:e.ptr().second;return L.nullValue}getValueByIndex(t){return L.errorValue.setErrorNotForClientCall(Wt)}getString(t,e){this._stringBuffer=e+`{
`;const i=this._map.begin();for(;i.notEqual(this._map.end());){const r=i.ptr().first,a=i.ptr().second;this._stringBuffer+=e+" "+r+" : "+a.getString(e+"   ")+` 
`,i.preIncrement()}return this._stringBuffer+=e+`}
`,this._stringBuffer}getMap(t){return this._map}put(t,e){this._map.setValue(t,e)}getKeys(){if(!this._keys){this._keys=new x;const t=this._map.begin();for(;t.notEqual(this._map.end());){const e=t.ptr().first;this._keys.pushBack(e),t.preIncrement()}}return this._keys}getSize(){return this._keys.getSize()}_map;_keys}var We;(s=>{s.CubismJson=A,s.JsonArray=he,s.JsonBoolean=X,s.JsonError=Et,s.JsonFloat=$t,s.JsonMap=xt,s.JsonNullvalue=St,s.JsonString=yt,s.Value=L})(We||(We={}));function Os(s,t){let e=0;for(let r=1;;r++){const a=s.slice(r-1,r);if(a=="e"||a=="-"||a=="E")continue;const o=s.substring(0,r),n=Number(o);if(isNaN(n))break;e=r}let i=parseFloat(s);return isNaN(i)&&(i=NaN),t[0]=s.slice(e),i}let Y=!1,Ct=!1,Bt=null,At=null;const rt=Object.freeze({vertexOffset:0,vertexStep:2});function Ns(s){s&&(s=void 0)}class V{static startUp(t=null){if(Y)return Q("CubismFramework.startUp() is already done."),Y;if(Bt=t,Bt!=null&&Live2DCubismCore.Logging.csmSetLogFunction(Bt.logFunction),Y=!0,Y){const e=Live2DCubismCore.Version.csmGetVersion(),i=(e&4278190080)>>24,r=(e&16711680)>>16,a=e&65535,o=e;Q("Live2D Cubism Core version: {0}.{1}.{2} ({3})",("00"+i).slice(-2),("00"+r).slice(-2),("0000"+a).slice(-4),o)}return Q("CubismFramework.startUp() is complete."),Y}static cleanUp(){Y=!1,Ct=!1,Bt=null,At=null}static initialize(t=0){if(H(Y),!Y){st("CubismFramework is not started.");return}if(Ct){st("CubismFramework.initialize() skipped, already initialized.");return}L.staticInitializeNotForClientCall(),At=new Ne,Live2DCubismCore.Memory.initializeAmountOfMemory(t),Ct=!0,Q("CubismFramework.initialize() is complete.")}static dispose(){if(H(Y),!Y){st("CubismFramework is not started.");return}if(!Ct){st("CubismFramework.dispose() skipped, not initialized.");return}L.staticReleaseNotForClientCall(),At.release(),At=null,Gt.staticRelease(),Ct=!1,Q("CubismFramework.dispose() is complete.")}static isStarted(){return Y}static isInitialized(){return Ct}static coreLogFunction(t){Live2DCubismCore.Logging.csmGetLogFunction()&&Live2DCubismCore.Logging.csmGetLogFunction()(t)}static getLoggingLevel(){return Bt!=null?Bt.loggingLevel:5}static getIdManager(){return At}constructor(){}}class Us{logFunction;loggingLevel}var Mt=(s=>(s[s.LogLevel_Verbose=0]="LogLevel_Verbose",s[s.LogLevel_Debug=1]="LogLevel_Debug",s[s.LogLevel_Info=2]="LogLevel_Info",s[s.LogLevel_Warning=3]="LogLevel_Warning",s[s.LogLevel_Error=4]="LogLevel_Error",s[s.LogLevel_Off=5]="LogLevel_Off",s))(Mt||{}),$e;(s=>{s.Constant=rt,s.csmDelete=Ns,s.CubismFramework=V})($e||($e={}));function qe(s,t){for(var e=0,i=s.length-1;i>=0;i--){var r=s[i];r==="."?s.splice(i,1):r===".."?(s.splice(i,1),e++):e&&(s.splice(i,1),e--)}if(t)for(;e--;e)s.unshift("..");return s}var zs=/^(\/?|)([\s\S]*?)((?:\.{1,2}|[^\/]+?|)(\.[^.\/]*|))(?:[\/]*)$/,ge=function(s){return zs.exec(s).slice(1)};function ce(){for(var s="",t=!1,e=arguments.length-1;e>=-1&&!t;e--){var i=e>=0?arguments[e]:"/";if(typeof i!="string")throw new TypeError("Arguments to path.resolve must be strings");if(!i)continue;s=i+"/"+s,t=i.charAt(0)==="/"}return s=qe(de(s.split("/"),function(r){return!!r}),!t).join("/"),(t?"/":"")+s||"."}function Je(s){var t=Ke(s),e=qs(s,-1)==="/";return s=qe(de(s.split("/"),function(i){return!!i}),!t).join("/"),!s&&!t&&(s="."),s&&e&&(s+="/"),(t?"/":"")+s}function Ke(s){return s.charAt(0)==="/"}function Xs(){var s=Array.prototype.slice.call(arguments,0);return Je(de(s,function(t,e){if(typeof t!="string")throw new TypeError("Arguments to path.join must be strings");return t}).join("/"))}function Ys(s,t){s=ce(s).substr(1),t=ce(t).substr(1);function e(u){for(var h=0;h<u.length&&u[h]==="";h++);for(var m=u.length-1;m>=0&&u[m]==="";m--);return h>m?[]:u.slice(h,m-h+1)}for(var i=e(s.split("/")),r=e(t.split("/")),a=Math.min(i.length,r.length),o=a,n=0;n<a;n++)if(i[n]!==r[n]){o=n;break}for(var l=[],n=o;n<i.length;n++)l.push("..");return l=l.concat(r.slice(o)),l.join("/")}var js="/",Gs=":";function Hs(s){var t=ge(s),e=t[0],i=t[1];return!e&&!i?".":(i&&(i=i.substr(0,i.length-1)),e+i)}function Ws(s,t){var e=ge(s)[2];return t&&e.substr(-1*t.length)===t&&(e=e.substr(0,e.length-t.length)),e}function $s(s){return ge(s)[3]}var W={extname:$s,basename:Ws,dirname:Hs,sep:js,delimiter:Gs,relative:Ys,join:Xs,isAbsolute:Ke,normalize:Je,resolve:ce};function de(s,t){if(s.filter)return s.filter(t);for(var e=[],i=0;i<s.length;i++)t(s[i],i,s)&&e.push(s[i]);return e}var qs="ab".substr(-1)==="b"?function(s,t,e){return s.substr(t,e)}:function(s,t,e){return t<0&&(t=s.length+t),s.substr(t,e)};const S=Object.freeze({HitAreaPrefix:"HitArea",HitAreaHead:"Head",HitAreaBody:"Body",PartsIdCore:"Parts01Core",PartsArmPrefix:"Parts01Arm_",PartsArmLPrefix:"Parts01ArmL_",PartsArmRPrefix:"Parts01ArmR_",ParamAngleX:"ParamAngleX",ParamAngleY:"ParamAngleY",ParamAngleZ:"ParamAngleZ",ParamEyeLOpen:"ParamEyeLOpen",ParamEyeLSmile:"ParamEyeLSmile",ParamEyeROpen:"ParamEyeROpen",ParamEyeRSmile:"ParamEyeRSmile",ParamEyeBallX:"ParamEyeBallX",ParamEyeBallY:"ParamEyeBallY",ParamEyeBallForm:"ParamEyeBallForm",ParamBrowLY:"ParamBrowLY",ParamBrowRY:"ParamBrowRY",ParamBrowLX:"ParamBrowLX",ParamBrowRX:"ParamBrowRX",ParamBrowLAngle:"ParamBrowLAngle",ParamBrowRAngle:"ParamBrowRAngle",ParamBrowLForm:"ParamBrowLForm",ParamBrowRForm:"ParamBrowRForm",ParamMouthForm:"ParamMouthForm",ParamMouthOpenY:"ParamMouthOpenY",ParamCheek:"ParamCheek",ParamBodyAngleX:"ParamBodyAngleX",ParamBodyAngleY:"ParamBodyAngleY",ParamBodyAngleZ:"ParamBodyAngleZ",ParamBreath:"ParamBreath",ParamArmLA:"ParamArmLA",ParamArmRA:"ParamArmRA",ParamArmLB:"ParamArmLB",ParamArmRB:"ParamArmRB",ParamHandL:"ParamHandL",ParamHandR:"ParamHandR",ParamHairFront:"ParamHairFront",ParamHairSide:"ParamHairSide",ParamHairBack:"ParamHairBack",ParamHairFluffy:"ParamHairFluffy",ParamShoulderY:"ParamShoulderY",ParamBustX:"ParamBustX",ParamBustY:"ParamBustY",ParamBaseX:"ParamBaseX",ParamBaseY:"ParamBaseY",ParamNONE:"NONE:"});var Ze;(s=>{s.HitAreaBody=S.HitAreaBody,s.HitAreaHead=S.HitAreaHead,s.HitAreaPrefix=S.HitAreaPrefix,s.ParamAngleX=S.ParamAngleX,s.ParamAngleY=S.ParamAngleY,s.ParamAngleZ=S.ParamAngleZ,s.ParamArmLA=S.ParamArmLA,s.ParamArmLB=S.ParamArmLB,s.ParamArmRA=S.ParamArmRA,s.ParamArmRB=S.ParamArmRB,s.ParamBaseX=S.ParamBaseX,s.ParamBaseY=S.ParamBaseY,s.ParamBodyAngleX=S.ParamBodyAngleX,s.ParamBodyAngleY=S.ParamBodyAngleY,s.ParamBodyAngleZ=S.ParamBodyAngleZ,s.ParamBreath=S.ParamBreath,s.ParamBrowLAngle=S.ParamBrowLAngle,s.ParamBrowLForm=S.ParamBrowLForm,s.ParamBrowLX=S.ParamBrowLX,s.ParamBrowLY=S.ParamBrowLY,s.ParamBrowRAngle=S.ParamBrowRAngle,s.ParamBrowRForm=S.ParamBrowRForm,s.ParamBrowRX=S.ParamBrowRX,s.ParamBrowRY=S.ParamBrowRY,s.ParamBustX=S.ParamBustX,s.ParamBustY=S.ParamBustY,s.ParamCheek=S.ParamCheek,s.ParamEyeBallForm=S.ParamEyeBallForm,s.ParamEyeBallX=S.ParamEyeBallX,s.ParamEyeBallY=S.ParamEyeBallY,s.ParamEyeLOpen=S.ParamEyeLOpen,s.ParamEyeLSmile=S.ParamEyeLSmile,s.ParamEyeROpen=S.ParamEyeROpen,s.ParamEyeRSmile=S.ParamEyeRSmile,s.ParamHairBack=S.ParamHairBack,s.ParamHairFluffy=S.ParamHairFluffy,s.ParamHairFront=S.ParamHairFront,s.ParamHairSide=S.ParamHairSide,s.ParamHandL=S.ParamHandL,s.ParamHandR=S.ParamHandR,s.ParamMouthForm=S.ParamMouthForm,s.ParamMouthOpenY=S.ParamMouthOpenY,s.ParamNONE=S.ParamNONE,s.ParamShoulderY=S.ParamShoulderY,s.PartsArmLPrefix=S.PartsArmLPrefix,s.PartsArmPrefix=S.PartsArmPrefix,s.PartsArmRPrefix=S.PartsArmRPrefix,s.PartsIdCore=S.PartsIdCore})(Ze||(Ze={}));class Qe{}var ti;(s=>{s.ICubismModelSetting=Qe})(ti||(ti={}));const at="FileReferences",Js="Groups",Ks="Layout",Zs="HitAreas",Qs="Moc",tr="Textures",er="Physics",ir="Pose",sr="Expressions",rr="Motions",ei="UserData",nt="Name",ii="File",ar="Id",qt="Ids",si="Sound",ri="FadeInTime",ai="FadeOutTime",_e="LipSync",me="EyeBlink";class ni extends Qe{constructor(t,e){super(),this._json=A.create(t,e),this._json&&(this._jsonValue=new x,this._jsonValue.pushBack(this._json.getRoot().getValueByString(Js)),this._jsonValue.pushBack(this._json.getRoot().getValueByString(at).getValueByString(Qs)),this._jsonValue.pushBack(this._json.getRoot().getValueByString(at).getValueByString(rr)),this._jsonValue.pushBack(this._json.getRoot().getValueByString(at).getValueByString(sr)),this._jsonValue.pushBack(this._json.getRoot().getValueByString(at).getValueByString(tr)),this._jsonValue.pushBack(this._json.getRoot().getValueByString(at).getValueByString(er)),this._jsonValue.pushBack(this._json.getRoot().getValueByString(at).getValueByString(ir)),this._jsonValue.pushBack(this._json.getRoot().getValueByString(Zs)))}release(){A.delete(this._json),this._jsonValue=null}GetJson(){return this._json}getModelFileName(){return this.isExistModelFile()?this._jsonValue.at(1).getRawString():""}getTextureCount(){return this.isExistTextureFiles()?this._jsonValue.at(4).getSize():0}getTextureDirectory(){const e=this._jsonValue.at(4).getValueByIndex(0).getRawString().split("/"),i=e.length-1;let r="";for(let a=0;a<i;a++)r+=e[a],a<i-1&&(r+="/");return r}getTextureFileName(t){return this._jsonValue.at(4).getValueByIndex(t).getRawString()}getHitAreasCount(){return this.isExistHitAreas()?this._jsonValue.at(7).getSize():0}getHitAreaId(t){return V.getIdManager().getId(this._jsonValue.at(7).getValueByIndex(t).getValueByString(ar).getRawString())}getHitAreaName(t){return this._jsonValue.at(7).getValueByIndex(t).getValueByString(nt).getRawString()}getPhysicsFileName(){return this.isExistPhysicsFile()?this._jsonValue.at(5).getRawString():""}getPoseFileName(){return this.isExistPoseFile()?this._jsonValue.at(6).getRawString():""}getExpressionCount(){return this.isExistExpressionFile()?this._jsonValue.at(3).getSize():0}getExpressionName(t){return this._jsonValue.at(3).getValueByIndex(t).getValueByString(nt).getRawString()}getExpressionFileName(t){return this._jsonValue.at(3).getValueByIndex(t).getValueByString(ii).getRawString()}getMotionGroupCount(){return this.isExistMotionGroups()?this._jsonValue.at(2).getKeys().getSize():0}getMotionGroupName(t){return this.isExistMotionGroups()?this._jsonValue.at(2).getKeys().at(t):null}getMotionCount(t){return this.isExistMotionGroupName(t)?this._jsonValue.at(2).getValueByString(t).getSize():0}getMotionFileName(t,e){return this.isExistMotionGroupName(t)?this._jsonValue.at(2).getValueByString(t).getValueByIndex(e).getValueByString(ii).getRawString():""}getMotionSoundFileName(t,e){return this.isExistMotionSoundFile(t,e)?this._jsonValue.at(2).getValueByString(t).getValueByIndex(e).getValueByString(si).getRawString():""}getMotionFadeInTimeValue(t,e){return this.isExistMotionFadeIn(t,e)?this._jsonValue.at(2).getValueByString(t).getValueByIndex(e).getValueByString(ri).toFloat():-1}getMotionFadeOutTimeValue(t,e){return this.isExistMotionFadeOut(t,e)?this._jsonValue.at(2).getValueByString(t).getValueByIndex(e).getValueByString(ai).toFloat():-1}getUserDataFile(){return this.isExistUserDataFile()?this._json.getRoot().getValueByString(at).getValueByString(ei).getRawString():""}getLayoutMap(t){const e=this._json.getRoot().getValueByString(Ks).getMap();if(e==null)return!1;let i=!1;for(const r=e.begin();r.notEqual(e.end());r.preIncrement())t.setValue(r.ptr().first,r.ptr().second.toFloat()),i=!0;return i}getEyeBlinkParameterCount(){if(!this.isExistEyeBlinkParameters())return 0;let t=0;for(let e=0;e<this._jsonValue.at(0).getSize();e++){const i=this._jsonValue.at(0).getValueByIndex(e);if(!(i.isNull()||i.isError())&&i.getValueByString(nt).getRawString()==me){t=i.getValueByString(qt).getVector().getSize();break}}return t}getEyeBlinkParameterId(t){if(!this.isExistEyeBlinkParameters())return null;for(let e=0;e<this._jsonValue.at(0).getSize();e++){const i=this._jsonValue.at(0).getValueByIndex(e);if(!(i.isNull()||i.isError())&&i.getValueByString(nt).getRawString()==me)return V.getIdManager().getId(i.getValueByString(qt).getValueByIndex(t).getRawString())}return null}getLipSyncParameterCount(){if(!this.isExistLipSyncParameters())return 0;let t=0;for(let e=0;e<this._jsonValue.at(0).getSize();e++){const i=this._jsonValue.at(0).getValueByIndex(e);if(!(i.isNull()||i.isError())&&i.getValueByString(nt).getRawString()==_e){t=i.getValueByString(qt).getVector().getSize();break}}return t}getLipSyncParameterId(t){if(!this.isExistLipSyncParameters())return null;for(let e=0;e<this._jsonValue.at(0).getSize();e++){const i=this._jsonValue.at(0).getValueByIndex(e);if(!(i.isNull()||i.isError())&&i.getValueByString(nt).getRawString()==_e)return V.getIdManager().getId(i.getValueByString(qt).getValueByIndex(t).getRawString())}return null}isExistModelFile(){const t=this._jsonValue.at(1);return!t.isNull()&&!t.isError()}isExistTextureFiles(){const t=this._jsonValue.at(4);return!t.isNull()&&!t.isError()}isExistHitAreas(){const t=this._jsonValue.at(7);return!t.isNull()&&!t.isError()}isExistPhysicsFile(){const t=this._jsonValue.at(5);return!t.isNull()&&!t.isError()}isExistPoseFile(){const t=this._jsonValue.at(6);return!t.isNull()&&!t.isError()}isExistExpressionFile(){const t=this._jsonValue.at(3);return!t.isNull()&&!t.isError()}isExistMotionGroups(){const t=this._jsonValue.at(2);return!t.isNull()&&!t.isError()}isExistMotionGroupName(t){const e=this._jsonValue.at(2).getValueByString(t);return!e.isNull()&&!e.isError()}isExistMotionSoundFile(t,e){const i=this._jsonValue.at(2).getValueByString(t).getValueByIndex(e).getValueByString(si);return!i.isNull()&&!i.isError()}isExistMotionFadeIn(t,e){const i=this._jsonValue.at(2).getValueByString(t).getValueByIndex(e).getValueByString(ri);return!i.isNull()&&!i.isError()}isExistMotionFadeOut(t,e){const i=this._jsonValue.at(2).getValueByString(t).getValueByIndex(e).getValueByString(ai);return!i.isNull()&&!i.isError()}isExistUserDataFile(){const t=this._json.getRoot().getValueByString(at).getValueByString(ei);return!t.isNull()&&!t.isError()}isExistEyeBlinkParameters(){if(this._jsonValue.at(0).isNull()||this._jsonValue.at(0).isError())return!1;for(let t=0;t<this._jsonValue.at(0).getSize();++t)if(this._jsonValue.at(0).getValueByIndex(t).getValueByString(nt).getRawString()==me)return!0;return!1}isExistLipSyncParameters(){if(this._jsonValue.at(0).isNull()||this._jsonValue.at(0).isError())return!1;for(let t=0;t<this._jsonValue.at(0).getSize();++t)if(this._jsonValue.at(0).getValueByIndex(t).getValueByString(nt).getRawString()==_e)return!0;return!1}_json;_jsonValue}var oi;(s=>{s.CubismModelSettingJson=ni})(oi||(oi={}));class kt{static create(){return new kt}static delete(t){}setParameters(t){this._breathParameters=t}getParameters(){return this._breathParameters}updateParameters(t,e){this._currentTime+=e;const i=this._currentTime*2*3.14159;for(let r=0;r<this._breathParameters.getSize();++r){const a=this._breathParameters.at(r);t.addParameterValueById(a.parameterId,a.offset+a.peak*Math.sin(i/a.cycle),a.weight)}}constructor(){this._currentTime=0}_breathParameters;_currentTime}class Pt{constructor(t,e,i,r,a){this.parameterId=t??null,this.offset=e??0,this.peak=i??0,this.cycle=r??0,this.weight=a??0}parameterId;offset;peak;cycle;weight}var li;(s=>{s.BreathParameterData=Pt,s.CubismBreath=kt})(li||(li={}));class Vt{static create(t=null){return new Vt(t)}static delete(t){}setBlinkingInterval(t){this._blinkingIntervalSeconds=t}setBlinkingSetting(t,e,i){this._closingSeconds=t,this._closedSeconds=e,this._openingSeconds=i}setParameterIds(t){this._parameterIds=t}getParameterIds(){return this._parameterIds}updateParameters(t,e){this._userTimeSeconds+=e;let i,r=0;switch(this._blinkingState){case 2:r=(this._userTimeSeconds-this._stateStartTimeSeconds)/this._closingSeconds,r>=1&&(r=1,this._blinkingState=3,this._stateStartTimeSeconds=this._userTimeSeconds),i=1-r;break;case 3:r=(this._userTimeSeconds-this._stateStartTimeSeconds)/this._closedSeconds,r>=1&&(this._blinkingState=4,this._stateStartTimeSeconds=this._userTimeSeconds),i=0;break;case 4:r=(this._userTimeSeconds-this._stateStartTimeSeconds)/this._openingSeconds,r>=1&&(r=1,this._blinkingState=1,this._nextBlinkingTime=this.determinNextBlinkingTiming()),i=r;break;case 1:this._nextBlinkingTime<this._userTimeSeconds&&(this._blinkingState=2,this._stateStartTimeSeconds=this._userTimeSeconds),i=1;break;case 0:default:this._blinkingState=1,this._nextBlinkingTime=this.determinNextBlinkingTiming(),i=1;break}Vt.CloseIfZero||(i=-i);for(let a=0;a<this._parameterIds.getSize();++a)t.setParameterValueById(this._parameterIds.at(a),i)}constructor(t){if(this._blinkingState=0,this._nextBlinkingTime=0,this._stateStartTimeSeconds=0,this._blinkingIntervalSeconds=4,this._closingSeconds=.1,this._closedSeconds=.05,this._openingSeconds=.15,this._userTimeSeconds=0,this._parameterIds=new x,t!=null)for(let e=0;e<t.getEyeBlinkParameterCount();++e)this._parameterIds.pushBack(t.getEyeBlinkParameterId(e))}determinNextBlinkingTiming(){const t=Math.random();return this._userTimeSeconds+t*(2*this._blinkingIntervalSeconds-1)}_blinkingState;_parameterIds;_nextBlinkingTime;_stateStartTimeSeconds;_blinkingIntervalSeconds;_closingSeconds;_closedSeconds;_openingSeconds;_userTimeSeconds;static CloseIfZero=!0}var ui=(s=>(s[s.EyeState_First=0]="EyeState_First",s[s.EyeState_Interval=1]="EyeState_Interval",s[s.EyeState_Closing=2]="EyeState_Closing",s[s.EyeState_Closed=3]="EyeState_Closed",s[s.EyeState_Opening=4]="EyeState_Opening",s))(ui||{}),hi;(s=>{s.CubismEyeBlink=Vt,s.EyeState=ui})(hi||(hi={}));const nr=.001,pe=.5,gi="FadeInTime",ci="Link",or="Groups",lr="Id";class Ot{static create(t,e){const i=new Ot,r=A.create(t,e),a=r.getRoot();a.getValueByString(gi).isNull()||(i._fadeTimeSeconds=a.getValueByString(gi).toFloat(pe),i._fadeTimeSeconds<=0&&(i._fadeTimeSeconds=pe));const o=a.getValueByString(or),n=o.getSize();for(let l=0;l<n;++l){const u=o.getValueByIndex(l),h=u.getSize();let m=0;for(let d=0;d<h;++d){const g=u.getValueByIndex(d),c=new Nt,p=V.getIdManager().getId(g.getValueByString(lr).getRawString());if(c.partId=p,!g.getValueByString(ci).isNull()){const _=g.getValueByString(ci),B=_.getSize();for(let P=0;P<B;++P){const y=new Nt,f=V.getIdManager().getId(_.getValueByIndex(P).getString());y.partId=f,c.link.pushBack(y)}}i._partGroups.pushBack(c.clone()),++m}i._partGroupCounts.pushBack(m)}return A.delete(r),i}static delete(t){}updateParameters(t,e){t!=this._lastModel&&this.reset(t),this._lastModel=t,e<0&&(e=0);let i=0;for(let r=0;r<this._partGroupCounts.getSize();r++){const a=this._partGroupCounts.at(r);this.doFade(t,e,i,a),i+=a}this.copyPartOpacities(t)}reset(t){let e=0;for(let i=0;i<this._partGroupCounts.getSize();++i){const r=this._partGroupCounts.at(i);for(let a=e;a<e+r;++a){this._partGroups.at(a).initialize(t);const o=this._partGroups.at(a).partIndex,n=this._partGroups.at(a).parameterIndex;if(!(o<0)){t.setPartOpacityByIndex(o,a==e?1:0),t.setParameterValueByIndex(n,a==e?1:0);for(let l=0;l<this._partGroups.at(a).link.getSize();++l)this._partGroups.at(a).link.at(l).initialize(t)}}e+=r}}copyPartOpacities(t){for(let e=0;e<this._partGroups.getSize();++e){const i=this._partGroups.at(e);if(i.link.getSize()==0)continue;const r=this._partGroups.at(e).partIndex,a=t.getPartOpacityByIndex(r);for(let o=0;o<i.link.getSize();++o){const l=i.link.at(o).partIndex;l<0||t.setPartOpacityByIndex(l,a)}}}doFade(t,e,i,r){let a=-1,o=1;const n=.5,l=.15;for(let u=i;u<i+r;++u){const h=this._partGroups.at(u).partIndex,m=this._partGroups.at(u).parameterIndex;if(t.getParameterValueByIndex(m)>nr){if(a>=0)break;a=u,o=t.getPartOpacityByIndex(h),o+=e/this._fadeTimeSeconds,o>1&&(o=1)}}a<0&&(a=0,o=1);for(let u=i;u<i+r;++u){const h=this._partGroups.at(u).partIndex;if(a==u)t.setPartOpacityByIndex(h,o);else{let m=t.getPartOpacityByIndex(h),d;o<n?d=o*(n-1)/n+1:d=(1-o)*n/(1-n),(1-d)*(1-o)>l&&(d=1-l/(1-o)),m>d&&(m=d),t.setPartOpacityByIndex(h,m)}}}constructor(){this._fadeTimeSeconds=pe,this._lastModel=null,this._partGroups=new x,this._partGroupCounts=new x}_partGroups;_partGroupCounts;_fadeTimeSeconds;_lastModel}class Nt{constructor(t){if(this.parameterIndex=0,this.partIndex=0,this.link=new x,t!=null){this.partId=t.partId;for(const e=t.link.begin();e.notEqual(t.link.end());e.preIncrement())this.link.pushBack(e.ptr().clone())}}assignment(t){this.partId=t.partId;for(const e=t.link.begin();e.notEqual(t.link.end());e.preIncrement())this.link.pushBack(e.ptr().clone());return this}initialize(t){this.parameterIndex=t.getParameterIndex(this.partId),this.partIndex=t.getPartIndex(this.partId),t.setParameterValueByIndex(this.parameterIndex,1)}clone(){const t=new Nt;t.partId=this.partId,t.parameterIndex=this.parameterIndex,t.partIndex=this.partIndex,t.link=new x;for(let e=this.link.begin();e.notEqual(this.link.end());e.increment())t.link.pushBack(e.ptr().clone());return t}partId;parameterIndex;partIndex;link}var di;(s=>{s.CubismPose=Ot,s.PartData=Nt})(di||(di={}));class _i extends E{constructor(t,e){super(),this._width=t!==void 0?t:0,this._height=e!==void 0?e:0,this.setHeight(2)}setWidth(t){const e=t/this._width,i=e;this.scale(e,i)}setHeight(t){const e=t/this._height,i=e;this.scale(e,i)}setPosition(t,e){this.translate(t,e)}setCenterPosition(t,e){this.centerX(t),this.centerY(e)}top(t){this.setY(t)}bottom(t){const e=this._height*this.getScaleY();this.translateY(t-e)}left(t){this.setX(t)}right(t){const e=this._width*this.getScaleX();this.translateX(t-e)}centerX(t){const e=this._width*this.getScaleX();this.translateX(t-e/2)}setX(t){this.translateX(t)}centerY(t){const e=this._height*this.getScaleY();this.translateY(t-e/2)}setY(t){this.translateY(t)}setupFromLayout(t){const e="width",i="height",r="x",a="y",o="center_x",n="center_y",l="top",u="bottom",h="left",m="right";for(const d=t.begin();d.notEqual(t.end());d.preIncrement()){const g=d.ptr().first,c=d.ptr().second;g==e?this.setWidth(c):g==i&&this.setHeight(c)}for(const d=t.begin();d.notEqual(t.end());d.preIncrement()){const g=d.ptr().first,c=d.ptr().second;g==r?this.setX(c):g==a?this.setY(c):g==o?this.centerX(c):g==n?this.centerY(c):g==l?this.top(c):g==u?this.bottom(c):g==h?this.left(c):g==m&&this.right(c)}}_width;_height}var mi;(s=>{s.CubismModelMatrix=_i})(mi||(mi={}));class C{constructor(t,e){this.x=t,this.y=e,this.x=t??0,this.y=e??0}add(t){const e=new C(0,0);return e.x=this.x+t.x,e.y=this.y+t.y,e}substract(t){const e=new C(0,0);return e.x=this.x-t.x,e.y=this.y-t.y,e}multiply(t){const e=new C(0,0);return e.x=this.x*t.x,e.y=this.y*t.y,e}multiplyByScaler(t){return this.multiply(new C(t,t))}division(t){const e=new C(0,0);return e.x=this.x/t.x,e.y=this.y/t.y,e}divisionByScalar(t){return this.division(new C(t,t))}getLength(){return Math.sqrt(this.x*this.x+this.y*this.y)}getDistanceWith(t){return Math.sqrt((this.x-t.x)*(this.x-t.x)+(this.y-t.y)*(this.y-t.y))}dot(t){return this.x*t.x+this.y*t.y}normalize(){const t=Math.pow(this.x*this.x+this.y*this.y,.5);this.x=this.x/t,this.y=this.y/t}isEqual(t){return this.x==t.x&&this.y==t.y}isNotEqual(t){return!this.isEqual(t)}}var pi;(s=>{s.CubismVector2=C})(pi||(pi={}));class v{static Epsilon=1e-5;static range(t,e,i){return t<e?t=e:t>i&&(t=i),t}static sin(t){return Math.sin(t)}static cos(t){return Math.cos(t)}static abs(t){return Math.abs(t)}static sqrt(t){return Math.sqrt(t)}static cbrt(t){if(t===0)return t;let e=t;const i=e<0;i&&(e=-e);let r;return e===1/0?r=1/0:(r=Math.exp(Math.log(e)/3),r=(e/(r*r)+2*r)/3),i?-r:r}static getEasingSine(t){return t<0?0:t>1?1:.5-.5*this.cos(t*Math.PI)}static max(t,e){return t>e?t:e}static min(t,e){return t>e?e:t}static degreesToRadian(t){return t/180*Math.PI}static radianToDegrees(t){return t*180/Math.PI}static directionToRadian(t,e){const i=Math.atan2(e.y,e.x),r=Math.atan2(t.y,t.x);let a=i-r;for(;a<-Math.PI;)a+=Math.PI*2;for(;a>Math.PI;)a-=Math.PI*2;return a}static directionToDegrees(t,e){const i=this.directionToRadian(t,e);let r=this.radianToDegrees(i);return e.x-t.x>0&&(r=-r),r}static radianToDirection(t){const e=new C;return e.x=this.sin(t),e.y=this.cos(t),e}static quadraticEquation(t,e,i){return this.abs(t)<v.Epsilon?this.abs(e)<v.Epsilon?-i:-i/e:-(e+this.sqrt(e*e-4*t*i))/(2*t)}static cardanoAlgorithmForBezier(t,e,i,r){if(this.sqrt(t)<v.Epsilon)return this.range(this.quadraticEquation(e,i,r),0,1);const a=e/t,o=i/t,n=r/t,l=(3*o-a*a)/3,u=l/3,h=(2*a*a*a-9*a*o+27*n)/27,m=h/2,d=m*m+u*u*u,g=.5,c=g+.01;if(d<0){const y=-l/3,f=y*y*y,T=this.sqrt(f),b=-h/(2*T),D=this.range(b,-1,1),it=Math.acos(D),pt=2*this.cbrt(T),Fe=pt*this.cos(it/3)-a/3;if(this.abs(Fe-g)<c)return this.range(Fe,0,1);const Le=pt*this.cos((it+2*Math.PI)/3)-a/3;if(this.abs(Le-g)<c)return this.range(Le,0,1);const Fs=pt*this.cos((it+4*Math.PI)/3)-a/3;return this.range(Fs,0,1)}if(d==0){let y;m<0?y=this.cbrt(-m):y=-this.cbrt(m);const f=2*y-a/3;if(this.abs(f-g)<c)return this.range(f,0,1);const T=-y-a/3;return this.range(T,0,1)}const p=this.sqrt(d),_=this.cbrt(p-m),B=this.cbrt(p+m),P=_-B-a/3;return this.range(P,0,1)}constructor(){}}var fi;(s=>{s.CubismMath=v})(fi||(fi={}));const fe=30,yi=.01;class Si{constructor(){this._faceTargetX=0,this._faceTargetY=0,this._faceX=0,this._faceY=0,this._faceVX=0,this._faceVY=0,this._lastTimeSeconds=0,this._userTimeSeconds=0}update(t){this._userTimeSeconds+=t;const i=40/10*1/fe;if(this._lastTimeSeconds==0){this._lastTimeSeconds=this._userTimeSeconds;return}const r=(this._userTimeSeconds-this._lastTimeSeconds)*fe;this._lastTimeSeconds=this._userTimeSeconds;const o=.15*fe,n=r*i/o,l=this._faceTargetX-this._faceX,u=this._faceTargetY-this._faceY;if(v.abs(l)<=yi&&v.abs(u)<=yi)return;const h=v.sqrt(l*l+u*u),m=i*l/h,d=i*u/h;let g=m-this._faceVX,c=d-this._faceVY;const p=v.sqrt(g*g+c*c);(p<-n||p>n)&&(g*=n/p,c*=n/p),this._faceVX+=g,this._faceVY+=c;{const _=.5*(v.sqrt(n*n+16*n*h-8*n*h)-n),B=v.sqrt(this._faceVX*this._faceVX+this._faceVY*this._faceVY);B>_&&(this._faceVX*=_/B,this._faceVY*=_/B)}this._faceX+=this._faceVX,this._faceY+=this._faceVY}getX(){return this._faceX}getY(){return this._faceY}set(t,e){this._faceTargetX=t,this._faceTargetY=e}_faceTargetX;_faceTargetY;_faceX;_faceY;_faceVX;_faceVY;_lastTimeSeconds;_userTimeSeconds}var xi;(s=>{s.CubismTargetPoint=Si})(xi||(xi={}));class vt{static delete(t){t.release(),t=null}constructor(){this._fadeInSeconds=-1,this._fadeOutSeconds=-1,this._weight=1,this._offsetSeconds=0,this._firedEventValues=new x}release(){this._weight=0}updateParameters(t,e,i){if(!e.isAvailable()||e.isFinished())return;if(!e.isStarted()){e.setIsStarted(!0),e.setStartTime(i-this._offsetSeconds),e.setFadeInStartTime(i);const n=this.getDuration();e.getEndTime()<0&&e.setEndTime(n<=0?-1:e.getStartTime()+n)}let r=this._weight;const a=this._fadeInSeconds==0?1:v.getEasingSine((i-e.getFadeInStartTime())/this._fadeInSeconds),o=this._fadeOutSeconds==0||e.getEndTime()<0?1:v.getEasingSine((e.getEndTime()-i)/this._fadeOutSeconds);r=r*a*o,e.setState(i,r),H(0<=r&&r<=1),this.doUpdateParameters(t,i,r,e),e.getEndTime()>0&&e.getEndTime()<i&&e.setIsFinished(!0)}setFadeInTime(t){this._fadeInSeconds=t}setFadeOutTime(t){this._fadeOutSeconds=t}getFadeOutTime(){return this._fadeOutSeconds}getFadeInTime(){return this._fadeInSeconds}setWeight(t){this._weight=t}getWeight(){return this._weight}getDuration(){return-1}getLoopDuration(){return-1}setOffsetTime(t){this._offsetSeconds=t}getFiredEvent(t,e){return this._firedEventValues}setFinishedMotionHandler=t=>this._onFinishedMotion=t;getFinishedMotionHandler=()=>this._onFinishedMotion;_fadeInSeconds;_fadeOutSeconds;_weight;_offsetSeconds;_firedEventValues;_onFinishedMotion}var Ci;(s=>{s.ACubismMotion=vt})(Ci||(Ci={}));const ur="FadeInTime",hr="FadeOutTime",Bi="Parameters",gr="Id",cr="Value",Jt="Blend",dr="Add",_r="Multiply",mr="Overwrite",Mi=1;class ae extends vt{static create(t,e){const i=new ae,r=A.create(t,e),a=r.getRoot();i.setFadeInTime(a.getValueByString(ur).toFloat(Mi)),i.setFadeOutTime(a.getValueByString(hr).toFloat(Mi));const o=a.getValueByString(Bi).getSize();i._parameters.prepareCapacity(o);for(let n=0;n<o;++n){const l=a.getValueByString(Bi).getValueByIndex(n),u=V.getIdManager().getId(l.getValueByString(gr).getRawString()),h=l.getValueByString(cr).toFloat();let m;l.getValueByString(Jt).isNull()||l.getValueByString(Jt).getString()==dr?m=0:l.getValueByString(Jt).getString()==_r?m=1:l.getValueByString(Jt).getString()==mr?m=2:m=0;const d=new vi;d.parameterId=u,d.blendType=m,d.value=h,i._parameters.pushBack(d)}return A.delete(r),i}doUpdateParameters(t,e,i,r){for(let a=0;a<this._parameters.getSize();++a){const o=this._parameters.at(a);switch(o.blendType){case 0:{t.addParameterValueById(o.parameterId,o.value,i);break}case 1:{t.multiplyParameterValueById(o.parameterId,o.value,i);break}case 2:{t.setParameterValueById(o.parameterId,o.value,i);break}}}}constructor(){super(),this._parameters=new x}_parameters}var Pi=(s=>(s[s.ExpressionBlendType_Add=0]="ExpressionBlendType_Add",s[s.ExpressionBlendType_Multiply=1]="ExpressionBlendType_Multiply",s[s.ExpressionBlendType_Overwrite=2]="ExpressionBlendType_Overwrite",s))(Pi||{});class vi{parameterId;blendType;value}var bi;(s=>{s.CubismExpressionMotion=ae,s.ExpressionBlendType=Pi,s.ExpressionParameter=vi})(bi||(bi={}));var ot=(s=>(s[s.CubismMotionCurveTarget_Model=0]="CubismMotionCurveTarget_Model",s[s.CubismMotionCurveTarget_Parameter=1]="CubismMotionCurveTarget_Parameter",s[s.CubismMotionCurveTarget_PartOpacity=2]="CubismMotionCurveTarget_PartOpacity",s))(ot||{}),j=(s=>(s[s.CubismMotionSegmentType_Linear=0]="CubismMotionSegmentType_Linear",s[s.CubismMotionSegmentType_Bezier=1]="CubismMotionSegmentType_Bezier",s[s.CubismMotionSegmentType_Stepped=2]="CubismMotionSegmentType_Stepped",s[s.CubismMotionSegmentType_InverseStepped=3]="CubismMotionSegmentType_InverseStepped",s))(j||{});class ye{time=0;value=0}class Ii{constructor(){this.evaluate=null,this.basePointIndex=0,this.segmentType=0}evaluate;basePointIndex;segmentType}class Ti{constructor(){this.type=0,this.segmentCount=0,this.baseSegmentIndex=0,this.fadeInTime=0,this.fadeOutTime=0}type;id;segmentCount;baseSegmentIndex;fadeInTime;fadeOutTime}class Vi{fireTime=0;value}class wi{constructor(){this.duration=0,this.loop=!1,this.curveCount=0,this.eventCount=0,this.fps=0,this.curves=new x,this.segments=new x,this.points=new x,this.events=new x}duration;loop;curveCount;eventCount;fps;curves;segments;points;events}var Ri;(s=>{s.CubismMotionCurve=Ti,s.CubismMotionCurveTarget=ot,s.CubismMotionData=wi,s.CubismMotionEvent=Vi,s.CubismMotionPoint=ye,s.CubismMotionSegment=Ii,s.CubismMotionSegmentType=j})(Ri||(Ri={}));const N="Meta",pr="Duration",fr="Loop",yr="AreBeziersRestricted",Sr="CurveCount",xr="Fps",Cr="TotalSegmentCount",Br="TotalPointCount",lt="Curves",Mr="Target",Pr="Id",Kt="FadeInTime",Zt="FadeOutTime",Ei="Segments",Ai="UserData",vr="UserDataCount",br="TotalUserDataSize",Ir="Time",Tr="Value";class Fi{constructor(t,e){this._json=A.create(t,e)}release(){A.delete(this._json)}getMotionDuration(){return this._json.getRoot().getValueByString(N).getValueByString(pr).toFloat()}isMotionLoop(){return this._json.getRoot().getValueByString(N).getValueByString(fr).toBoolean()}getEvaluationOptionFlag(t){return t==0?this._json.getRoot().getValueByString(N).getValueByString(yr).toBoolean():!1}getMotionCurveCount(){return this._json.getRoot().getValueByString(N).getValueByString(Sr).toInt()}getMotionFps(){return this._json.getRoot().getValueByString(N).getValueByString(xr).toFloat()}getMotionTotalSegmentCount(){return this._json.getRoot().getValueByString(N).getValueByString(Cr).toInt()}getMotionTotalPointCount(){return this._json.getRoot().getValueByString(N).getValueByString(Br).toInt()}isExistMotionFadeInTime(){return!this._json.getRoot().getValueByString(N).getValueByString(Kt).isNull()}isExistMotionFadeOutTime(){return!this._json.getRoot().getValueByString(N).getValueByString(Zt).isNull()}getMotionFadeInTime(){return this._json.getRoot().getValueByString(N).getValueByString(Kt).toFloat()}getMotionFadeOutTime(){return this._json.getRoot().getValueByString(N).getValueByString(Zt).toFloat()}getMotionCurveTarget(t){return this._json.getRoot().getValueByString(lt).getValueByIndex(t).getValueByString(Mr).getRawString()}getMotionCurveId(t){return V.getIdManager().getId(this._json.getRoot().getValueByString(lt).getValueByIndex(t).getValueByString(Pr).getRawString())}isExistMotionCurveFadeInTime(t){return!this._json.getRoot().getValueByString(lt).getValueByIndex(t).getValueByString(Kt).isNull()}isExistMotionCurveFadeOutTime(t){return!this._json.getRoot().getValueByString(lt).getValueByIndex(t).getValueByString(Zt).isNull()}getMotionCurveFadeInTime(t){return this._json.getRoot().getValueByString(lt).getValueByIndex(t).getValueByString(Kt).toFloat()}getMotionCurveFadeOutTime(t){return this._json.getRoot().getValueByString(lt).getValueByIndex(t).getValueByString(Zt).toFloat()}getMotionCurveSegmentCount(t){return this._json.getRoot().getValueByString(lt).getValueByIndex(t).getValueByString(Ei).getVector().getSize()}getMotionCurveSegment(t,e){return this._json.getRoot().getValueByString(lt).getValueByIndex(t).getValueByString(Ei).getValueByIndex(e).toFloat()}getEventCount(){return this._json.getRoot().getValueByString(N).getValueByString(vr).toInt()}getTotalEventValueSize(){return this._json.getRoot().getValueByString(N).getValueByString(br).toInt()}getEventTime(t){return this._json.getRoot().getValueByString(Ai).getValueByIndex(t).getValueByString(Ir).toFloat()}getEventValue(t){return new U(this._json.getRoot().getValueByString(Ai).getValueByIndex(t).getValueByString(Tr).getRawString())}_json}var Li=(s=>(s[s.EvaluationOptionFlag_AreBeziersRistricted=0]="EvaluationOptionFlag_AreBeziersRistricted",s))(Li||{}),Di;(s=>{s.CubismMotionJson=Fi})(Di||(Di={}));const Vr="EyeBlink",wr="LipSync",Rr="Model",Er="Parameter",Ar="PartOpacity",Fr=!1;function z(s,t,e){const i=new ye;return i.time=s.time+(t.time-s.time)*e,i.value=s.value+(t.value-s.value)*e,i}function Lr(s,t){let e=(t-s[0].time)/(s[1].time-s[0].time);return e<0&&(e=0),s[0].value+(s[1].value-s[0].value)*e}function Dr(s,t){let e=(t-s[0].time)/(s[3].time-s[0].time);e<0&&(e=0);const i=z(s[0],s[1],e),r=z(s[1],s[2],e),a=z(s[2],s[3],e),o=z(i,r,e),n=z(r,a,e);return z(o,n,e).value}function kr(s,t){const e=t,i=s[0].time,r=s[3].time,a=s[1].time,o=s[2].time,n=r-3*o+3*a-i,l=3*o-6*a+3*i,u=3*a-3*i,h=i-e,m=v.cardanoAlgorithmForBezier(n,l,u,h),d=z(s[0],s[1],m),g=z(s[1],s[2],m),c=z(s[2],s[3],m),p=z(d,g,m),_=z(g,c,m);return z(p,_,m).value}function Or(s,t){return s[0].value}function Nr(s,t){return s[1].value}function Se(s,t,e){const i=s.curves.at(t);let r=-1;const a=i.baseSegmentIndex+i.segmentCount;let o=0;for(let l=i.baseSegmentIndex;l<a;++l)if(o=s.segments.at(l).basePointIndex+(s.segments.at(l).segmentType==j.CubismMotionSegmentType_Bezier?3:1),s.points.at(o).time>e){r=l;break}if(r==-1)return s.points.at(o).value;const n=s.segments.at(r);return n.evaluate(s.points.get(n.basePointIndex),e)}class ne extends vt{static create(t,e,i){const r=new ne;return r.parse(t,e),r._sourceFrameRate=r._motionData.fps,r._loopDurationSeconds=r._motionData.duration,r._onFinishedMotion=i,r}doUpdateParameters(t,e,i,r){this._modelCurveIdEyeBlink==null&&(this._modelCurveIdEyeBlink=V.getIdManager().getId(Vr)),this._modelCurveIdLipSync==null&&(this._modelCurveIdLipSync=V.getIdManager().getId(wr));let a=e-r.getStartTime();a<0&&(a=0);let o=Number.MAX_VALUE,n=Number.MAX_VALUE;const l=64;let u=0,h=0;this._eyeBlinkParameterIds.getSize()>l&&Rt("too many eye blink targets : {0}",this._eyeBlinkParameterIds.getSize()),this._lipSyncParameterIds.getSize()>l&&Rt("too many lip sync targets : {0}",this._lipSyncParameterIds.getSize());const m=this._fadeInSeconds<=0?1:v.getEasingSine((e-r.getFadeInStartTime())/this._fadeInSeconds),d=this._fadeOutSeconds<=0||r.getEndTime()<0?1:v.getEasingSine((r.getEndTime()-e)/this._fadeOutSeconds);let g,c,p,_=a;if(this._isLoop)for(;_>this._motionData.duration;)_-=this._motionData.duration;const B=this._motionData.curves;for(c=0;c<this._motionData.curveCount&&B.at(c).type==ot.CubismMotionCurveTarget_Model;++c)g=Se(this._motionData,c,_),B.at(c).id==this._modelCurveIdEyeBlink?n=g:B.at(c).id==this._modelCurveIdLipSync&&(o=g);for(;c<this._motionData.curveCount&&B.at(c).type==ot.CubismMotionCurveTarget_Parameter;++c){if(p=t.getParameterIndex(B.at(c).id),p==-1)continue;const P=t.getParameterValueByIndex(p);if(g=Se(this._motionData,c,_),n!=Number.MAX_VALUE){for(let f=0;f<this._eyeBlinkParameterIds.getSize()&&f<l;++f)if(this._eyeBlinkParameterIds.at(f)==B.at(c).id){g*=n,h|=1<<f;break}}if(o!=Number.MAX_VALUE){for(let f=0;f<this._lipSyncParameterIds.getSize()&&f<l;++f)if(this._lipSyncParameterIds.at(f)==B.at(c).id){g+=o,u|=1<<f;break}}let y;if(B.at(c).fadeInTime<0&&B.at(c).fadeOutTime<0)y=P+(g-P)*i;else{let f,T;B.at(c).fadeInTime<0?f=m:f=B.at(c).fadeInTime==0?1:v.getEasingSine((e-r.getFadeInStartTime())/B.at(c).fadeInTime),B.at(c).fadeOutTime<0?T=d:T=B.at(c).fadeOutTime==0||r.getEndTime()<0?1:v.getEasingSine((r.getEndTime()-e)/B.at(c).fadeOutTime);const b=this._weight*f*T;y=P+(g-P)*b}t.setParameterValueByIndex(p,y,1)}{if(n!=Number.MAX_VALUE)for(let P=0;P<this._eyeBlinkParameterIds.getSize()&&P<l;++P){const y=t.getParameterValueById(this._eyeBlinkParameterIds.at(P));if(h>>P&1)continue;const f=y+(n-y)*i;t.setParameterValueById(this._eyeBlinkParameterIds.at(P),f)}if(o!=Number.MAX_VALUE)for(let P=0;P<this._lipSyncParameterIds.getSize()&&P<l;++P){const y=t.getParameterValueById(this._lipSyncParameterIds.at(P));if(u>>P&1)continue;const f=y+(o-y)*i;t.setParameterValueById(this._lipSyncParameterIds.at(P),f)}}for(;c<this._motionData.curveCount&&B.at(c).type==ot.CubismMotionCurveTarget_PartOpacity;++c)p=t.getParameterIndex(B.at(c).id),p!=-1&&(g=Se(this._motionData,c,_),t.setParameterValueByIndex(p,g));a>=this._motionData.duration&&(this._isLoop?(r.setStartTime(e),this._isLoopFadeIn&&r.setFadeInStartTime(e)):(this._onFinishedMotion&&this._onFinishedMotion(this),r.setIsFinished(!0))),this._lastWeight=i}setIsLoop(t){this._isLoop=t}isLoop(){return this._isLoop}setIsLoopFadeIn(t){this._isLoopFadeIn=t}isLoopFadeIn(){return this._isLoopFadeIn}getDuration(){return this._isLoop?-1:this._loopDurationSeconds}getLoopDuration(){return this._loopDurationSeconds}setParameterFadeInTime(t,e){const i=this._motionData.curves;for(let r=0;r<this._motionData.curveCount;++r)if(t==i.at(r).id){i.at(r).fadeInTime=e;return}}setParameterFadeOutTime(t,e){const i=this._motionData.curves;for(let r=0;r<this._motionData.curveCount;++r)if(t==i.at(r).id){i.at(r).fadeOutTime=e;return}}getParameterFadeInTime(t){const e=this._motionData.curves;for(let i=0;i<this._motionData.curveCount;++i)if(t==e.at(i).id)return e.at(i).fadeInTime;return-1}getParameterFadeOutTime(t){const e=this._motionData.curves;for(let i=0;i<this._motionData.curveCount;++i)if(t==e.at(i).id)return e.at(i).fadeOutTime;return-1}setEffectIds(t,e){this._eyeBlinkParameterIds=t,this._lipSyncParameterIds=e}constructor(){super(),this._sourceFrameRate=30,this._loopDurationSeconds=-1,this._isLoop=!1,this._isLoopFadeIn=!0,this._lastWeight=0,this._motionData=null,this._modelCurveIdEyeBlink=null,this._modelCurveIdLipSync=null,this._eyeBlinkParameterIds=null,this._lipSyncParameterIds=null}release(){this._motionData=void 0,this._motionData=null}parse(t,e){this._motionData=new wi;let i=new Fi(t,e);this._motionData.duration=i.getMotionDuration(),this._motionData.loop=i.isMotionLoop(),this._motionData.curveCount=i.getMotionCurveCount(),this._motionData.fps=i.getMotionFps(),this._motionData.eventCount=i.getEventCount();const r=i.getEvaluationOptionFlag(Li.EvaluationOptionFlag_AreBeziersRistricted);i.isExistMotionFadeInTime()?this._fadeInSeconds=i.getMotionFadeInTime()<0?1:i.getMotionFadeInTime():this._fadeInSeconds=1,i.isExistMotionFadeOutTime()?this._fadeOutSeconds=i.getMotionFadeOutTime()<0?1:i.getMotionFadeOutTime():this._fadeOutSeconds=1,this._motionData.curves.updateSize(this._motionData.curveCount,Ti,!0),this._motionData.segments.updateSize(i.getMotionTotalSegmentCount(),Ii,!0),this._motionData.points.updateSize(i.getMotionTotalPointCount(),ye,!0),this._motionData.events.updateSize(this._motionData.eventCount,Vi,!0);let a=0,o=0;for(let n=0;n<this._motionData.curveCount;++n){i.getMotionCurveTarget(n)==Rr?this._motionData.curves.at(n).type=ot.CubismMotionCurveTarget_Model:i.getMotionCurveTarget(n)==Er?this._motionData.curves.at(n).type=ot.CubismMotionCurveTarget_Parameter:i.getMotionCurveTarget(n)==Ar?this._motionData.curves.at(n).type=ot.CubismMotionCurveTarget_PartOpacity:st('Warning : Unable to get segment type from Curve! The number of "CurveCount" may be incorrect!'),this._motionData.curves.at(n).id=i.getMotionCurveId(n),this._motionData.curves.at(n).baseSegmentIndex=o,this._motionData.curves.at(n).fadeInTime=i.isExistMotionCurveFadeInTime(n)?i.getMotionCurveFadeInTime(n):-1,this._motionData.curves.at(n).fadeOutTime=i.isExistMotionCurveFadeOutTime(n)?i.getMotionCurveFadeOutTime(n):-1;for(let l=0;l<i.getMotionCurveSegmentCount(n);){switch(l==0?(this._motionData.segments.at(o).basePointIndex=a,this._motionData.points.at(a).time=i.getMotionCurveSegment(n,l),this._motionData.points.at(a).value=i.getMotionCurveSegment(n,l+1),a+=1,l+=2):this._motionData.segments.at(o).basePointIndex=a-1,i.getMotionCurveSegment(n,l)){case j.CubismMotionSegmentType_Linear:{this._motionData.segments.at(o).segmentType=j.CubismMotionSegmentType_Linear,this._motionData.segments.at(o).evaluate=Lr,this._motionData.points.at(a).time=i.getMotionCurveSegment(n,l+1),this._motionData.points.at(a).value=i.getMotionCurveSegment(n,l+2),a+=1,l+=3;break}case j.CubismMotionSegmentType_Bezier:{this._motionData.segments.at(o).segmentType=j.CubismMotionSegmentType_Bezier,r||Fr?this._motionData.segments.at(o).evaluate=Dr:this._motionData.segments.at(o).evaluate=kr,this._motionData.points.at(a).time=i.getMotionCurveSegment(n,l+1),this._motionData.points.at(a).value=i.getMotionCurveSegment(n,l+2),this._motionData.points.at(a+1).time=i.getMotionCurveSegment(n,l+3),this._motionData.points.at(a+1).value=i.getMotionCurveSegment(n,l+4),this._motionData.points.at(a+2).time=i.getMotionCurveSegment(n,l+5),this._motionData.points.at(a+2).value=i.getMotionCurveSegment(n,l+6),a+=3,l+=7;break}case j.CubismMotionSegmentType_Stepped:{this._motionData.segments.at(o).segmentType=j.CubismMotionSegmentType_Stepped,this._motionData.segments.at(o).evaluate=Or,this._motionData.points.at(a).time=i.getMotionCurveSegment(n,l+1),this._motionData.points.at(a).value=i.getMotionCurveSegment(n,l+2),a+=1,l+=3;break}case j.CubismMotionSegmentType_InverseStepped:{this._motionData.segments.at(o).segmentType=j.CubismMotionSegmentType_InverseStepped,this._motionData.segments.at(o).evaluate=Nr,this._motionData.points.at(a).time=i.getMotionCurveSegment(n,l+1),this._motionData.points.at(a).value=i.getMotionCurveSegment(n,l+2),a+=1,l+=3;break}default:{H(0);break}}++this._motionData.curves.at(n).segmentCount,++o}}for(let n=0;n<i.getEventCount();++n)this._motionData.events.at(n).fireTime=i.getEventTime(n),this._motionData.events.at(n).value=i.getEventValue(n);i.release(),i=void 0,i=null}getFiredEvent(t,e){this._firedEventValues.updateSize(0);for(let i=0;i<this._motionData.eventCount;++i)this._motionData.events.at(i).fireTime>t&&this._motionData.events.at(i).fireTime<=e&&this._firedEventValues.pushBack(new U(this._motionData.events.at(i).value.s));return this._firedEventValues}_sourceFrameRate;_loopDurationSeconds;_isLoop;_isLoopFadeIn;_lastWeight;_motionData;_eyeBlinkParameterIds;_lipSyncParameterIds;_modelCurveIdEyeBlink;_modelCurveIdLipSync}var ki;(s=>{s.CubismMotion=ne})(ki||(ki={}));class Oi{constructor(){this._autoDelete=!1,this._motion=null,this._available=!0,this._finished=!1,this._started=!1,this._startTimeSeconds=-1,this._fadeInStartTimeSeconds=0,this._endTimeSeconds=-1,this._stateTimeSeconds=0,this._stateWeight=0,this._lastEventCheckSeconds=0,this._motionQueueEntryHandle=this,this._fadeOutSeconds=0,this._isTriggeredFadeOut=!1}release(){this._autoDelete&&this._motion&&vt.delete(this._motion)}setFadeOut(t){this._fadeOutSeconds=t,this._isTriggeredFadeOut=!0}startFadeOut(t,e){const i=e+t;this._isTriggeredFadeOut=!0,(this._endTimeSeconds<0||i<this._endTimeSeconds)&&(this._endTimeSeconds=i)}isFinished(){return this._finished}isStarted(){return this._started}getStartTime(){return this._startTimeSeconds}getFadeInStartTime(){return this._fadeInStartTimeSeconds}getEndTime(){return this._endTimeSeconds}setStartTime(t){this._startTimeSeconds=t}setFadeInStartTime(t){this._fadeInStartTimeSeconds=t}setEndTime(t){this._endTimeSeconds=t}setIsFinished(t){this._finished=t}setIsStarted(t){this._started=t}isAvailable(){return this._available}setIsAvailable(t){this._available=t}setState(t,e){this._stateTimeSeconds=t,this._stateWeight=e}getStateTime(){return this._stateTimeSeconds}getStateWeight(){return this._stateWeight}getLastCheckEventSeconds(){return this._lastEventCheckSeconds}setLastCheckEventSeconds(t){this._lastEventCheckSeconds=t}isTriggeredFadeOut(){return this._isTriggeredFadeOut}getFadeOutSeconds(){return this._fadeOutSeconds}_autoDelete;_motion;_available;_finished;_started;_startTimeSeconds;_fadeInStartTimeSeconds;_endTimeSeconds;_stateTimeSeconds;_stateWeight;_lastEventCheckSeconds;_fadeOutSeconds;_isTriggeredFadeOut;_motionQueueEntryHandle}var Ni;(s=>{s.CubismMotionQueueEntry=Oi})(Ni||(Ni={}));class Ui{constructor(){this._userTimeSeconds=0,this._eventCallBack=null,this._eventCustomData=null,this._motions=new x}release(){for(let t=0;t<this._motions.getSize();++t)this._motions.at(t)&&(this._motions.at(t).release(),this._motions.set(t,null));this._motions=null}startMotion(t,e,i){if(t==null)return gt;let r=null;for(let a=0;a<this._motions.getSize();++a)r=this._motions.at(a),r?.setFadeOut(r._motion.getFadeOutTime());return r=new Oi,r._autoDelete=e,r._motion=t,this._motions.pushBack(r),r._motionQueueEntryHandle}isFinished(){for(let t=this._motions.begin();t.notEqual(this._motions.end());){let e=t.ptr();if(e==null){t=this._motions.erase(t);continue}if(e._motion==null){e.release(),e=null,t=this._motions.erase(t);continue}if(e.isFinished())t.preIncrement();else return!1}return!0}isFinishedByHandle(t){for(let e=this._motions.begin();e.notEqual(this._motions.end());e.increment()){const i=e.ptr();if(i!=null&&i._motionQueueEntryHandle==t&&!i.isFinished())return!1}return!0}stopAllMotions(){for(let t=this._motions.begin();t.notEqual(this._motions.end());){let e=t.ptr();if(e==null){t=this._motions.erase(t);continue}e.release(),e=null,t=this._motions.erase(t)}}getCubismMotionQueueEntry(t){for(let e=this._motions.begin();e.notEqual(this._motions.end());e.preIncrement()){const i=e.ptr();if(i!=null&&i._motionQueueEntryHandle==t)return i}return null}setEventCallback(t,e=null){this._eventCallBack=t,this._eventCustomData=e}doUpdateMotion(t,e){let i=!1;for(let r=this._motions.begin();r.notEqual(this._motions.end());){let a=r.ptr();if(a==null){r=this._motions.erase(r);continue}const o=a._motion;if(o==null){a.release(),a=null,r=this._motions.erase(r);continue}o.updateParameters(t,a,e),i=!0;const n=o.getFiredEvent(a.getLastCheckEventSeconds()-a.getStartTime(),e-a.getStartTime());for(let l=0;l<n.getSize();++l)this._eventCallBack(this,n.at(l),this._eventCustomData);a.setLastCheckEventSeconds(e),a.isFinished()?(a.release(),a=null,r=this._motions.erase(r)):(a.isTriggeredFadeOut()&&a.startFadeOut(a.getFadeOutSeconds(),e),r.preIncrement())}return i}_userTimeSeconds;_motions;_eventCallBack;_eventCustomData}const gt=-1;var zi;(s=>{s.CubismMotionQueueManager=Ui,s.InvalidMotionQueueEntryHandleValue=gt})(zi||(zi={}));class Ft extends Ui{constructor(){super(),this._currentPriority=0,this._reservePriority=0}getCurrentPriority(){return this._currentPriority}getReservePriority(){return this._reservePriority}setReservePriority(t){this._reservePriority=t}startMotionPriority(t,e,i){return i==this._reservePriority&&(this._reservePriority=0),this._currentPriority=i,super.startMotion(t,e,this._userTimeSeconds)}updateMotion(t,e){this._userTimeSeconds+=e;const i=super.doUpdateMotion(t,this._userTimeSeconds);return this.isFinished()&&(this._currentPriority=0),i}reserveMotion(t){return t<=this._reservePriority||t<=this._currentPriority?!1:(this._reservePriority=t,!0)}_currentPriority;_reservePriority}var Xi;(s=>{s.CubismMotionManager=Ft})(Xi||(Xi={}));var Qt=(s=>(s[s.CubismPhysicsTargetType_Parameter=0]="CubismPhysicsTargetType_Parameter",s))(Qt||{}),ut=(s=>(s[s.CubismPhysicsSource_X=0]="CubismPhysicsSource_X",s[s.CubismPhysicsSource_Y=1]="CubismPhysicsSource_Y",s[s.CubismPhysicsSource_Angle=2]="CubismPhysicsSource_Angle",s))(ut||{});class Ur{constructor(){this.gravity=new C(0,0),this.wind=new C(0,0)}gravity;wind}class xe{id;targetType}class Ce{minimum;maximum;defalut}class Yi{constructor(){this.initialPosition=new C(0,0),this.position=new C(0,0),this.lastPosition=new C(0,0),this.lastGravity=new C(0,0),this.force=new C(0,0),this.velocity=new C(0,0)}initialPosition;mobility;delay;acceleration;radius;position;lastPosition;lastGravity;force;velocity}class ji{constructor(){this.normalizationPosition=new Ce,this.normalizationAngle=new Ce}inputCount;outputCount;particleCount;baseInputIndex;baseOutputIndex;baseParticleIndex;normalizationPosition;normalizationAngle}class Gi{constructor(){this.source=new xe}source;sourceParameterIndex;weight;type;reflect;getNormalizedParameterValue}class Hi{constructor(){this.destination=new xe,this.translationScale=new C(0,0)}destination;destinationParameterIndex;vertexIndex;translationScale;angleScale;weight;type;reflect;valueBelowMinimum;valueExceededMaximum;getValue;getScale}class Wi{constructor(){this.settings=new x,this.inputs=new x,this.outputs=new x,this.particles=new x,this.gravity=new C(0,0),this.wind=new C(0,0),this.fps=0}subRigCount;settings;inputs;outputs;particles;gravity;wind;fps}var $i;(s=>{s.CubismPhysicsInput=Gi,s.CubismPhysicsNormalization=Ce,s.CubismPhysicsOutput=Hi,s.CubismPhysicsParameter=xe,s.CubismPhysicsParticle=Yi,s.CubismPhysicsRig=Wi,s.CubismPhysicsSource=ut,s.CubismPhysicsSubRig=ji,s.CubismPhysicsTargetType=Qt,s.PhysicsJsonEffectiveForces=Ur})($i||($i={}));const Lt="Position",Be="X",Me="Y",Pe="Angle",qi="Type",Ji="Id",tt="Meta",te="EffectiveForces",zr="TotalInputCount",Xr="TotalOutputCount",Yr="PhysicsSettingCount",Ki="Gravity",Zi="Wind",jr="VertexCount",Gr="Fps",w="PhysicsSettings",bt="Normalization",Qi="Minimum",ts="Maximum",es="Default",is="Reflect",ss="Weight",Dt="Input",Hr="Source",ct="Output",Wr="Scale",$r="VertexIndex",qr="Destination",dt="Vertices",Jr="Mobility",Kr="Delay",Zr="Radius",Qr="Acceleration";class rs{constructor(t,e){this._json=A.create(t,e)}release(){A.delete(this._json)}getGravity(){const t=new C(0,0);return t.x=this._json.getRoot().getValueByString(tt).getValueByString(te).getValueByString(Ki).getValueByString(Be).toFloat(),t.y=this._json.getRoot().getValueByString(tt).getValueByString(te).getValueByString(Ki).getValueByString(Me).toFloat(),t}getWind(){const t=new C(0,0);return t.x=this._json.getRoot().getValueByString(tt).getValueByString(te).getValueByString(Zi).getValueByString(Be).toFloat(),t.y=this._json.getRoot().getValueByString(tt).getValueByString(te).getValueByString(Zi).getValueByString(Me).toFloat(),t}getFps(){return this._json.getRoot().getValueByString(tt).getValueByString(Gr).toFloat(0)}getSubRigCount(){return this._json.getRoot().getValueByString(tt).getValueByString(Yr).toInt()}getTotalInputCount(){return this._json.getRoot().getValueByString(tt).getValueByString(zr).toInt()}getTotalOutputCount(){return this._json.getRoot().getValueByString(tt).getValueByString(Xr).toInt()}getVertexCount(){return this._json.getRoot().getValueByString(tt).getValueByString(jr).toInt()}getNormalizationPositionMinimumValue(t){return this._json.getRoot().getValueByString(w).getValueByIndex(t).getValueByString(bt).getValueByString(Lt).getValueByString(Qi).toFloat()}getNormalizationPositionMaximumValue(t){return this._json.getRoot().getValueByString(w).getValueByIndex(t).getValueByString(bt).getValueByString(Lt).getValueByString(ts).toFloat()}getNormalizationPositionDefaultValue(t){return this._json.getRoot().getValueByString(w).getValueByIndex(t).getValueByString(bt).getValueByString(Lt).getValueByString(es).toFloat()}getNormalizationAngleMinimumValue(t){return this._json.getRoot().getValueByString(w).getValueByIndex(t).getValueByString(bt).getValueByString(Pe).getValueByString(Qi).toFloat()}getNormalizationAngleMaximumValue(t){return this._json.getRoot().getValueByString(w).getValueByIndex(t).getValueByString(bt).getValueByString(Pe).getValueByString(ts).toFloat()}getNormalizationAngleDefaultValue(t){return this._json.getRoot().getValueByString(w).getValueByIndex(t).getValueByString(bt).getValueByString(Pe).getValueByString(es).toFloat()}getInputCount(t){return this._json.getRoot().getValueByString(w).getValueByIndex(t).getValueByString(Dt).getVector().getSize()}getInputWeight(t,e){return this._json.getRoot().getValueByString(w).getValueByIndex(t).getValueByString(Dt).getValueByIndex(e).getValueByString(ss).toFloat()}getInputReflect(t,e){return this._json.getRoot().getValueByString(w).getValueByIndex(t).getValueByString(Dt).getValueByIndex(e).getValueByString(is).toBoolean()}getInputType(t,e){return this._json.getRoot().getValueByString(w).getValueByIndex(t).getValueByString(Dt).getValueByIndex(e).getValueByString(qi).getRawString()}getInputSourceId(t,e){return V.getIdManager().getId(this._json.getRoot().getValueByString(w).getValueByIndex(t).getValueByString(Dt).getValueByIndex(e).getValueByString(Hr).getValueByString(Ji).getRawString())}getOutputCount(t){return this._json.getRoot().getValueByString(w).getValueByIndex(t).getValueByString(ct).getVector().getSize()}getOutputVertexIndex(t,e){return this._json.getRoot().getValueByString(w).getValueByIndex(t).getValueByString(ct).getValueByIndex(e).getValueByString($r).toInt()}getOutputAngleScale(t,e){return this._json.getRoot().getValueByString(w).getValueByIndex(t).getValueByString(ct).getValueByIndex(e).getValueByString(Wr).toFloat()}getOutputWeight(t,e){return this._json.getRoot().getValueByString(w).getValueByIndex(t).getValueByString(ct).getValueByIndex(e).getValueByString(ss).toFloat()}getOutputDestinationId(t,e){return V.getIdManager().getId(this._json.getRoot().getValueByString(w).getValueByIndex(t).getValueByString(ct).getValueByIndex(e).getValueByString(qr).getValueByString(Ji).getRawString())}getOutputType(t,e){return this._json.getRoot().getValueByString(w).getValueByIndex(t).getValueByString(ct).getValueByIndex(e).getValueByString(qi).getRawString()}getOutputReflect(t,e){return this._json.getRoot().getValueByString(w).getValueByIndex(t).getValueByString(ct).getValueByIndex(e).getValueByString(is).toBoolean()}getParticleCount(t){return this._json.getRoot().getValueByString(w).getValueByIndex(t).getValueByString(dt).getVector().getSize()}getParticleMobility(t,e){return this._json.getRoot().getValueByString(w).getValueByIndex(t).getValueByString(dt).getValueByIndex(e).getValueByString(Jr).toFloat()}getParticleDelay(t,e){return this._json.getRoot().getValueByString(w).getValueByIndex(t).getValueByString(dt).getValueByIndex(e).getValueByString(Kr).toFloat()}getParticleAcceleration(t,e){return this._json.getRoot().getValueByString(w).getValueByIndex(t).getValueByString(dt).getValueByIndex(e).getValueByString(Qr).toFloat()}getParticleRadius(t,e){return this._json.getRoot().getValueByString(w).getValueByIndex(t).getValueByString(dt).getValueByIndex(e).getValueByString(Zr).toFloat()}getParticlePosition(t,e){const i=new C(0,0);return i.x=this._json.getRoot().getValueByString(w).getValueByIndex(t).getValueByString(dt).getValueByIndex(e).getValueByString(Lt).getValueByString(Be).toFloat(),i.y=this._json.getRoot().getValueByString(w).getValueByIndex(t).getValueByString(dt).getValueByIndex(e).getValueByString(Lt).getValueByString(Me).toFloat(),i}_json}var as;(s=>{s.CubismPhysicsJson=rs})(as||(as={}));const ns="X",os="Y",ls="Angle",ta=5,ve=100,us=.001,ea=5;class Ut{static create(t,e){const i=new Ut;return i.parse(t,e),i._physicsRig.gravity.y=0,i}static delete(t){t!=null&&(t.release(),t=null)}parse(t,e){this._physicsRig=new Wi;let i=new rs(t,e);this._physicsRig.gravity=i.getGravity(),this._physicsRig.wind=i.getWind(),this._physicsRig.subRigCount=i.getSubRigCount(),this._physicsRig.fps=i.getFps(),this._physicsRig.settings.updateSize(this._physicsRig.subRigCount,ji,!0),this._physicsRig.inputs.updateSize(i.getTotalInputCount(),Gi,!0),this._physicsRig.outputs.updateSize(i.getTotalOutputCount(),Hi,!0),this._physicsRig.particles.updateSize(i.getVertexCount(),Yi,!0),this._currentRigOutputs.clear(),this._previousRigOutputs.clear();let r=0,a=0,o=0;for(let n=0;n<this._physicsRig.settings.getSize();++n){this._physicsRig.settings.at(n).normalizationPosition.minimum=i.getNormalizationPositionMinimumValue(n),this._physicsRig.settings.at(n).normalizationPosition.maximum=i.getNormalizationPositionMaximumValue(n),this._physicsRig.settings.at(n).normalizationPosition.defalut=i.getNormalizationPositionDefaultValue(n),this._physicsRig.settings.at(n).normalizationAngle.minimum=i.getNormalizationAngleMinimumValue(n),this._physicsRig.settings.at(n).normalizationAngle.maximum=i.getNormalizationAngleMaximumValue(n),this._physicsRig.settings.at(n).normalizationAngle.defalut=i.getNormalizationAngleDefaultValue(n),this._physicsRig.settings.at(n).inputCount=i.getInputCount(n),this._physicsRig.settings.at(n).baseInputIndex=r;for(let h=0;h<this._physicsRig.settings.at(n).inputCount;++h)this._physicsRig.inputs.at(r+h).sourceParameterIndex=-1,this._physicsRig.inputs.at(r+h).weight=i.getInputWeight(n,h),this._physicsRig.inputs.at(r+h).reflect=i.getInputReflect(n,h),i.getInputType(n,h)==ns?(this._physicsRig.inputs.at(r+h).type=ut.CubismPhysicsSource_X,this._physicsRig.inputs.at(r+h).getNormalizedParameterValue=sa):i.getInputType(n,h)==os?(this._physicsRig.inputs.at(r+h).type=ut.CubismPhysicsSource_Y,this._physicsRig.inputs.at(r+h).getNormalizedParameterValue=ra):i.getInputType(n,h)==ls&&(this._physicsRig.inputs.at(r+h).type=ut.CubismPhysicsSource_Angle,this._physicsRig.inputs.at(r+h).getNormalizedParameterValue=aa),this._physicsRig.inputs.at(r+h).source.targetType=Qt.CubismPhysicsTargetType_Parameter,this._physicsRig.inputs.at(r+h).source.id=i.getInputSourceId(n,h);r+=this._physicsRig.settings.at(n).inputCount,this._physicsRig.settings.at(n).outputCount=i.getOutputCount(n),this._physicsRig.settings.at(n).baseOutputIndex=a;const l=new gs;l.outputs.resize(this._physicsRig.settings.at(n).outputCount);const u=new gs;u.outputs.resize(this._physicsRig.settings.at(n).outputCount);for(let h=0;h<this._physicsRig.settings.at(n).outputCount;++h)l.outputs[h]=0,u.outputs[h]=0,this._physicsRig.outputs.at(a+h).destinationParameterIndex=-1,this._physicsRig.outputs.at(a+h).vertexIndex=i.getOutputVertexIndex(n,h),this._physicsRig.outputs.at(a+h).angleScale=i.getOutputAngleScale(n,h),this._physicsRig.outputs.at(a+h).weight=i.getOutputWeight(n,h),this._physicsRig.outputs.at(a+h).destination.targetType=Qt.CubismPhysicsTargetType_Parameter,this._physicsRig.outputs.at(a+h).destination.id=i.getOutputDestinationId(n,h),i.getOutputType(n,h)==ns?(this._physicsRig.outputs.at(a+h).type=ut.CubismPhysicsSource_X,this._physicsRig.outputs.at(a+h).getValue=na,this._physicsRig.outputs.at(a+h).getScale=ga):i.getOutputType(n,h)==os?(this._physicsRig.outputs.at(a+h).type=ut.CubismPhysicsSource_Y,this._physicsRig.outputs.at(a+h).getValue=oa,this._physicsRig.outputs.at(a+h).getScale=ca):i.getOutputType(n,h)==ls&&(this._physicsRig.outputs.at(a+h).type=ut.CubismPhysicsSource_Angle,this._physicsRig.outputs.at(a+h).getValue=la,this._physicsRig.outputs.at(a+h).getScale=da),this._physicsRig.outputs.at(a+h).reflect=i.getOutputReflect(n,h);this._currentRigOutputs.pushBack(l),this._previousRigOutputs.pushBack(u),a+=this._physicsRig.settings.at(n).outputCount,this._physicsRig.settings.at(n).particleCount=i.getParticleCount(n),this._physicsRig.settings.at(n).baseParticleIndex=o;for(let h=0;h<this._physicsRig.settings.at(n).particleCount;++h)this._physicsRig.particles.at(o+h).mobility=i.getParticleMobility(n,h),this._physicsRig.particles.at(o+h).delay=i.getParticleDelay(n,h),this._physicsRig.particles.at(o+h).acceleration=i.getParticleAcceleration(n,h),this._physicsRig.particles.at(o+h).radius=i.getParticleRadius(n,h),this._physicsRig.particles.at(o+h).position=i.getParticlePosition(n,h);o+=this._physicsRig.settings.at(n).particleCount}this.initialize(),i.release(),i=void 0,i=null}stabilization(t){let e,i,r,a;const o=new C;let n,l,u,h,m,d,g,c;m=t.getModel().parameters.values,d=t.getModel().parameters.maximumValues,g=t.getModel().parameters.minimumValues,c=t.getModel().parameters.defaultValues,(this._parameterCaches?.length??0)<t.getParameterCount()&&(this._parameterCaches=new Float32Array(t.getParameterCount())),(this._parameterInputCaches?.length??0)<t.getParameterCount()&&(this._parameterInputCaches=new Float32Array(t.getParameterCount()));for(let p=0;p<t.getParameterCount();++p)this._parameterCaches[p]=m[p],this._parameterInputCaches[p]=m[p];for(let p=0;p<this._physicsRig.subRigCount;++p){e={angle:0},o.x=0,o.y=0,n=this._physicsRig.settings.at(p),l=this._physicsRig.inputs.get(n.baseInputIndex),u=this._physicsRig.outputs.get(n.baseOutputIndex),h=this._physicsRig.particles.get(n.baseParticleIndex);for(let _=0;_<n.inputCount;++_)i=l[_].weight/ve,l[_].sourceParameterIndex==-1&&(l[_].sourceParameterIndex=t.getParameterIndex(l[_].source.id)),l[_].getNormalizedParameterValue(o,e,m[l[_].sourceParameterIndex],g[l[_].sourceParameterIndex],d[l[_].sourceParameterIndex],c[l[_].sourceParameterIndex],n.normalizationPosition,n.normalizationAngle,l[_].reflect,i),this._parameterCaches[l[_].sourceParameterIndex]=m[l[_].sourceParameterIndex];r=v.degreesToRadian(-e.angle),o.x=o.x*v.cos(r)-o.y*v.sin(r),o.y=o.x*v.sin(r)+o.y*v.cos(r),ma(h,n.particleCount,o,e.angle,this._options.wind,us*n.normalizationPosition.maximum);for(let _=0;_<n.outputCount;++_){const B=u[_].vertexIndex;if(u[_].destinationParameterIndex==-1&&(u[_].destinationParameterIndex=t.getParameterIndex(u[_].destination.id)),B<1||B>=n.particleCount)continue;let P=new C;P=h[B].position.substract(h[B-1].position),a=u[_].getValue(P,h,B,u[_].reflect,this._options.gravity),this._currentRigOutputs.at(p).outputs[_]=a,this._previousRigOutputs.at(p).outputs[_]=a;const y=u[_].destinationParameterIndex,f=!Float32Array.prototype.slice&&"subarray"in Float32Array.prototype?JSON.parse(JSON.stringify(m.subarray(y))):m.slice(y);be(f,g[y],d[y],a,u[_]);for(let T=y,b=0;T<this._parameterCaches.length;T++,b++)m[T]=this._parameterCaches[T]=f[b]}}}evaluate(t,e){let i,r,a,o;const n=new C;let l,u,h,m;if(0>=e)return;let d,g,c,p,_;if(this._currentRemainTime+=e,this._currentRemainTime>ea&&(this._currentRemainTime=0),d=t.getModel().parameters.values,g=t.getModel().parameters.maximumValues,c=t.getModel().parameters.minimumValues,p=t.getModel().parameters.defaultValues,(this._parameterCaches?.length??0)<t.getParameterCount()&&(this._parameterCaches=new Float32Array(t.getParameterCount())),(this._parameterInputCaches?.length??0)<t.getParameterCount()){this._parameterInputCaches=new Float32Array(t.getParameterCount());for(let P=0;P<t.getParameterCount();++P)this._parameterInputCaches[P]=d[P]}for(this._physicsRig.fps>0?_=1/this._physicsRig.fps:_=e;this._currentRemainTime>=_;){for(let y=0;y<this._physicsRig.subRigCount;++y){l=this._physicsRig.settings.at(y),h=this._physicsRig.outputs.get(l.baseOutputIndex);for(let f=0;f<l.outputCount;++f)this._previousRigOutputs.at(y).outputs[f]=this._currentRigOutputs.at(y).outputs[f]}const P=_/this._currentRemainTime;for(let y=0;y<t.getParameterCount();++y)this._parameterCaches[y]=this._parameterInputCaches[y]*(1-P)+d[y]*P,this._parameterInputCaches[y]=this._parameterCaches[y];for(let y=0;y<this._physicsRig.subRigCount;++y){i={angle:0},n.x=0,n.y=0,l=this._physicsRig.settings.at(y),u=this._physicsRig.inputs.get(l.baseInputIndex),h=this._physicsRig.outputs.get(l.baseOutputIndex),m=this._physicsRig.particles.get(l.baseParticleIndex);for(let f=0;f<l.inputCount;++f)r=u[f].weight/ve,u[f].sourceParameterIndex==-1&&(u[f].sourceParameterIndex=t.getParameterIndex(u[f].source.id)),u[f].getNormalizedParameterValue(n,i,this._parameterCaches[u[f].sourceParameterIndex],c[u[f].sourceParameterIndex],g[u[f].sourceParameterIndex],p[u[f].sourceParameterIndex],l.normalizationPosition,l.normalizationAngle,u[f].reflect,r);a=v.degreesToRadian(-i.angle),n.x=n.x*v.cos(a)-n.y*v.sin(a),n.y=n.x*v.sin(a)+n.y*v.cos(a),_a(m,l.particleCount,n,i.angle,this._options.wind,us*l.normalizationPosition.maximum,_,ta);for(let f=0;f<l.outputCount;++f){const T=h[f].vertexIndex;if(h[f].destinationParameterIndex==-1&&(h[f].destinationParameterIndex=t.getParameterIndex(h[f].destination.id)),T<1||T>=l.particleCount)continue;const b=new C;b.x=m[T].position.x-m[T-1].position.x,b.y=m[T].position.y-m[T-1].position.y,o=h[f].getValue(b,m,T,h[f].reflect,this._options.gravity),this._currentRigOutputs.at(y).outputs[f]=o;const D=h[f].destinationParameterIndex,it=!Float32Array.prototype.slice&&"subarray"in Float32Array.prototype?JSON.parse(JSON.stringify(this._parameterCaches.subarray(D))):this._parameterCaches.slice(D);be(it,c[D],g[D],o,h[f]);for(let J=D,pt=0;J<this._parameterCaches.length;J++,pt++)this._parameterCaches[J]=it[pt]}}this._currentRemainTime-=_}const B=this._currentRemainTime/_;this.interpolate(t,B)}interpolate(t,e){let i,r,a,o,n;a=t.getModel().parameters.values,o=t.getModel().parameters.maximumValues,n=t.getModel().parameters.minimumValues;for(let l=0;l<this._physicsRig.subRigCount;++l){r=this._physicsRig.settings.at(l),i=this._physicsRig.outputs.get(r.baseOutputIndex);for(let u=0;u<r.outputCount;++u){if(i[u].destinationParameterIndex==-1)continue;const h=i[u].destinationParameterIndex,m=!Float32Array.prototype.slice&&"subarray"in Float32Array.prototype?JSON.parse(JSON.stringify(a.subarray(h))):a.slice(h);be(m,n[h],o[h],this._previousRigOutputs.at(l).outputs[u]*(1-e)+this._currentRigOutputs.at(l).outputs[u]*e,i[u]);for(let d=h,g=0;d<a.length;d++,g++)a[d]=m[g]}}}setOptions(t){this._options=t}getOption(){return this._options}constructor(){this._physicsRig=null,this._options=new hs,this._options.gravity.y=-1,this._options.gravity.x=0,this._options.wind.x=0,this._options.wind.y=0,this._currentRigOutputs=new x,this._previousRigOutputs=new x,this._currentRemainTime=0,this._parameterCaches=null,this._parameterInputCaches=null}release(){this._physicsRig=void 0,this._physicsRig=null}initialize(){let t,e,i;for(let r=0;r<this._physicsRig.subRigCount;++r){e=this._physicsRig.settings.at(r),t=this._physicsRig.particles.get(e.baseParticleIndex),t[0].initialPosition=new C(0,0),t[0].lastPosition=new C(t[0].initialPosition.x,t[0].initialPosition.y),t[0].lastGravity=new C(0,-1),t[0].lastGravity.y*=-1,t[0].velocity=new C(0,0),t[0].force=new C(0,0);for(let a=1;a<e.particleCount;++a)i=new C(0,0),i.y=t[a].radius,t[a].initialPosition=new C(t[a-1].initialPosition.x+i.x,t[a-1].initialPosition.y+i.y),t[a].position=new C(t[a].initialPosition.x,t[a].initialPosition.y),t[a].lastPosition=new C(t[a].initialPosition.x,t[a].initialPosition.y),t[a].lastGravity=new C(0,-1),t[a].lastGravity.y*=-1,t[a].velocity=new C(0,0),t[a].force=new C(0,0)}}_physicsRig;_options;_currentRigOutputs;_previousRigOutputs;_currentRemainTime;_parameterCaches;_parameterInputCaches}class hs{constructor(){this.gravity=new C(0,0),this.wind=new C(0,0)}gravity;wind}class gs{constructor(){this.outputs=new x(0)}outputs}function ia(s){let t=0;return s>0?t=1:s<0&&(t=-1),t}function sa(s,t,e,i,r,a,o,n,l,u){s.x+=Ie(e,i,r,a,o.minimum,o.maximum,o.defalut,l)*u}function ra(s,t,e,i,r,a,o,n,l,u){s.y+=Ie(e,i,r,a,o.minimum,o.maximum,o.defalut,l)*u}function aa(s,t,e,i,r,a,o,n,l,u){t.angle+=Ie(e,i,r,a,n.minimum,n.maximum,n.defalut,l)*u}function na(s,t,e,i,r){let a=s.x;return i&&(a*=-1),a}function oa(s,t,e,i,r){let a=s.y;return i&&(a*=-1),a}function la(s,t,e,i,r){let a;return e>=2?r=t[e-1].position.substract(t[e-2].position):r=r.multiplyByScaler(-1),a=v.directionToRadian(r,s),i&&(a*=-1),a}function ua(s,t){const e=v.max(s,t),i=v.min(s,t);return v.abs(e-i)}function ha(s,t){return v.min(s,t)+ua(s,t)/2}function ga(s,t){return JSON.parse(JSON.stringify(s.x))}function ca(s,t){return JSON.parse(JSON.stringify(s.y))}function da(s,t){return JSON.parse(JSON.stringify(t))}function _a(s,t,e,i,r,a,o,n){let l,u,h,m,d=new C(0,0),g=new C(0,0),c=new C(0,0),p=new C(0,0);s[0].position=new C(e.x,e.y),l=v.degreesToRadian(i),m=v.radianToDirection(l),m.normalize();for(let _=1;_<t;++_)s[_].force=m.multiplyByScaler(s[_].acceleration).add(r),s[_].lastPosition=new C(s[_].position.x,s[_].position.y),u=s[_].delay*o*30,d=s[_].position.substract(s[_-1].position),h=v.directionToRadian(s[_].lastGravity,m)/n,d.x=v.cos(h)*d.x-d.y*v.sin(h),d.y=v.sin(h)*d.x+d.y*v.cos(h),s[_].position=s[_-1].position.add(d),g=s[_].velocity.multiplyByScaler(u),c=s[_].force.multiplyByScaler(u).multiplyByScaler(u),s[_].position=s[_].position.add(g).add(c),p=s[_].position.substract(s[_-1].position),p.normalize(),s[_].position=s[_-1].position.add(p.multiplyByScaler(s[_].radius)),v.abs(s[_].position.x)<a&&(s[_].position.x=0),u!=0&&(s[_].velocity=s[_].position.substract(s[_].lastPosition),s[_].velocity=s[_].velocity.divisionByScalar(u),s[_].velocity=s[_].velocity.multiplyByScaler(s[_].mobility)),s[_].force=new C(0,0),s[_].lastGravity=new C(m.x,m.y)}function ma(s,t,e,i,r,a){let o,n,l=new C(0,0);s[0].position=new C(e.x,e.y),o=v.degreesToRadian(i),n=v.radianToDirection(o),n.normalize();for(let u=1;u<t;++u)s[u].force=n.multiplyByScaler(s[u].acceleration).add(r),s[u].lastPosition=new C(s[u].position.x,s[u].position.y),s[u].velocity=new C(0,0),l=s[u].force,l.normalize(),l=l.multiplyByScaler(s[u].radius),s[u].position=s[u-1].position.add(l),v.abs(s[u].position.x)<a&&(s[u].position.x=0),s[u].force=new C(0,0),s[u].lastGravity=new C(n.x,n.y)}function be(s,t,e,i,r){let a,o,n;a=r.getScale(r.translationScale,r.angleScale),o=i*a,o<t?(o<r.valueBelowMinimum&&(r.valueBelowMinimum=o),o=t):o>e&&(o>r.valueExceededMaximum&&(r.valueExceededMaximum=o),o=e),n=r.weight/ve,n>=1||(o=s[0]*(1-n)+o*n),s[0]=o}function Ie(s,t,e,i,r,a,o,n){let l=0;const u=v.max(e,t);u<s&&(s=u);const h=v.min(e,t);h>s&&(s=h);const m=v.min(r,a),d=v.max(r,a),g=o,c=ha(h,u),p=s-c;switch(ia(p)){case 1:{const _=d-g,B=u-c;B!=0&&(l=p*(_/B),l+=g);break}case-1:{const _=m-g,B=h-c;B!=0&&(l=p*(_/B),l+=g);break}case 0:{l=g;break}}return n?l:l*-1}var cs;(s=>{s.CubismPhysics=Ut,s.Options=hs})(cs||(cs={}));class ee{constructor(t,e,i,r){this.x=t,this.y=e,this.width=i,this.height=r}getCenterX(){return this.x+.5*this.width}getCenterY(){return this.y+.5*this.height}getRight(){return this.x+this.width}getBottom(){return this.y+this.height}setRect(t){this.x=t.x,this.y=t.y,this.width=t.width,this.height=t.height}expand(t,e){this.x-=t,this.y-=e,this.width+=t*2,this.height+=e*2}x;y;width;height}var ds;(s=>{s.csmRect=ee})(ds||(ds={}));const ie=4,pa=36,fa=32,ya=10;let _t,et,se;class Te{getChannelFlagAsColor(t){return this._channelColors.at(t)}getMaskRenderTexture(){if(this._maskTexture&&this._maskTexture.textures!=null)this._maskTexture.frameNo=this._currentFrameNo;else{this._maskRenderTextures!=null&&this._maskRenderTextures.clear(),this._maskRenderTextures=new x,this._maskColorBuffers!=null&&this._maskColorBuffers.clear(),this._maskColorBuffers=new x;const t=this._clippingMaskBufferSize;for(let e=0;e<this._renderTextureCount;e++)this._maskColorBuffers.pushBack(this.gl.createTexture()),this.gl.bindTexture(this.gl.TEXTURE_2D,this._maskColorBuffers.at(e)),this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,t,t,0,this.gl.RGBA,this.gl.UNSIGNED_BYTE,null),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_S,this.gl.CLAMP_TO_EDGE),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_T,this.gl.CLAMP_TO_EDGE),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MIN_FILTER,this.gl.LINEAR),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MAG_FILTER,this.gl.LINEAR),this.gl.bindTexture(this.gl.TEXTURE_2D,null),this._maskRenderTextures.pushBack(this.gl.createFramebuffer()),this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,this._maskRenderTextures.at(e)),this.gl.framebufferTexture2D(this.gl.FRAMEBUFFER,this.gl.COLOR_ATTACHMENT0,this.gl.TEXTURE_2D,this._maskColorBuffers.at(e),0);this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,se),this._maskTexture=new _s(this._currentFrameNo,this._maskRenderTextures)}return this._maskTexture.textures}setGL(t){this.gl=t}calcClippedDrawTotalBounds(t,e){let i=Number.MAX_VALUE,r=Number.MAX_VALUE,a=Number.MIN_VALUE,o=Number.MIN_VALUE;const n=e._clippedDrawableIndexList.length;for(let l=0;l<n;l++){const u=e._clippedDrawableIndexList[l],h=t.getDrawableVertexCount(u),m=t.getDrawableVertices(u);let d=Number.MAX_VALUE,g=Number.MAX_VALUE,c=-Number.MAX_VALUE,p=-Number.MAX_VALUE;const _=h*rt.vertexStep;for(let B=rt.vertexOffset;B<_;B+=rt.vertexStep){const P=m[B],y=m[B+1];P<d&&(d=P),P>c&&(c=P),y<g&&(g=y),y>p&&(p=y)}if(d!=Number.MAX_VALUE)if(d<i&&(i=d),g<r&&(r=g),c>a&&(a=c),p>o&&(o=p),i==Number.MAX_VALUE)e._allClippedDrawRect.x=0,e._allClippedDrawRect.y=0,e._allClippedDrawRect.width=0,e._allClippedDrawRect.height=0,e._isUsing=!1;else{e._isUsing=!0;const B=a-i,P=o-r;e._allClippedDrawRect.x=i,e._allClippedDrawRect.y=r,e._allClippedDrawRect.width=B,e._allClippedDrawRect.height=P}}}constructor(){this._currentMaskRenderTexture=null,this._maskColorBuffers=null,this._currentFrameNo=0,this._renderTextureCount=0,this._clippingMaskBufferSize=256,this._clippingContextListForMask=new x,this._clippingContextListForDraw=new x,this._channelColors=new x,this._tmpBoundsOnModel=new ee,this._tmpMatrix=new E,this._tmpMatrixForMask=new E,this._tmpMatrixForDraw=new E,this._maskTexture=null;let t=new Z;t.R=1,t.G=0,t.B=0,t.A=0,this._channelColors.pushBack(t),t=new Z,t.R=0,t.G=1,t.B=0,t.A=0,this._channelColors.pushBack(t),t=new Z,t.R=0,t.G=0,t.B=1,t.A=0,this._channelColors.pushBack(t),t=new Z,t.R=0,t.G=0,t.B=0,t.A=1,this._channelColors.pushBack(t)}release(){for(let t=0;t<this._clippingContextListForMask.getSize();t++)this._clippingContextListForMask.at(t)&&(this._clippingContextListForMask.at(t).release(),this._clippingContextListForMask.set(t,void 0)),this._clippingContextListForMask.set(t,null);this._clippingContextListForMask=null;for(let t=0;t<this._clippingContextListForDraw.getSize();t++)this._clippingContextListForDraw.set(t,null);if(this._clippingContextListForDraw=null,this._maskTexture){for(let t=0;t<this._maskTexture.textures.getSize();t++)this.gl.deleteFramebuffer(this._maskTexture.textures.at(t));this._maskTexture.textures.clear(),this._maskTexture.textures=null,this._maskTexture=null}for(let t=0;t<this._channelColors.getSize();t++)this._channelColors.set(t,null);if(this._channelColors=null,this._maskColorBuffers!=null){for(let t=0;t<this._maskColorBuffers.getSize();t++)this.gl.deleteTexture(this._maskColorBuffers.at(t));this._maskColorBuffers.clear()}this._maskColorBuffers=null,this._maskRenderTextures!=null&&this._maskRenderTextures.clear(),this._maskRenderTextures=null,this._clearedFrameBufferflags!=null&&this._clearedFrameBufferflags.clear(),this._clearedFrameBufferflags=null}initialize(t,e,i,r,a){a%1!=0&&(st("The number of render textures must be specified as an integer. The decimal point is rounded down and corrected to an integer."),a=~~a),a<1&&st("The number of render textures must be an integer greater than or equal to 1. Set the number of render textures to 1."),this._renderTextureCount=a<1?1:a,this._clearedFrameBufferflags=new x(this._renderTextureCount);for(let o=0;o<e;o++){if(r[o]<=0){this._clippingContextListForDraw.pushBack(null);continue}let n=this.findSameClip(i[o],r[o]);n==null&&(n=new ms(this,i[o],r[o]),this._clippingContextListForMask.pushBack(n)),n.addClippedDrawable(o),this._clippingContextListForDraw.pushBack(n)}}setupClippingContext(t,e){this._currentFrameNo++;let i=0;for(let r=0;r<this._clippingContextListForMask.getSize();r++){const a=this._clippingContextListForMask.at(r);this.calcClippedDrawTotalBounds(t,a),a._isUsing&&i++}if(i>0){this.setupLayoutBounds(e.isUsingHighPrecisionMask()?0:i),e.isUsingHighPrecisionMask()||(this.gl.viewport(0,0,this._clippingMaskBufferSize,this._clippingMaskBufferSize),this._currentMaskRenderTexture=this.getMaskRenderTexture().at(0),e.preDraw(),this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,this._currentMaskRenderTexture)),this._clearedFrameBufferflags.getSize()!=this._renderTextureCount&&(this._clearedFrameBufferflags.clear(),this._clearedFrameBufferflags=new x(this._renderTextureCount));for(let r=0;r<this._clearedFrameBufferflags.getSize();r++)this._clearedFrameBufferflags[r]=!1;for(let r=0;r<this._clippingContextListForMask.getSize();r++){const a=this._clippingContextListForMask.at(r),o=a._allClippedDrawRect,n=a._layoutBounds,l=.05;let u=0,h=0;const m=this.getMaskRenderTexture().at(a._bufferIndex);if(this._currentMaskRenderTexture!=m&&!e.isUsingHighPrecisionMask()&&(this._currentMaskRenderTexture=m,e.preDraw(),this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,this._currentMaskRenderTexture)),e.isUsingHighPrecisionMask()){const d=t.getPixelsPerUnit(),g=a.getClippingManager()._clippingMaskBufferSize,c=n.width*g,p=n.height*g;this._tmpBoundsOnModel.setRect(o),this._tmpBoundsOnModel.width*d>c?(this._tmpBoundsOnModel.expand(o.width*l,0),u=n.width/this._tmpBoundsOnModel.width):u=d/c,this._tmpBoundsOnModel.height*d>p?(this._tmpBoundsOnModel.expand(0,o.height*l),h=n.height/this._tmpBoundsOnModel.height):h=d/p}else this._tmpBoundsOnModel.setRect(o),this._tmpBoundsOnModel.expand(o.width*l,o.height*l),u=n.width/this._tmpBoundsOnModel.width,h=n.height/this._tmpBoundsOnModel.height;if(this._tmpMatrix.loadIdentity(),this._tmpMatrix.translateRelative(-1,-1),this._tmpMatrix.scaleRelative(2,2),this._tmpMatrix.translateRelative(n.x,n.y),this._tmpMatrix.scaleRelative(u,h),this._tmpMatrix.translateRelative(-this._tmpBoundsOnModel.x,-this._tmpBoundsOnModel.y),this._tmpMatrixForMask.setMatrix(this._tmpMatrix.getArray()),this._tmpMatrix.loadIdentity(),this._tmpMatrix.translateRelative(n.x,n.y),this._tmpMatrix.scaleRelative(u,h),this._tmpMatrix.translateRelative(-this._tmpBoundsOnModel.x,-this._tmpBoundsOnModel.y),this._tmpMatrixForDraw.setMatrix(this._tmpMatrix.getArray()),a._matrixForMask.setMatrix(this._tmpMatrixForMask.getArray()),a._matrixForDraw.setMatrix(this._tmpMatrixForDraw.getArray()),!e.isUsingHighPrecisionMask()){const d=a._clippingIdCount;for(let g=0;g<d;g++){const c=a._clippingIdList[g];t.getDrawableDynamicFlagVertexPositionsDidChange(c)&&(e.setIsCulling(t.getDrawableCulling(c)!=!1),this._clearedFrameBufferflags[a._bufferIndex]||(this.gl.clearColor(1,1,1,1),this.gl.clear(this.gl.COLOR_BUFFER_BIT),this._clearedFrameBufferflags[a._bufferIndex]=!0),e.setClippingContextBufferForMask(a),e.drawMesh(t.getDrawableTextureIndex(c),t.getDrawableVertexIndexCount(c),t.getDrawableVertexCount(c),t.getDrawableVertexIndices(c),t.getDrawableVertices(c),t.getDrawableVertexUvs(c),t.getMultiplyColor(c),t.getScreenColor(c),t.getDrawableOpacity(c),G.CubismBlendMode_Normal,!1))}}}e.isUsingHighPrecisionMask()||(this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,se),e.setClippingContextBufferForMask(null),this.gl.viewport(et[0],et[1],et[2],et[3]))}}findSameClip(t,e){for(let i=0;i<this._clippingContextListForMask.getSize();i++){const r=this._clippingContextListForMask.at(i),a=r._clippingIdCount;if(a!=e)continue;let o=0;for(let n=0;n<a;n++){const l=r._clippingIdList[n];for(let u=0;u<a;u++)if(t[u]==l){o++;break}}if(o==a)return r}return null}setupLayoutBounds(t){const e=this._renderTextureCount<=1?pa:fa*this._renderTextureCount;if(t<=0||t>e){t>e&&k(`not supported mask count : {0}
[Details] render texture count : {1}, mask count : {2}`,t-e,this._renderTextureCount,t);for(let u=0;u<this._clippingContextListForMask.getSize();u++){const h=this._clippingContextListForMask.at(u);h._layoutChannelNo=0,h._layoutBounds.x=0,h._layoutBounds.y=0,h._layoutBounds.width=1,h._layoutBounds.height=1,h._bufferIndex=0}return}const i=this._renderTextureCount<=1?9:8;let r=t/this._renderTextureCount,a=t%this._renderTextureCount;r=~~r,a=~~a;let o=r/ie,n=r%ie;o=~~o,n=~~n;let l=0;for(let u=0;u<this._renderTextureCount;u++)for(let h=0;h<ie;h++){let m=o+(h<n?1:0);const d=n+1>=ie?0:n+1;if(m<i&&h==d&&(m+=u<a?1:0),m!=0)if(m==1){const g=this._clippingContextListForMask.at(l++);g._layoutChannelNo=h,g._layoutBounds.x=0,g._layoutBounds.y=0,g._layoutBounds.width=1,g._layoutBounds.height=1,g._bufferIndex=u}else if(m==2)for(let g=0;g<m;g++){let c=g%2;c=~~c;const p=this._clippingContextListForMask.at(l++);p._layoutChannelNo=h,p._layoutBounds.x=c*.5,p._layoutBounds.y=0,p._layoutBounds.width=.5,p._layoutBounds.height=1,p._bufferIndex=u}else if(m<=4)for(let g=0;g<m;g++){let c=g%2,p=g/2;c=~~c,p=~~p;const _=this._clippingContextListForMask.at(l++);_._layoutChannelNo=h,_._layoutBounds.x=c*.5,_._layoutBounds.y=p*.5,_._layoutBounds.width=.5,_._layoutBounds.height=.5,_._bufferIndex=u}else if(m<=i)for(let g=0;g<m;g++){let c=g%3,p=g/3;c=~~c,p=~~p;const _=this._clippingContextListForMask.at(l++);_._layoutChannelNo=h,_._layoutBounds.x=c/3,_._layoutBounds.y=p/3,_._layoutBounds.width=1/3,_._layoutBounds.height=1/3,_._bufferIndex=u}else{k(`not supported mask count : {0}
[Details] render texture count : {1}, mask count : {2}`,t-e,this._renderTextureCount,t);for(let g=0;g<m;g++){const c=this._clippingContextListForMask.at(l++);c._layoutChannelNo=0,c._layoutBounds.x=0,c._layoutBounds.y=0,c._layoutBounds.width=1,c._layoutBounds.height=1,c._bufferIndex=0}}}}getColorBuffer(){return this._maskColorBuffers}getClippingContextListForDraw(){return this._clippingContextListForDraw}getClippingMaskCount(){return this._clippingContextListForMask.getSize()}setClippingMaskBufferSize(t){this._clippingMaskBufferSize=t}getClippingMaskBufferSize(){return this._clippingMaskBufferSize}getRenderTextureCount(){return this._renderTextureCount}_currentMaskRenderTexture;_maskRenderTextures;_maskColorBuffers;_currentFrameNo;_channelColors;_maskTexture;_clippingContextListForMask;_clippingContextListForDraw;_clippingMaskBufferSize;_renderTextureCount;_tmpMatrix;_tmpMatrixForMask;_tmpMatrixForDraw;_tmpBoundsOnModel;_clearedFrameBufferflags;gl}class _s{constructor(t,e){this.frameNo=t,this.textures=e}frameNo;textures}class ms{constructor(t,e,i){this._owner=t,this._clippingIdList=e,this._clippingIdCount=i,this._allClippedDrawRect=new ee,this._layoutBounds=new ee,this._clippedDrawableIndexList=[],this._matrixForMask=new E,this._matrixForDraw=new E,this._bufferIndex=0}release(){this._layoutBounds!=null&&(this._layoutBounds=null),this._allClippedDrawRect!=null&&(this._allClippedDrawRect=null),this._clippedDrawableIndexList!=null&&(this._clippedDrawableIndexList=null)}addClippedDrawable(t){this._clippedDrawableIndexList.push(t)}getClippingManager(){return this._owner}setGl(t){this._owner.setGL(t)}_isUsing;_clippingIdList;_clippingIdCount;_layoutChannelNo;_layoutBounds;_allClippedDrawRect;_matrixForMask;_matrixForDraw;_clippedDrawableIndexList;_bufferIndex;_owner}class Sa{setGlEnable(t,e){e?this.gl.enable(t):this.gl.disable(t)}setGlEnableVertexAttribArray(t,e){e?this.gl.enableVertexAttribArray(t):this.gl.disableVertexAttribArray(t)}save(){if(this.gl==null){k(`'gl' is null. WebGLRenderingContext is required.
Please call 'CubimRenderer_WebGL.startUp' function.`);return}this._lastArrayBufferBinding=this.gl.getParameter(this.gl.ARRAY_BUFFER_BINDING),this._lastElementArrayBufferBinding=this.gl.getParameter(this.gl.ELEMENT_ARRAY_BUFFER_BINDING),this._lastProgram=this.gl.getParameter(this.gl.CURRENT_PROGRAM),this._lastActiveTexture=this.gl.getParameter(this.gl.ACTIVE_TEXTURE),this.gl.activeTexture(this.gl.TEXTURE1),this._lastTexture1Binding2D=this.gl.getParameter(this.gl.TEXTURE_BINDING_2D),this.gl.activeTexture(this.gl.TEXTURE0),this._lastTexture0Binding2D=this.gl.getParameter(this.gl.TEXTURE_BINDING_2D),this._lastVertexAttribArrayEnabled[0]=this.gl.getVertexAttrib(0,this.gl.VERTEX_ATTRIB_ARRAY_ENABLED),this._lastVertexAttribArrayEnabled[1]=this.gl.getVertexAttrib(1,this.gl.VERTEX_ATTRIB_ARRAY_ENABLED),this._lastVertexAttribArrayEnabled[2]=this.gl.getVertexAttrib(2,this.gl.VERTEX_ATTRIB_ARRAY_ENABLED),this._lastVertexAttribArrayEnabled[3]=this.gl.getVertexAttrib(3,this.gl.VERTEX_ATTRIB_ARRAY_ENABLED),this._lastScissorTest=this.gl.isEnabled(this.gl.SCISSOR_TEST),this._lastStencilTest=this.gl.isEnabled(this.gl.STENCIL_TEST),this._lastDepthTest=this.gl.isEnabled(this.gl.DEPTH_TEST),this._lastCullFace=this.gl.isEnabled(this.gl.CULL_FACE),this._lastBlend=this.gl.isEnabled(this.gl.BLEND),this._lastFrontFace=this.gl.getParameter(this.gl.FRONT_FACE),this._lastColorMask=this.gl.getParameter(this.gl.COLOR_WRITEMASK),this._lastBlending[0]=this.gl.getParameter(this.gl.BLEND_SRC_RGB),this._lastBlending[1]=this.gl.getParameter(this.gl.BLEND_DST_RGB),this._lastBlending[2]=this.gl.getParameter(this.gl.BLEND_SRC_ALPHA),this._lastBlending[3]=this.gl.getParameter(this.gl.BLEND_DST_ALPHA),this._lastFBO=this.gl.getParameter(this.gl.FRAMEBUFFER_BINDING),this._lastViewport=this.gl.getParameter(this.gl.VIEWPORT)}restore(){if(this.gl==null){k(`'gl' is null. WebGLRenderingContext is required.
Please call 'CubimRenderer_WebGL.startUp' function.`);return}this.gl.useProgram(this._lastProgram),this.setGlEnableVertexAttribArray(0,this._lastVertexAttribArrayEnabled[0]),this.setGlEnableVertexAttribArray(1,this._lastVertexAttribArrayEnabled[1]),this.setGlEnableVertexAttribArray(2,this._lastVertexAttribArrayEnabled[2]),this.setGlEnableVertexAttribArray(3,this._lastVertexAttribArrayEnabled[3]),this.setGlEnable(this.gl.SCISSOR_TEST,this._lastScissorTest),this.setGlEnable(this.gl.STENCIL_TEST,this._lastStencilTest),this.setGlEnable(this.gl.DEPTH_TEST,this._lastDepthTest),this.setGlEnable(this.gl.CULL_FACE,this._lastCullFace),this.setGlEnable(this.gl.BLEND,this._lastBlend),this.gl.frontFace(this._lastFrontFace),this.gl.colorMask(this._lastColorMask[0],this._lastColorMask[1],this._lastColorMask[2],this._lastColorMask[3]),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this._lastArrayBufferBinding),this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER,this._lastElementArrayBufferBinding),this.gl.activeTexture(this.gl.TEXTURE1),this.gl.bindTexture(this.gl.TEXTURE_2D,this._lastTexture1Binding2D),this.gl.activeTexture(this.gl.TEXTURE0),this.gl.bindTexture(this.gl.TEXTURE_2D,this._lastTexture0Binding2D),this.gl.activeTexture(this._lastActiveTexture),this.gl.blendFuncSeparate(this._lastBlending[0],this._lastBlending[1],this._lastBlending[2],this._lastBlending[3])}setGl(t){this.gl=t}constructor(){this._lastVertexAttribArrayEnabled=new Array(4),this._lastColorMask=new Array(4),this._lastBlending=new Array(4),this._lastViewport=new Array(4)}_lastArrayBufferBinding;_lastElementArrayBufferBinding;_lastProgram;_lastActiveTexture;_lastTexture0Binding2D;_lastTexture1Binding2D;_lastVertexAttribArrayEnabled;_lastScissorTest;_lastBlend;_lastStencilTest;_lastDepthTest;_lastCullFace;_lastFrontFace;_lastColorMask;_lastBlending;_lastFBO;_lastViewport;gl}class Tt{static getInstance(){return _t==null&&(_t=new Tt),_t}static deleteInstance(){_t&&(_t.release(),_t=null)}constructor(){this._shaderSets=new x}release(){this.releaseShaderProgram()}setupShaderProgram(t,e,i,r,a,o,n,l,u,h,m,d,g,c,p){g||k("NoPremultipliedAlpha is not allowed"),this._shaderSets.getSize()==0&&this.generateShaders();let _,B,P,y;if(t.getClippingContextBufferForMask()!=null){const f=this._shaderSets.at(0);this.gl.useProgram(f.shaderProgram),this.gl.activeTexture(this.gl.TEXTURE0),this.gl.bindTexture(this.gl.TEXTURE_2D,e),this.gl.uniform1i(f.samplerTexture0Location,0),n.vertex==null&&(n.vertex=this.gl.createBuffer()),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,n.vertex),this.gl.bufferData(this.gl.ARRAY_BUFFER,r,this.gl.DYNAMIC_DRAW),this.gl.enableVertexAttribArray(f.attributePositionLocation),this.gl.vertexAttribPointer(f.attributePositionLocation,2,this.gl.FLOAT,!1,0,0),n.uv==null&&(n.uv=this.gl.createBuffer()),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,n.uv),this.gl.bufferData(this.gl.ARRAY_BUFFER,o,this.gl.DYNAMIC_DRAW),this.gl.enableVertexAttribArray(f.attributeTexCoordLocation),this.gl.vertexAttribPointer(f.attributeTexCoordLocation,2,this.gl.FLOAT,!1,0,0);const T=t.getClippingContextBufferForMask()._layoutChannelNo,b=t.getClippingContextBufferForMask().getClippingManager().getChannelFlagAsColor(T);this.gl.uniform4f(f.uniformChannelFlagLocation,b.R,b.G,b.B,b.A),this.gl.uniformMatrix4fv(f.uniformClipMatrixLocation,!1,t.getClippingContextBufferForMask()._matrixForMask.getArray());const D=t.getClippingContextBufferForMask()._layoutBounds;this.gl.uniform4f(f.uniformBaseColorLocation,D.x*2-1,D.y*2-1,D.getRight()*2-1,D.getBottom()*2-1),this.gl.uniform4f(f.uniformMultiplyColorLocation,m.R,m.G,m.B,m.A),this.gl.uniform4f(f.uniformScreenColorLocation,d.R,d.G,d.B,d.A),_=this.gl.ZERO,B=this.gl.ONE_MINUS_SRC_COLOR,P=this.gl.ZERO,y=this.gl.ONE_MINUS_SRC_ALPHA}else{const f=t.getClippingContextBufferForDraw()!=null,T=f?p?2:1:0;let b=new Ve;switch(u){case G.CubismBlendMode_Normal:default:b=this._shaderSets.at(1+T),_=this.gl.ONE,B=this.gl.ONE_MINUS_SRC_ALPHA,P=this.gl.ONE,y=this.gl.ONE_MINUS_SRC_ALPHA;break;case G.CubismBlendMode_Additive:b=this._shaderSets.at(4+T),_=this.gl.ONE,B=this.gl.ONE,P=this.gl.ZERO,y=this.gl.ONE;break;case G.CubismBlendMode_Multiplicative:b=this._shaderSets.at(7+T),_=this.gl.DST_COLOR,B=this.gl.ONE_MINUS_SRC_ALPHA,P=this.gl.ZERO,y=this.gl.ONE;break}if(this.gl.useProgram(b.shaderProgram),n.vertex==null&&(n.vertex=this.gl.createBuffer()),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,n.vertex),this.gl.bufferData(this.gl.ARRAY_BUFFER,r,this.gl.DYNAMIC_DRAW),this.gl.enableVertexAttribArray(b.attributePositionLocation),this.gl.vertexAttribPointer(b.attributePositionLocation,2,this.gl.FLOAT,!1,0,0),n.uv==null&&(n.uv=this.gl.createBuffer()),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,n.uv),this.gl.bufferData(this.gl.ARRAY_BUFFER,o,this.gl.DYNAMIC_DRAW),this.gl.enableVertexAttribArray(b.attributeTexCoordLocation),this.gl.vertexAttribPointer(b.attributeTexCoordLocation,2,this.gl.FLOAT,!1,0,0),f){this.gl.activeTexture(this.gl.TEXTURE1);const D=t.getClippingContextBufferForDraw().getClippingManager().getColorBuffer().at(t.getClippingContextBufferForDraw()._bufferIndex);this.gl.bindTexture(this.gl.TEXTURE_2D,D),this.gl.uniform1i(b.samplerTexture1Location,1),this.gl.uniformMatrix4fv(b.uniformClipMatrixLocation,!1,t.getClippingContextBufferForDraw()._matrixForDraw.getArray());const it=t.getClippingContextBufferForDraw()._layoutChannelNo,J=t.getClippingContextBufferForDraw().getClippingManager().getChannelFlagAsColor(it);this.gl.uniform4f(b.uniformChannelFlagLocation,J.R,J.G,J.B,J.A)}this.gl.activeTexture(this.gl.TEXTURE0),this.gl.bindTexture(this.gl.TEXTURE_2D,e),this.gl.uniform1i(b.samplerTexture0Location,0),this.gl.uniformMatrix4fv(b.uniformMatrixLocation,!1,c.getArray()),this.gl.uniform4f(b.uniformBaseColorLocation,h.R,h.G,h.B,h.A),this.gl.uniform4f(b.uniformMultiplyColorLocation,m.R,m.G,m.B,m.A),this.gl.uniform4f(b.uniformScreenColorLocation,d.R,d.G,d.B,d.A)}n.index==null&&(n.index=this.gl.createBuffer()),this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER,n.index),this.gl.bufferData(this.gl.ELEMENT_ARRAY_BUFFER,a,this.gl.DYNAMIC_DRAW),this.gl.blendFuncSeparate(_,B,P,y)}releaseShaderProgram(){for(let t=0;t<this._shaderSets.getSize();t++)this.gl.deleteProgram(this._shaderSets.at(t).shaderProgram),this._shaderSets.at(t).shaderProgram=0,this._shaderSets.set(t,void 0),this._shaderSets.set(t,null)}generateShaders(){for(let t=0;t<ya;t++)this._shaderSets.pushBack(new Ve);this._shaderSets.at(0).shaderProgram=this.loadShaderProgram(xa,Ca),this._shaderSets.at(1).shaderProgram=this.loadShaderProgram(Ba,Ma),this._shaderSets.at(2).shaderProgram=this.loadShaderProgram(fs,Pa),this._shaderSets.at(3).shaderProgram=this.loadShaderProgram(fs,va),this._shaderSets.at(4).shaderProgram=this._shaderSets.at(1).shaderProgram,this._shaderSets.at(5).shaderProgram=this._shaderSets.at(2).shaderProgram,this._shaderSets.at(6).shaderProgram=this._shaderSets.at(3).shaderProgram,this._shaderSets.at(7).shaderProgram=this._shaderSets.at(1).shaderProgram,this._shaderSets.at(8).shaderProgram=this._shaderSets.at(2).shaderProgram,this._shaderSets.at(9).shaderProgram=this._shaderSets.at(3).shaderProgram,this._shaderSets.at(0).attributePositionLocation=this.gl.getAttribLocation(this._shaderSets.at(0).shaderProgram,"a_position"),this._shaderSets.at(0).attributeTexCoordLocation=this.gl.getAttribLocation(this._shaderSets.at(0).shaderProgram,"a_texCoord"),this._shaderSets.at(0).samplerTexture0Location=this.gl.getUniformLocation(this._shaderSets.at(0).shaderProgram,"s_texture0"),this._shaderSets.at(0).uniformClipMatrixLocation=this.gl.getUniformLocation(this._shaderSets.at(0).shaderProgram,"u_clipMatrix"),this._shaderSets.at(0).uniformChannelFlagLocation=this.gl.getUniformLocation(this._shaderSets.at(0).shaderProgram,"u_channelFlag"),this._shaderSets.at(0).uniformBaseColorLocation=this.gl.getUniformLocation(this._shaderSets.at(0).shaderProgram,"u_baseColor"),this._shaderSets.at(0).uniformMultiplyColorLocation=this.gl.getUniformLocation(this._shaderSets.at(0).shaderProgram,"u_multiplyColor"),this._shaderSets.at(0).uniformScreenColorLocation=this.gl.getUniformLocation(this._shaderSets.at(0).shaderProgram,"u_screenColor"),this._shaderSets.at(1).attributePositionLocation=this.gl.getAttribLocation(this._shaderSets.at(1).shaderProgram,"a_position"),this._shaderSets.at(1).attributeTexCoordLocation=this.gl.getAttribLocation(this._shaderSets.at(1).shaderProgram,"a_texCoord"),this._shaderSets.at(1).samplerTexture0Location=this.gl.getUniformLocation(this._shaderSets.at(1).shaderProgram,"s_texture0"),this._shaderSets.at(1).uniformMatrixLocation=this.gl.getUniformLocation(this._shaderSets.at(1).shaderProgram,"u_matrix"),this._shaderSets.at(1).uniformBaseColorLocation=this.gl.getUniformLocation(this._shaderSets.at(1).shaderProgram,"u_baseColor"),this._shaderSets.at(1).uniformMultiplyColorLocation=this.gl.getUniformLocation(this._shaderSets.at(1).shaderProgram,"u_multiplyColor"),this._shaderSets.at(1).uniformScreenColorLocation=this.gl.getUniformLocation(this._shaderSets.at(1).shaderProgram,"u_screenColor"),this._shaderSets.at(2).attributePositionLocation=this.gl.getAttribLocation(this._shaderSets.at(2).shaderProgram,"a_position"),this._shaderSets.at(2).attributeTexCoordLocation=this.gl.getAttribLocation(this._shaderSets.at(2).shaderProgram,"a_texCoord"),this._shaderSets.at(2).samplerTexture0Location=this.gl.getUniformLocation(this._shaderSets.at(2).shaderProgram,"s_texture0"),this._shaderSets.at(2).samplerTexture1Location=this.gl.getUniformLocation(this._shaderSets.at(2).shaderProgram,"s_texture1"),this._shaderSets.at(2).uniformMatrixLocation=this.gl.getUniformLocation(this._shaderSets.at(2).shaderProgram,"u_matrix"),this._shaderSets.at(2).uniformClipMatrixLocation=this.gl.getUniformLocation(this._shaderSets.at(2).shaderProgram,"u_clipMatrix"),this._shaderSets.at(2).uniformChannelFlagLocation=this.gl.getUniformLocation(this._shaderSets.at(2).shaderProgram,"u_channelFlag"),this._shaderSets.at(2).uniformBaseColorLocation=this.gl.getUniformLocation(this._shaderSets.at(2).shaderProgram,"u_baseColor"),this._shaderSets.at(2).uniformMultiplyColorLocation=this.gl.getUniformLocation(this._shaderSets.at(2).shaderProgram,"u_multiplyColor"),this._shaderSets.at(2).uniformScreenColorLocation=this.gl.getUniformLocation(this._shaderSets.at(2).shaderProgram,"u_screenColor"),this._shaderSets.at(3).attributePositionLocation=this.gl.getAttribLocation(this._shaderSets.at(3).shaderProgram,"a_position"),this._shaderSets.at(3).attributeTexCoordLocation=this.gl.getAttribLocation(this._shaderSets.at(3).shaderProgram,"a_texCoord"),this._shaderSets.at(3).samplerTexture0Location=this.gl.getUniformLocation(this._shaderSets.at(3).shaderProgram,"s_texture0"),this._shaderSets.at(3).samplerTexture1Location=this.gl.getUniformLocation(this._shaderSets.at(3).shaderProgram,"s_texture1"),this._shaderSets.at(3).uniformMatrixLocation=this.gl.getUniformLocation(this._shaderSets.at(3).shaderProgram,"u_matrix"),this._shaderSets.at(3).uniformClipMatrixLocation=this.gl.getUniformLocation(this._shaderSets.at(3).shaderProgram,"u_clipMatrix"),this._shaderSets.at(3).uniformChannelFlagLocation=this.gl.getUniformLocation(this._shaderSets.at(3).shaderProgram,"u_channelFlag"),this._shaderSets.at(3).uniformBaseColorLocation=this.gl.getUniformLocation(this._shaderSets.at(3).shaderProgram,"u_baseColor"),this._shaderSets.at(3).uniformMultiplyColorLocation=this.gl.getUniformLocation(this._shaderSets.at(3).shaderProgram,"u_multiplyColor"),this._shaderSets.at(3).uniformScreenColorLocation=this.gl.getUniformLocation(this._shaderSets.at(3).shaderProgram,"u_screenColor"),this._shaderSets.at(4).attributePositionLocation=this.gl.getAttribLocation(this._shaderSets.at(4).shaderProgram,"a_position"),this._shaderSets.at(4).attributeTexCoordLocation=this.gl.getAttribLocation(this._shaderSets.at(4).shaderProgram,"a_texCoord"),this._shaderSets.at(4).samplerTexture0Location=this.gl.getUniformLocation(this._shaderSets.at(4).shaderProgram,"s_texture0"),this._shaderSets.at(4).uniformMatrixLocation=this.gl.getUniformLocation(this._shaderSets.at(4).shaderProgram,"u_matrix"),this._shaderSets.at(4).uniformBaseColorLocation=this.gl.getUniformLocation(this._shaderSets.at(4).shaderProgram,"u_baseColor"),this._shaderSets.at(4).uniformMultiplyColorLocation=this.gl.getUniformLocation(this._shaderSets.at(4).shaderProgram,"u_multiplyColor"),this._shaderSets.at(4).uniformScreenColorLocation=this.gl.getUniformLocation(this._shaderSets.at(4).shaderProgram,"u_screenColor"),this._shaderSets.at(5).attributePositionLocation=this.gl.getAttribLocation(this._shaderSets.at(5).shaderProgram,"a_position"),this._shaderSets.at(5).attributeTexCoordLocation=this.gl.getAttribLocation(this._shaderSets.at(5).shaderProgram,"a_texCoord"),this._shaderSets.at(5).samplerTexture0Location=this.gl.getUniformLocation(this._shaderSets.at(5).shaderProgram,"s_texture0"),this._shaderSets.at(5).samplerTexture1Location=this.gl.getUniformLocation(this._shaderSets.at(5).shaderProgram,"s_texture1"),this._shaderSets.at(5).uniformMatrixLocation=this.gl.getUniformLocation(this._shaderSets.at(5).shaderProgram,"u_matrix"),this._shaderSets.at(5).uniformClipMatrixLocation=this.gl.getUniformLocation(this._shaderSets.at(5).shaderProgram,"u_clipMatrix"),this._shaderSets.at(5).uniformChannelFlagLocation=this.gl.getUniformLocation(this._shaderSets.at(5).shaderProgram,"u_channelFlag"),this._shaderSets.at(5).uniformBaseColorLocation=this.gl.getUniformLocation(this._shaderSets.at(5).shaderProgram,"u_baseColor"),this._shaderSets.at(5).uniformMultiplyColorLocation=this.gl.getUniformLocation(this._shaderSets.at(5).shaderProgram,"u_multiplyColor"),this._shaderSets.at(5).uniformScreenColorLocation=this.gl.getUniformLocation(this._shaderSets.at(5).shaderProgram,"u_screenColor"),this._shaderSets.at(6).attributePositionLocation=this.gl.getAttribLocation(this._shaderSets.at(6).shaderProgram,"a_position"),this._shaderSets.at(6).attributeTexCoordLocation=this.gl.getAttribLocation(this._shaderSets.at(6).shaderProgram,"a_texCoord"),this._shaderSets.at(6).samplerTexture0Location=this.gl.getUniformLocation(this._shaderSets.at(6).shaderProgram,"s_texture0"),this._shaderSets.at(6).samplerTexture1Location=this.gl.getUniformLocation(this._shaderSets.at(6).shaderProgram,"s_texture1"),this._shaderSets.at(6).uniformMatrixLocation=this.gl.getUniformLocation(this._shaderSets.at(6).shaderProgram,"u_matrix"),this._shaderSets.at(6).uniformClipMatrixLocation=this.gl.getUniformLocation(this._shaderSets.at(6).shaderProgram,"u_clipMatrix"),this._shaderSets.at(6).uniformChannelFlagLocation=this.gl.getUniformLocation(this._shaderSets.at(6).shaderProgram,"u_channelFlag"),this._shaderSets.at(6).uniformBaseColorLocation=this.gl.getUniformLocation(this._shaderSets.at(6).shaderProgram,"u_baseColor"),this._shaderSets.at(6).uniformMultiplyColorLocation=this.gl.getUniformLocation(this._shaderSets.at(6).shaderProgram,"u_multiplyColor"),this._shaderSets.at(6).uniformScreenColorLocation=this.gl.getUniformLocation(this._shaderSets.at(6).shaderProgram,"u_screenColor"),this._shaderSets.at(7).attributePositionLocation=this.gl.getAttribLocation(this._shaderSets.at(7).shaderProgram,"a_position"),this._shaderSets.at(7).attributeTexCoordLocation=this.gl.getAttribLocation(this._shaderSets.at(7).shaderProgram,"a_texCoord"),this._shaderSets.at(7).samplerTexture0Location=this.gl.getUniformLocation(this._shaderSets.at(7).shaderProgram,"s_texture0"),this._shaderSets.at(7).uniformMatrixLocation=this.gl.getUniformLocation(this._shaderSets.at(7).shaderProgram,"u_matrix"),this._shaderSets.at(7).uniformBaseColorLocation=this.gl.getUniformLocation(this._shaderSets.at(7).shaderProgram,"u_baseColor"),this._shaderSets.at(7).uniformMultiplyColorLocation=this.gl.getUniformLocation(this._shaderSets.at(7).shaderProgram,"u_multiplyColor"),this._shaderSets.at(7).uniformScreenColorLocation=this.gl.getUniformLocation(this._shaderSets.at(7).shaderProgram,"u_screenColor"),this._shaderSets.at(8).attributePositionLocation=this.gl.getAttribLocation(this._shaderSets.at(8).shaderProgram,"a_position"),this._shaderSets.at(8).attributeTexCoordLocation=this.gl.getAttribLocation(this._shaderSets.at(8).shaderProgram,"a_texCoord"),this._shaderSets.at(8).samplerTexture0Location=this.gl.getUniformLocation(this._shaderSets.at(8).shaderProgram,"s_texture0"),this._shaderSets.at(8).samplerTexture1Location=this.gl.getUniformLocation(this._shaderSets.at(8).shaderProgram,"s_texture1"),this._shaderSets.at(8).uniformMatrixLocation=this.gl.getUniformLocation(this._shaderSets.at(8).shaderProgram,"u_matrix"),this._shaderSets.at(8).uniformClipMatrixLocation=this.gl.getUniformLocation(this._shaderSets.at(8).shaderProgram,"u_clipMatrix"),this._shaderSets.at(8).uniformChannelFlagLocation=this.gl.getUniformLocation(this._shaderSets.at(8).shaderProgram,"u_channelFlag"),this._shaderSets.at(8).uniformBaseColorLocation=this.gl.getUniformLocation(this._shaderSets.at(8).shaderProgram,"u_baseColor"),this._shaderSets.at(8).uniformMultiplyColorLocation=this.gl.getUniformLocation(this._shaderSets.at(8).shaderProgram,"u_multiplyColor"),this._shaderSets.at(8).uniformScreenColorLocation=this.gl.getUniformLocation(this._shaderSets.at(8).shaderProgram,"u_screenColor"),this._shaderSets.at(9).attributePositionLocation=this.gl.getAttribLocation(this._shaderSets.at(9).shaderProgram,"a_position"),this._shaderSets.at(9).attributeTexCoordLocation=this.gl.getAttribLocation(this._shaderSets.at(9).shaderProgram,"a_texCoord"),this._shaderSets.at(9).samplerTexture0Location=this.gl.getUniformLocation(this._shaderSets.at(9).shaderProgram,"s_texture0"),this._shaderSets.at(9).samplerTexture1Location=this.gl.getUniformLocation(this._shaderSets.at(9).shaderProgram,"s_texture1"),this._shaderSets.at(9).uniformMatrixLocation=this.gl.getUniformLocation(this._shaderSets.at(9).shaderProgram,"u_matrix"),this._shaderSets.at(9).uniformClipMatrixLocation=this.gl.getUniformLocation(this._shaderSets.at(9).shaderProgram,"u_clipMatrix"),this._shaderSets.at(9).uniformChannelFlagLocation=this.gl.getUniformLocation(this._shaderSets.at(9).shaderProgram,"u_channelFlag"),this._shaderSets.at(9).uniformBaseColorLocation=this.gl.getUniformLocation(this._shaderSets.at(9).shaderProgram,"u_baseColor"),this._shaderSets.at(9).uniformMultiplyColorLocation=this.gl.getUniformLocation(this._shaderSets.at(9).shaderProgram,"u_multiplyColor"),this._shaderSets.at(9).uniformScreenColorLocation=this.gl.getUniformLocation(this._shaderSets.at(9).shaderProgram,"u_screenColor")}loadShaderProgram(t,e){let i=this.gl.createProgram(),r=this.compileShaderSource(this.gl.VERTEX_SHADER,t);if(!r)return k("Vertex shader compile error!"),0;let a=this.compileShaderSource(this.gl.FRAGMENT_SHADER,e);return a?(this.gl.attachShader(i,r),this.gl.attachShader(i,a),this.gl.linkProgram(i),this.gl.getProgramParameter(i,this.gl.LINK_STATUS)?(this.gl.deleteShader(r),this.gl.deleteShader(a),i):(k("Failed to link program: {0}",i),this.gl.deleteShader(r),r=0,this.gl.deleteShader(a),a=0,i&&(this.gl.deleteProgram(i),i=0),0)):(k("Vertex shader compile error!"),0)}compileShaderSource(t,e){const i=e,r=this.gl.createShader(t);if(this.gl.shaderSource(r,i),this.gl.compileShader(r),!r){const o=this.gl.getShaderInfoLog(r);k("Shader compile log: {0} ",o)}return this.gl.getShaderParameter(r,this.gl.COMPILE_STATUS)?r:(this.gl.deleteShader(r),null)}setGl(t){this.gl=t}_shaderSets;gl}class Ve{shaderProgram;attributePositionLocation;attributeTexCoordLocation;uniformMatrixLocation;uniformClipMatrixLocation;samplerTexture0Location;samplerTexture1Location;uniformBaseColorLocation;uniformChannelFlagLocation;uniformMultiplyColorLocation;uniformScreenColorLocation}var ps=(s=>(s[s.ShaderNames_SetupMask=0]="ShaderNames_SetupMask",s[s.ShaderNames_NormalPremultipliedAlpha=1]="ShaderNames_NormalPremultipliedAlpha",s[s.ShaderNames_NormalMaskedPremultipliedAlpha=2]="ShaderNames_NormalMaskedPremultipliedAlpha",s[s.ShaderNames_NomralMaskedInvertedPremultipliedAlpha=3]="ShaderNames_NomralMaskedInvertedPremultipliedAlpha",s[s.ShaderNames_AddPremultipliedAlpha=4]="ShaderNames_AddPremultipliedAlpha",s[s.ShaderNames_AddMaskedPremultipliedAlpha=5]="ShaderNames_AddMaskedPremultipliedAlpha",s[s.ShaderNames_AddMaskedPremultipliedAlphaInverted=6]="ShaderNames_AddMaskedPremultipliedAlphaInverted",s[s.ShaderNames_MultPremultipliedAlpha=7]="ShaderNames_MultPremultipliedAlpha",s[s.ShaderNames_MultMaskedPremultipliedAlpha=8]="ShaderNames_MultMaskedPremultipliedAlpha",s[s.ShaderNames_MultMaskedPremultipliedAlphaInverted=9]="ShaderNames_MultMaskedPremultipliedAlphaInverted",s))(ps||{});const xa="attribute vec4     a_position;attribute vec2     a_texCoord;varying vec2       v_texCoord;varying vec4       v_myPos;uniform mat4       u_clipMatrix;void main(){   gl_Position = u_clipMatrix * a_position;   v_myPos = u_clipMatrix * a_position;   v_texCoord = a_texCoord;   v_texCoord.y = 1.0 - v_texCoord.y;}",Ca="precision mediump float;varying vec2       v_texCoord;varying vec4       v_myPos;uniform vec4       u_baseColor;uniform vec4       u_channelFlag;uniform sampler2D  s_texture0;void main(){   float isInside =        step(u_baseColor.x, v_myPos.x/v_myPos.w)       * step(u_baseColor.y, v_myPos.y/v_myPos.w)       * step(v_myPos.x/v_myPos.w, u_baseColor.z)       * step(v_myPos.y/v_myPos.w, u_baseColor.w);   gl_FragColor = u_channelFlag * texture2D(s_texture0, v_texCoord).a * isInside;}",Ba="attribute vec4     a_position;attribute vec2     a_texCoord;varying vec2       v_texCoord;uniform mat4       u_matrix;void main(){   gl_Position = u_matrix * a_position;   v_texCoord = a_texCoord;   v_texCoord.y = 1.0 - v_texCoord.y;}",fs="attribute vec4     a_position;attribute vec2     a_texCoord;varying vec2       v_texCoord;varying vec4       v_clipPos;uniform mat4       u_matrix;uniform mat4       u_clipMatrix;void main(){   gl_Position = u_matrix * a_position;   v_clipPos = u_clipMatrix * a_position;   v_texCoord = a_texCoord;   v_texCoord.y = 1.0 - v_texCoord.y;}",Ma="precision mediump float;varying vec2       v_texCoord;uniform vec4       u_baseColor;uniform sampler2D  s_texture0;uniform vec4       u_multiplyColor;uniform vec4       u_screenColor;void main(){   vec4 texColor = texture2D(s_texture0, v_texCoord);   texColor.rgb = texColor.rgb * u_multiplyColor.rgb;   texColor.rgb = (texColor.rgb + u_screenColor.rgb * texColor.a) - (texColor.rgb * u_screenColor.rgb);   vec4 color = texColor * u_baseColor;   gl_FragColor = vec4(color.rgb, color.a);}",Pa="precision mediump float;varying vec2       v_texCoord;varying vec4       v_clipPos;uniform vec4       u_baseColor;uniform vec4       u_channelFlag;uniform sampler2D  s_texture0;uniform sampler2D  s_texture1;uniform vec4       u_multiplyColor;uniform vec4       u_screenColor;void main(){   vec4 texColor = texture2D(s_texture0, v_texCoord);   texColor.rgb = texColor.rgb * u_multiplyColor.rgb;   texColor.rgb = (texColor.rgb + u_screenColor.rgb * texColor.a) - (texColor.rgb * u_screenColor.rgb);   vec4 col_formask = texColor * u_baseColor;   vec4 clipMask = (1.0 - texture2D(s_texture1, v_clipPos.xy / v_clipPos.w)) * u_channelFlag;   float maskVal = clipMask.r + clipMask.g + clipMask.b + clipMask.a;   col_formask = col_formask * maskVal;   gl_FragColor = col_formask;}",va="precision mediump float;varying vec2      v_texCoord;varying vec4      v_clipPos;uniform sampler2D s_texture0;uniform sampler2D s_texture1;uniform vec4      u_channelFlag;uniform vec4      u_baseColor;uniform vec4      u_multiplyColor;uniform vec4      u_screenColor;void main(){   vec4 texColor = texture2D(s_texture0, v_texCoord);   texColor.rgb = texColor.rgb * u_multiplyColor.rgb;   texColor.rgb = (texColor.rgb + u_screenColor.rgb * texColor.a) - (texColor.rgb * u_screenColor.rgb);   vec4 col_formask = texColor * u_baseColor;   vec4 clipMask = (1.0 - texture2D(s_texture1, v_clipPos.xy / v_clipPos.w)) * u_channelFlag;   float maskVal = clipMask.r + clipMask.g + clipMask.b + clipMask.a;   col_formask = col_formask * (1.0 - maskVal);   gl_FragColor = col_formask;}";class we extends Gt{initialize(t,e=1){t.isUsingMasking()&&(this._clippingManager=new Te,this._clippingManager.initialize(t,t.getDrawableCount(),t.getDrawableMasks(),t.getDrawableMaskCounts(),e)),this._sortedDrawableIndexList.resize(t.getDrawableCount(),0),super.initialize(t)}bindTexture(t,e){this._textures.setValue(t,e)}getBindedTextures(){return this._textures}setClippingMaskBufferSize(t){if(!this._model.isUsingMasking())return;const e=this._clippingManager.getRenderTextureCount();this._clippingManager.release(),this._clippingManager=void 0,this._clippingManager=null,this._clippingManager=new Te,this._clippingManager.setClippingMaskBufferSize(t),this._clippingManager.initialize(this.getModel(),this.getModel().getDrawableCount(),this.getModel().getDrawableMasks(),this.getModel().getDrawableMaskCounts(),e)}getClippingMaskBufferSize(){return this._model.isUsingMasking()?this._clippingManager.getClippingMaskBufferSize():-1}getRenderTextureCount(){return this._model.isUsingMasking()?this._clippingManager.getRenderTextureCount():-1}constructor(){super(),this._clippingContextBufferForMask=null,this._clippingContextBufferForDraw=null,this._rendererProfile=new Sa,this.firstDraw=!0,this._textures=new O,this._sortedDrawableIndexList=new x,this._bufferData={vertex:WebGLBuffer=null,uv:WebGLBuffer=null,index:WebGLBuffer=null},this._textures.prepareCapacity(32,!0)}release(){this._clippingManager&&(this._clippingManager.release(),this._clippingManager=void 0,this._clippingManager=null),this.gl!=null&&(this.gl.deleteBuffer(this._bufferData.vertex),this._bufferData.vertex=null,this.gl.deleteBuffer(this._bufferData.uv),this._bufferData.uv=null,this.gl.deleteBuffer(this._bufferData.index),this._bufferData.index=null,this._bufferData=null,this._textures=null)}doDrawModel(){if(this.gl==null){k(`'gl' is null. WebGLRenderingContext is required.
Please call 'CubimRenderer_WebGL.startUp' function.`);return}this._clippingManager!=null&&(this.preDraw(),this._clippingManager.setupClippingContext(this.getModel(),this)),this.preDraw();const t=this.getModel().getDrawableCount(),e=this.getModel().getDrawableRenderOrders();for(let i=0;i<t;++i){const r=e[i];this._sortedDrawableIndexList.set(r,i)}for(let i=0;i<t;++i){const r=this._sortedDrawableIndexList.at(i);if(!this.getModel().getDrawableDynamicFlagIsVisible(r))continue;const a=this._clippingManager!=null?this._clippingManager.getClippingContextListForDraw().at(r):null;if(a!=null&&this.isUsingHighPrecisionMask()){a._isUsing&&(this.gl.viewport(0,0,this._clippingManager.getClippingMaskBufferSize(),this._clippingManager.getClippingMaskBufferSize()),this.preDraw(),this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,a.getClippingManager().getMaskRenderTexture().at(a._bufferIndex)),this.gl.clearColor(1,1,1,1),this.gl.clear(this.gl.COLOR_BUFFER_BIT));{const o=a._clippingIdCount;for(let n=0;n<o;n++){const l=a._clippingIdList[n];this._model.getDrawableDynamicFlagVertexPositionsDidChange(l)&&(this.setIsCulling(this._model.getDrawableCulling(l)!=!1),this.setClippingContextBufferForMask(a),this.drawMesh(this.getModel().getDrawableTextureIndex(l),this.getModel().getDrawableVertexIndexCount(l),this.getModel().getDrawableVertexCount(l),this.getModel().getDrawableVertexIndices(l),this.getModel().getDrawableVertices(l),this.getModel().getDrawableVertexUvs(l),this.getModel().getMultiplyColor(l),this.getModel().getScreenColor(l),this.getModel().getDrawableOpacity(l),G.CubismBlendMode_Normal,!1))}}this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,se),this.setClippingContextBufferForMask(null),this.gl.viewport(et[0],et[1],et[2],et[3]),this.preDraw()}this.setClippingContextBufferForDraw(a),this.setIsCulling(this.getModel().getDrawableCulling(r)),this.drawMesh(this.getModel().getDrawableTextureIndex(r),this.getModel().getDrawableVertexIndexCount(r),this.getModel().getDrawableVertexCount(r),this.getModel().getDrawableVertexIndices(r),this.getModel().getDrawableVertices(r),this.getModel().getDrawableVertexUvs(r),this.getModel().getMultiplyColor(r),this.getModel().getScreenColor(r),this.getModel().getDrawableOpacity(r),this.getModel().getDrawableBlendMode(r),this.getModel().getDrawableInvertedMaskBit(r))}}drawMesh(t,e,i,r,a,o,n,l,u,h,m){this.isCulling()?this.gl.enable(this.gl.CULL_FACE):this.gl.disable(this.gl.CULL_FACE),this.gl.frontFace(this.gl.CCW);const d=this.getModelColor();this.getClippingContextBufferForMask()==null&&(d.A*=u,this.isPremultipliedAlpha()&&(d.R*=d.A,d.G*=d.A,d.B*=d.A));let g;this._textures.getValue(t)!=null?g=this._textures.getValue(t):g=null,Tt.getInstance().setupShaderProgram(this,g,i,a,r,o,this._bufferData,u,h,d,n,l,this.isPremultipliedAlpha(),this.getMvpMatrix(),m),this.gl.drawElements(this.gl.TRIANGLES,e,this.gl.UNSIGNED_SHORT,0),this.gl.useProgram(null),this.setClippingContextBufferForDraw(null),this.setClippingContextBufferForMask(null)}saveProfile(){this._rendererProfile.save()}restoreProfile(){this._rendererProfile.restore()}static doStaticRelease(){Tt.deleteInstance()}setRenderState(t,e){se=t,et=e}preDraw(){if(this.firstDraw&&(this.firstDraw=!1),this.gl.disable(this.gl.SCISSOR_TEST),this.gl.disable(this.gl.STENCIL_TEST),this.gl.disable(this.gl.DEPTH_TEST),this.gl.frontFace(this.gl.CW),this.gl.enable(this.gl.BLEND),this.gl.colorMask(!0,!0,!0,!0),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,null),this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER,null),this.getAnisotropy()>0&&this._extension)for(let t=0;t<this._textures.getSize();++t)this.gl.bindTexture(this.gl.TEXTURE_2D,this._textures.getValue(t)),this.gl.texParameterf(this.gl.TEXTURE_2D,this._extension.TEXTURE_MAX_ANISOTROPY_EXT,this.getAnisotropy())}setClippingContextBufferForMask(t){this._clippingContextBufferForMask=t}getClippingContextBufferForMask(){return this._clippingContextBufferForMask}setClippingContextBufferForDraw(t){this._clippingContextBufferForDraw=t}getClippingContextBufferForDraw(){return this._clippingContextBufferForDraw}startUp(t){this.gl=t,this._clippingManager&&this._clippingManager.setGL(t),Tt.getInstance().setGl(t),this._rendererProfile.setGl(t),this._extension=this.gl.getExtension("EXT_texture_filter_anisotropic")||this.gl.getExtension("WEBKIT_EXT_texture_filter_anisotropic")||this.gl.getExtension("MOZ_EXT_texture_filter_anisotropic")}_textures;_sortedDrawableIndexList;_clippingManager;_clippingContextBufferForMask;_clippingContextBufferForDraw;_rendererProfile;firstDraw;_bufferData;_extension;gl}Gt.staticRelease=()=>{we.doStaticRelease()};var ys;(s=>{s.CubismClippingContext=ms,s.CubismClippingManager_WebGL=Te,s.CubismRenderTextureResource=_s,s.CubismRenderer_WebGL=we,s.CubismShaderSet=Ve,s.CubismShader_WebGL=Tt,s.ShaderNames=ps})(ys||(ys={}));class Ss{isOverwritten=!1;Color=new Z}class xs{constructor(t=!1,e=!1){t=this.isOverwritten,e=this.isCulling}isOverwritten;isCulling}class Cs{update(){this._model.update(),this._model.drawables.resetDynamicFlags()}getPixelsPerUnit(){return this._model==null?0:this._model.canvasinfo.PixelsPerUnit}getCanvasWidth(){return this._model==null?0:this._model.canvasinfo.CanvasWidth/this._model.canvasinfo.PixelsPerUnit}getCanvasHeight(){return this._model==null?0:this._model.canvasinfo.CanvasHeight/this._model.canvasinfo.PixelsPerUnit}saveParameters(){const t=this._model.parameters.count,e=this._savedParameters.getSize();for(let i=0;i<t;++i)i<e?this._savedParameters.set(i,this._parameterValues[i]):this._savedParameters.pushBack(this._parameterValues[i])}getMultiplyColor(t){return this.getOverwriteFlagForModelMultiplyColors()||this.getOverwriteFlagForDrawableMultiplyColors(t)?this._userMultiplyColors.at(t).Color:this.getDrawableMultiplyColor(t)}getScreenColor(t){return this.getOverwriteFlagForModelScreenColors()||this.getOverwriteFlagForDrawableScreenColors(t)?this._userScreenColors.at(t).Color:this.getDrawableScreenColor(t)}setMultiplyColorByTextureColor(t,e){this.setMultiplyColorByRGBA(t,e.R,e.G,e.B,e.A)}setMultiplyColorByRGBA(t,e,i,r,a=1){this._userMultiplyColors.at(t).Color.R=e,this._userMultiplyColors.at(t).Color.G=i,this._userMultiplyColors.at(t).Color.B=r,this._userMultiplyColors.at(t).Color.A=a}setScreenColorByTextureColor(t,e){this.setScreenColorByRGBA(t,e.R,e.G,e.B,e.A)}setScreenColorByRGBA(t,e,i,r,a=1){this._userScreenColors.at(t).Color.R=e,this._userScreenColors.at(t).Color.G=i,this._userScreenColors.at(t).Color.B=r,this._userScreenColors.at(t).Color.A=a}getOverwriteFlagForModelMultiplyColors(){return this._isOverwrittenModelMultiplyColors}getOverwriteFlagForModelScreenColors(){return this._isOverwrittenModelScreenColors}setOverwriteFlagForModelMultiplyColors(t){this._isOverwrittenModelMultiplyColors=t}setOverwriteFlagForModelScreenColors(t){this._isOverwrittenModelScreenColors=t}getOverwriteFlagForDrawableMultiplyColors(t){return this._userMultiplyColors.at(t).isOverwritten}getOverwriteFlagForDrawableScreenColors(t){return this._userMultiplyColors.at(t).isOverwritten}setOverwriteFlagForDrawableMultiplyColors(t,e){this._userMultiplyColors.at(t).isOverwritten=e}setOverwriteFlagForDrawableScreenColors(t,e){this._userScreenColors.at(t).isOverwritten=e}getDrawableCulling(t){if(this.getOverwriteFlagForModelCullings()||this.getOverwriteFlagForDrawableCullings(t))return this._userCullings.at(t).isCulling;const e=this._model.drawables.constantFlags;return!Live2DCubismCore.Utils.hasIsDoubleSidedBit(e[t])}setDrawableCulling(t,e){this._userCullings.at(t).isCulling=e}getOverwriteFlagForModelCullings(){return this._isOverwrittenCullings}setOverwriteFlagForModelCullings(t){this._isOverwrittenCullings=t}getOverwriteFlagForDrawableCullings(t){return this._userCullings.at(t).isOverwritten}setOverwriteFlagForDrawableCullings(t,e){this._userCullings.at(t).isOverwritten=e}getModel(){return this._model}getPartIndex(t){let e;const i=this._model.parts.count;for(e=0;e<i;++e)if(t==this._partIds.at(e))return e;return this._notExistPartId.isExist(t)?this._notExistPartId.getValue(t):(e=i+this._notExistPartId.getSize(),this._notExistPartId.setValue(t,e),this._notExistPartOpacities.appendKey(e),e)}getPartCount(){return this._model.parts.count}setPartOpacityByIndex(t,e){if(this._notExistPartOpacities.isExist(t)){this._notExistPartOpacities.setValue(t,e);return}H(0<=t&&t<this.getPartCount()),this._partOpacities[t]=e}setPartOpacityById(t,e){const i=this.getPartIndex(t);i<0||this.setPartOpacityByIndex(i,e)}getPartOpacityByIndex(t){return this._notExistPartOpacities.isExist(t)?this._notExistPartOpacities.getValue(t):(H(0<=t&&t<this.getPartCount()),this._partOpacities[t])}getPartOpacityById(t){const e=this.getPartIndex(t);return e<0?0:this.getPartOpacityByIndex(e)}getParameterIndex(t){let e;const i=this._model.parameters.count;for(e=0;e<i;++e)if(t==this._parameterIds.at(e))return e;return this._notExistParameterId.isExist(t)?this._notExistParameterId.getValue(t):(e=this._model.parameters.count+this._notExistParameterId.getSize(),this._notExistParameterId.setValue(t,e),this._notExistParameterValues.appendKey(e),e)}getParameterCount(){return this._model.parameters.count}getParameterType(t){return this._model.parameters.types[t]}getParameterMaximumValue(t){return this._model.parameters.maximumValues[t]}getParameterMinimumValue(t){return this._model.parameters.minimumValues[t]}getParameterDefaultValue(t){return this._model.parameters.defaultValues[t]}getParameterValueByIndex(t){return this._notExistParameterValues.isExist(t)?this._notExistParameterValues.getValue(t):(H(0<=t&&t<this.getParameterCount()),this._parameterValues[t])}getParameterValueById(t){const e=this.getParameterIndex(t);return this.getParameterValueByIndex(e)}setParameterValueByIndex(t,e,i=1){if(this._notExistParameterValues.isExist(t)){this._notExistParameterValues.setValue(t,i==1?e:this._notExistParameterValues.getValue(t)*(1-i)+e*i);return}H(0<=t&&t<this.getParameterCount()),this._model.parameters.maximumValues[t]<e&&(e=this._model.parameters.maximumValues[t]),this._model.parameters.minimumValues[t]>e&&(e=this._model.parameters.minimumValues[t]),this._parameterValues[t]=i==1?e:this._parameterValues[t]=this._parameterValues[t]*(1-i)+e*i}setParameterValueById(t,e,i=1){const r=this.getParameterIndex(t);this.setParameterValueByIndex(r,e,i)}addParameterValueByIndex(t,e,i=1){this.setParameterValueByIndex(t,this.getParameterValueByIndex(t)+e*i)}addParameterValueById(t,e,i=1){const r=this.getParameterIndex(t);this.addParameterValueByIndex(r,e,i)}multiplyParameterValueById(t,e,i=1){const r=this.getParameterIndex(t);this.multiplyParameterValueByIndex(r,e,i)}multiplyParameterValueByIndex(t,e,i=1){this.setParameterValueByIndex(t,this.getParameterValueByIndex(t)*(1+(e-1)*i))}getDrawableIndex(t){const e=this._model.drawables.count;for(let i=0;i<e;++i)if(this._drawableIds.at(i)==t)return i;return-1}getDrawableCount(){return this._model.drawables.count}getDrawableId(t){const e=this._model.drawables.ids;return V.getIdManager().getId(e[t])}getDrawableRenderOrders(){return this._model.drawables.renderOrders}getDrawableTextureIndices(t){return this.getDrawableTextureIndex(t)}getDrawableTextureIndex(t){return this._model.drawables.textureIndices[t]}getDrawableDynamicFlagVertexPositionsDidChange(t){const e=this._model.drawables.dynamicFlags;return Live2DCubismCore.Utils.hasVertexPositionsDidChangeBit(e[t])}getDrawableVertexIndexCount(t){return this._model.drawables.indexCounts[t]}getDrawableVertexCount(t){return this._model.drawables.vertexCounts[t]}getDrawableVertices(t){return this.getDrawableVertexPositions(t)}getDrawableVertexIndices(t){return this._model.drawables.indices[t]}getDrawableVertexPositions(t){return this._model.drawables.vertexPositions[t]}getDrawableVertexUvs(t){return this._model.drawables.vertexUvs[t]}getDrawableOpacity(t){return this._model.drawables.opacities[t]}getDrawableMultiplyColor(t){const e=this._model.drawables.multiplyColors,i=t*4,r=new Z;return r.R=e[i],r.G=e[i+1],r.B=e[i+2],r.A=e[i+3],r}getDrawableScreenColor(t){const e=this._model.drawables.screenColors,i=t*4,r=new Z;return r.R=e[i],r.G=e[i+1],r.B=e[i+2],r.A=e[i+3],r}getDrawableParentPartIndex(t){return this._model.drawables.parentPartIndices[t]}getDrawableBlendMode(t){const e=this._model.drawables.constantFlags;return Live2DCubismCore.Utils.hasBlendAdditiveBit(e[t])?G.CubismBlendMode_Additive:Live2DCubismCore.Utils.hasBlendMultiplicativeBit(e[t])?G.CubismBlendMode_Multiplicative:G.CubismBlendMode_Normal}getDrawableInvertedMaskBit(t){const e=this._model.drawables.constantFlags;return Live2DCubismCore.Utils.hasIsInvertedMaskBit(e[t])}getDrawableMasks(){return this._model.drawables.masks}getDrawableMaskCounts(){return this._model.drawables.maskCounts}isUsingMasking(){for(let t=0;t<this._model.drawables.count;++t)if(!(this._model.drawables.maskCounts[t]<=0))return!0;return!1}getDrawableDynamicFlagIsVisible(t){const e=this._model.drawables.dynamicFlags;return Live2DCubismCore.Utils.hasIsVisibleBit(e[t])}getDrawableDynamicFlagVisibilityDidChange(t){const e=this._model.drawables.dynamicFlags;return Live2DCubismCore.Utils.hasVisibilityDidChangeBit(e[t])}getDrawableDynamicFlagOpacityDidChange(t){const e=this._model.drawables.dynamicFlags;return Live2DCubismCore.Utils.hasOpacityDidChangeBit(e[t])}getDrawableDynamicFlagRenderOrderDidChange(t){const e=this._model.drawables.dynamicFlags;return Live2DCubismCore.Utils.hasRenderOrderDidChangeBit(e[t])}getDrawableDynamicFlagBlendColorDidChange(t){const e=this._model.drawables.dynamicFlags;return Live2DCubismCore.Utils.hasBlendColorDidChangeBit(e[t])}loadParameters(){let t=this._model.parameters.count;const e=this._savedParameters.getSize();t>e&&(t=e);for(let i=0;i<t;++i)this._parameterValues[i]=this._savedParameters.at(i)}initialize(){H(this._model),this._parameterValues=this._model.parameters.values,this._partOpacities=this._model.parts.opacities,this._parameterMaximumValues=this._model.parameters.maximumValues,this._parameterMinimumValues=this._model.parameters.minimumValues;{const t=this._model.parameters.ids,e=this._model.parameters.count;this._parameterIds.prepareCapacity(e);for(let i=0;i<e;++i)this._parameterIds.pushBack(V.getIdManager().getId(t[i]))}{const t=this._model.parts.ids,e=this._model.parts.count;this._partIds.prepareCapacity(e);for(let i=0;i<e;++i)this._partIds.pushBack(V.getIdManager().getId(t[i]))}{const t=this._model.drawables.ids,e=this._model.drawables.count;this._userMultiplyColors=new x,this._userMultiplyColors.updateSize(e,Ss,!0),this._userScreenColors=new x,this._userScreenColors.updateSize(e,Ss,!0),this._userCullings=new x,this._userCullings.updateSize(e,xs,!0);const i=new xs(!1,!1);this._drawableIds.prepareCapacity(e);for(let r=0;r<e;++r)this._drawableIds.pushBack(V.getIdManager().getId(t[r])),this.setMultiplyColorByRGBA(r,1,1,1,1),this.setScreenColorByRGBA(r,0,0,0,1),this._userCullings.pushBack(i)}}constructor(t){this._model=t,this._parameterValues=null,this._parameterMaximumValues=null,this._parameterMinimumValues=null,this._partOpacities=null,this._savedParameters=new x,this._parameterIds=new x,this._drawableIds=new x,this._partIds=new x,this._isOverwrittenModelMultiplyColors=!1,this._isOverwrittenModelScreenColors=!1,this._isOverwrittenCullings=!1,this._userMultiplyColors=null,this._userScreenColors=null,this._notExistPartId=new O,this._notExistParameterId=new O,this._notExistParameterValues=new O,this._notExistPartOpacities=new O}release(){this._model.release(),this._model=null}_notExistPartOpacities;_notExistPartId;_notExistParameterValues;_notExistParameterId;_savedParameters;_isOverwrittenModelMultiplyColors;_isOverwrittenModelScreenColors;_userMultiplyColors;_userScreenColors;_model;_parameterValues;_parameterMaximumValues;_parameterMinimumValues;_partOpacities;_parameterIds;_partIds;_drawableIds;_isOverwrittenCullings;_userCullings}var Bs;(s=>{s.CubismModel=Cs})(Bs||(Bs={}));class oe{static create(t){let e=null;const i=Live2DCubismCore.Moc.fromArrayBuffer(t);return i&&(e=new oe(i),e._mocVersion=Live2DCubismCore.Version.csmGetMocVersion(i,t)),e}static delete(t){t._moc._release(),t._moc=null,t=null}createModel(){let t=null;const e=Live2DCubismCore.Model.fromMoc(this._moc);return e&&(t=new Cs(e),t.initialize(),++this._modelCount),t}deleteModel(t){t!=null&&(t.release(),t=null,--this._modelCount)}constructor(t){this._moc=t,this._modelCount=0,this._mocVersion=0}release(){H(this._modelCount==0),this._moc._release(),this._moc=null}getLatestMocVersion(){return Live2DCubismCore.Version.csmGetLatestMocVersion()}getMocVersion(){return this._mocVersion}static hasMocConsistency(t){return Live2DCubismCore.Moc.prototype.hasMocConsistency(t)===1}_moc;_modelCount;_mocVersion}var Ms;(s=>{s.CubismMoc=oe})(Ms||(Ms={}));const Ps="Meta",ba="UserDataCount",Ia="TotalUserDataSize",Re="UserData",Ta="Target",Va="Id",wa="Value";class vs{constructor(t,e){this._json=A.create(t,e)}release(){A.delete(this._json)}getUserDataCount(){return this._json.getRoot().getValueByString(Ps).getValueByString(ba).toInt()}getTotalUserDataSize(){return this._json.getRoot().getValueByString(Ps).getValueByString(Ia).toInt()}getUserDataTargetType(t){return this._json.getRoot().getValueByString(Re).getValueByIndex(t).getValueByString(Ta).getRawString()}getUserDataId(t){return V.getIdManager().getId(this._json.getRoot().getValueByString(Re).getValueByIndex(t).getValueByString(Va).getRawString())}getUserDataValue(t){return this._json.getRoot().getValueByString(Re).getValueByIndex(t).getValueByString(wa).getRawString()}_json}var bs;(s=>{s.CubismModelUserDataJson=vs})(bs||(bs={}));const Ra="ArtMesh";class Is{targetType;targetId;value}class zt{static create(t,e){const i=new zt;return i.parseUserData(t,e),i}static delete(t){t!=null&&(t.release(),t=null)}getArtMeshUserDatas(){return this._artMeshUserDataNode}parseUserData(t,e){let i=new vs(t,e);const r=V.getIdManager().getId(Ra),a=i.getUserDataCount();for(let o=0;o<a;o++){const n=new Is;n.targetId=i.getUserDataId(o),n.targetType=V.getIdManager().getId(i.getUserDataTargetType(o)),n.value=new U(i.getUserDataValue(o)),this._userDataNodes.pushBack(n),n.targetType==r&&this._artMeshUserDataNode.pushBack(n)}i.release(),i=void 0}constructor(){this._userDataNodes=new x,this._artMeshUserDataNode=new x}release(){for(let t=0;t<this._userDataNodes.getSize();++t)this._userDataNodes.set(t,null);this._userDataNodes=null}_userDataNodes;_artMeshUserDataNode}var Ts;(s=>{s.CubismModelUserData=zt,s.CubismModelUserDataNode=Is})(Ts||(Ts={}));class le{isInitialized(){return this._initialized}setInitialized(t){this._initialized=t}isUpdating(){return this._updating}setUpdating(t){this._updating=t}setDragging(t,e){this._dragManager.set(t,e)}setAcceleration(t,e,i){this._accelerationX=t,this._accelerationY=e,this._accelerationZ=i}getModelMatrix(){return this._modelMatrix}setOpacity(t){this._opacity=t}getOpacity(){return this._opacity}loadModel(t){if(this._moc=oe.create(t),this._moc==null){k("Failed to CubismMoc.create().");return}if(this._model=this._moc.createModel(),this._model==null){k("Failed to CreateModel().");return}this._model.saveParameters(),this._modelMatrix=new _i(this._model.getCanvasWidth(),this._model.getCanvasHeight())}loadMotion=(t,e,i,r)=>ne.create(t,e,r);loadExpression(t,e,i){return ae.create(t,e)}loadPose(t,e){this._pose=Ot.create(t,e)}loadUserData(t,e){this._modelUserData=zt.create(t,e)}loadPhysics(t,e){this._physics=Ut.create(t,e)}isHit(t,e,i){const r=this._model.getDrawableIndex(t);if(r<0)return!1;const a=this._model.getDrawableVertexCount(r),o=this._model.getDrawableVertices(r);let n=o[0],l=o[0],u=o[1],h=o[1];for(let g=1;g<a;++g){const c=o[rt.vertexOffset+g*rt.vertexStep],p=o[rt.vertexOffset+g*rt.vertexStep+1];c<n&&(n=c),c>l&&(l=c),p<u&&(u=p),p>h&&(h=p)}const m=this._modelMatrix.invertTransformX(e),d=this._modelMatrix.invertTransformY(i);return n<=m&&m<=l&&u<=d&&d<=h}getModel(){return this._model}getRenderer(){return this._renderer}createRenderer(t=1){this._renderer&&this.deleteRenderer(),this._renderer=new we,this._renderer.initialize(this._model,t)}deleteRenderer(){this._renderer!=null&&(this._renderer.release(),this._renderer=null)}motionEventFired(t){Q("{0}",t.s)}static cubismDefaultMotionEventCallback(t,e,i){const r=i;r?.motionEventFired(e)}constructor(){this._moc=null,this._model=null,this._motionManager=null,this._expressionManager=null,this._eyeBlink=null,this._breath=null,this._modelMatrix=null,this._pose=null,this._dragManager=null,this._physics=null,this._modelUserData=null,this._initialized=!1,this._updating=!1,this._opacity=1,this._lipsync=!0,this._lastLipSyncValue=0,this._dragX=0,this._dragY=0,this._accelerationX=0,this._accelerationY=0,this._accelerationZ=0,this._debugMode=!1,this._renderer=null,this._motionManager=new Ft,this._motionManager.setEventCallback(le.cubismDefaultMotionEventCallback,this),this._expressionManager=new Ft,this._dragManager=new Si}release(){this._motionManager!=null&&(this._motionManager.release(),this._motionManager=null),this._expressionManager!=null&&(this._expressionManager.release(),this._expressionManager=null),this._moc!=null&&(this._moc.deleteModel(this._model),this._moc.release(),this._moc=null),this._modelMatrix=null,Ot.delete(this._pose),Vt.delete(this._eyeBlink),kt.delete(this._breath),this._dragManager=null,Ut.delete(this._physics),zt.delete(this._modelUserData),this.deleteRenderer()}_moc;_model;_motionManager;_expressionManager;_eyeBlink;_breath;_modelMatrix;_pose;_dragManager;_physics;_modelUserData;_initialized;_updating;_opacity;_lipsync;_lastLipSyncValue;_dragX;_dragY;_accelerationX;_accelerationY;_accelerationZ;_debugMode;_renderer}var Vs;(s=>{s.CubismUserModel=le})(Vs||(Vs={}));class I{static _currentFrame=0;static _lastFrame=0;static _deltaTime=0;static loadFileAsBytes(t,e){fetch(t).then(i=>i.arrayBuffer()).then(i=>e(i,i.byteLength))}static getDeltaTime(){return this._deltaTime}static updateTime(){this._currentFrame=Date.now(),this._deltaTime=(this._currentFrame-this._lastFrame)/1e3,this._lastFrame=this._currentFrame}static printMessage(t){F.debug&&console.log(t)}}class Ae{static _instance=null;pcmData;userTimeSeconds;lastRms;sampleOffset;wavFileInfo;byteReader;audio;audioPlayPromise;constructor(){this.pcmData=null,this.userTimeSeconds=0,this.lastRms=0,this.sampleOffset=0,this.wavFileInfo=new Ea,this.byteReader=new Aa,this.audio=new Audio}loadFileToBytes=t=>{this.byteReader._fileByte=t,this.byteReader._fileDataView=new DataView(this.byteReader._fileByte),this.byteReader._fileSize=this.byteReader._fileByte.byteLength,this.byteReader._readOffset=0};static getInstance(){return this._instance==null&&(this._instance=new Ae),this._instance}static releaseInstance(){this._instance!=null&&(this._instance=void 0),this._instance=null}update(t){let e,i;if(this.pcmData==null||this.sampleOffset>=this.wavFileInfo._samplesPerChannel)return this.lastRms=0,!1;this.userTimeSeconds+=t,e=Math.floor(this.userTimeSeconds*this.wavFileInfo._samplingRate),e>this.wavFileInfo._samplesPerChannel&&(e=this.wavFileInfo._samplesPerChannel),i=0;for(let r=0;r<this.wavFileInfo._numberOfChannels;r++)for(let a=this.sampleOffset;a<e;a++){const o=this.pcmData[r][a];i+=o*o}return i=Math.sqrt(i/(this.wavFileInfo._numberOfChannels*(e-this.sampleOffset))),this.lastRms=i,this.sampleOffset=e,!0}async start(t){return this.sampleOffset=0,this.userTimeSeconds=0,this.lastRms=0,this.playWavFile(t),await this.loadWavFile(t)}getRms(){return this.lastRms}async loadWavFile(t){let e=!1;this.pcmData!=null&&this.releasePcmData();const i=async()=>fetch(t).then(r=>r.arrayBuffer());if(this.loadFileToBytes(await i()),this.byteReader._fileSize<4)return!1;this.wavFileInfo._fileName=t;try{if(!this.byteReader.getCheckSignature("RIFF"))throw e=!1,new Error('Cannot find Signeture "RIFF".');if(this.byteReader.get32LittleEndian(),!this.byteReader.getCheckSignature("WAVE"))throw e=!1,new Error('Cannot find Signeture "WAVE".');if(!this.byteReader.getCheckSignature("fmt "))throw e=!1,new Error('Cannot find Signeture "fmt".');const r=this.byteReader.get32LittleEndian();if(this.byteReader.get16LittleEndian()!=1)throw e=!1,new Error("File is not linear PCM.");for(this.wavFileInfo._numberOfChannels=this.byteReader.get16LittleEndian(),this.wavFileInfo._samplingRate=this.byteReader.get32LittleEndian(),this.byteReader.get32LittleEndian(),this.byteReader.get16LittleEndian(),this.wavFileInfo._bitsPerSample=this.byteReader.get16LittleEndian(),r>16&&(this.byteReader._readOffset+=r-16);!this.byteReader.getCheckSignature("data")&&this.byteReader._readOffset<this.byteReader._fileSize;)this.byteReader._readOffset+=this.byteReader.get32LittleEndian()+4;if(this.byteReader._readOffset>=this.byteReader._fileSize)throw e=!1,new Error('Cannot find "data" Chunk.');{const a=this.byteReader.get32LittleEndian();this.wavFileInfo._samplesPerChannel=a*8/(this.wavFileInfo._bitsPerSample*this.wavFileInfo._numberOfChannels)}this.pcmData=new Array(this.wavFileInfo._numberOfChannels);for(let a=0;a<this.wavFileInfo._numberOfChannels;a++)this.pcmData[a]=new Float32Array(this.wavFileInfo._samplesPerChannel);for(let a=0;a<this.wavFileInfo._samplesPerChannel;a++)for(let o=0;o<this.wavFileInfo._numberOfChannels;o++)this.pcmData[o][a]=this.getPcmSample();e=!0}catch(r){console.error(r)}return e}playWavFile(t){this.audio.src=t,this.audioPlayPromise=this.audio.play()}getPcmSample(){let t;switch(this.wavFileInfo._bitsPerSample){case 8:t=this.byteReader.get8()-128,t<<=24;break;case 16:t=this.byteReader.get16LittleEndian()<<16;break;case 24:t=this.byteReader.get24LittleEndian()<<8;break;default:t=0;break}return t/2147483647}releasePcmData(){for(let t=0;t<this.wavFileInfo._numberOfChannels;t++)delete this.pcmData[t];delete this.pcmData,this.pcmData=null}release(){this.audioPlayPromise?.then(()=>this.audio.pause())}}class Ea{_fileName;_numberOfChannels;_bitsPerSample;_samplingRate;_samplesPerChannel;constructor(){this._fileName="",this._numberOfChannels=0,this._bitsPerSample=0,this._samplingRate=0,this._samplesPerChannel=0}}class Aa{_fileByte;_fileDataView;_fileSize;_readOffset;constructor(){this._fileByte=null,this._fileDataView=null,this._fileSize=0,this._readOffset=0}get8(){const t=this._fileDataView.getUint8(this._readOffset);return this._readOffset++,t}get16LittleEndian(){const t=this._fileDataView.getUint8(this._readOffset+1)<<8|this._fileDataView.getUint8(this._readOffset);return this._readOffset+=2,t}get24LittleEndian(){const t=this._fileDataView.getUint8(this._readOffset+2)<<16|this._fileDataView.getUint8(this._readOffset+1)<<8|this._fileDataView.getUint8(this._readOffset);return this._readOffset+=3,t}get32LittleEndian(){const t=this._fileDataView.getUint8(this._readOffset+3)<<24|this._fileDataView.getUint8(this._readOffset+2)<<16|this._fileDataView.getUint8(this._readOffset+1)<<8|this._fileDataView.getUint8(this._readOffset);return this._readOffset+=4,t}getCheckSignature(t){const e=new Uint8Array(4),i=new TextEncoder().encode(t);if(t.length!=4)return!1;for(let r=0;r<4;r++)e[r]=this.get8();return e[0]==i[0]&&e[1]==i[1]&&e[2]==i[2]&&e[3]==i[3]}}class Fa extends le{modelSetting;modelHomeDir;userTimeSeconds;eyeBlinkIds;lipSyncIds;motions;expressions;_hitArea;_userArea;idParamAngleX;idParamAngleY;idParamAngleZ;idParamEyeBallX;idParamEyeBallY;idParamBodyAngleX;state;expressionCount;textureCount;motionCount;allMotionCount;wavFileHandler;_rightArmMotionManager;_leftArmMotionManager;get model(){return this._model}constructor(){super(),this.modelSetting=null,this.modelHomeDir=null,this.userTimeSeconds=0,this.eyeBlinkIds=new x,this.lipSyncIds=new x,this.motions=new O,this.expressions=new O,this._hitArea=new x,this._userArea=new x,this.getParameterId(),this.state=0,this.expressionCount=0,this.textureCount=0,this.motionCount=0,this.allMotionCount=0,this.wavFileHandler=new Ae,this._rightArmMotionManager=new Ft,this._leftArmMotionManager=new Ft}getParameterId(){const t=V.getIdManager();this.idParamAngleX=t.getId(S.ParamAngleX),this.idParamAngleY=t.getId(S.ParamAngleY),this.idParamAngleZ=t.getId(S.ParamAngleZ),this.idParamEyeBallX=t.getId(S.ParamEyeBallX),this.idParamEyeBallY=t.getId(S.ParamEyeBallY),this.idParamBodyAngleX=t.getId(S.ParamBodyAngleX)}loadAssets(t,e){this.modelHomeDir=t,fetch(W.join(t,e),{cache:"no-cache"}).then(i=>i.arrayBuffer()).then(i=>{const r=new ni(i,i.byteLength);this.state=1,this.setupModel(r)})}setupModel(t){if(this._updating=!0,this._initialized=!1,this.modelSetting=t,this.modelSetting.getModelFileName()!=""){const d=this.modelSetting.getModelFileName();fetch(W.join(this.modelHomeDir,d)).then(g=>g.arrayBuffer()).then(g=>{this.loadModel(g),this.state=3,e()}),this.state=2}else I.printMessage("Model data does not exist.");const e=()=>{if(this.modelSetting.getExpressionCount()>0){const d=this.modelSetting.getExpressionCount();for(let g=0;g<d;g++){const c=this.modelSetting.getExpressionName(g),p=this.modelSetting.getExpressionFileName(g);fetch(W.join(this.modelHomeDir,p)).then(_=>_.arrayBuffer()).then(_=>{const B=this.loadExpression(_,_.byteLength,c);this.expressions.getValue(c)!=null&&(vt.delete(this.expressions.getValue(c)),this.expressions.setValue(c,null)),this.expressions.setValue(c,B),this.expressionCount++,this.expressionCount>=d&&(this.state=5,i())})}this.state=4}else this.state=5,i()},i=()=>{if(this.modelSetting.getPhysicsFileName()!=""){const d=this.modelSetting.getPhysicsFileName();fetch(W.join(this.modelHomeDir,d)).then(g=>g.arrayBuffer()).then(g=>{this.loadPhysics(g,g.byteLength),this.state=7,r()}),this.state=6}else this.state=7,r()},r=()=>{if(this.modelSetting.getPoseFileName()!=""){const d=this.modelSetting.getPoseFileName();fetch(W.join(this.modelHomeDir,d)).then(g=>g.arrayBuffer()).then(g=>{this.loadPose(g,g.byteLength),this.state=9,a()}),this.state=8}else this.state=9,a()},a=()=>{this.modelSetting.getEyeBlinkParameterCount()>0&&(this._eyeBlink=Vt.create(this.modelSetting),this.state=10),o()},o=()=>{this._breath=kt.create();const d=new x;d.pushBack(new Pt(this.idParamAngleX,0,15,6.5345,.5)),d.pushBack(new Pt(this.idParamAngleY,0,8,3.5345,.5)),d.pushBack(new Pt(this.idParamAngleZ,0,10,5.5345,.5)),d.pushBack(new Pt(this.idParamBodyAngleX,0,4,15.5345,.5)),d.pushBack(new Pt(V.getIdManager().getId(S.ParamBreath),.5,.5,3.2345,1)),this._breath.setParameters(d),this.state=11,n()},n=()=>{if(this.modelSetting.getUserDataFile()!==""){const d=this.modelSetting.getUserDataFile();fetch(W.join(this.modelHomeDir,d)).then(g=>g.arrayBuffer()).then(g=>{this.loadUserData(g,g.byteLength),this.state=13,l()}),this.state=12}else this.state=13,l()},l=()=>{const d=this.modelSetting.getEyeBlinkParameterCount();for(let g=0;g<d;++g)this.eyeBlinkIds.pushBack(this.modelSetting.getEyeBlinkParameterId(g));this.state=14,u()},u=()=>{const d=this.modelSetting.getLipSyncParameterCount();for(let g=0;g<d;++g)this.lipSyncIds.pushBack(this.modelSetting.getLipSyncParameterId(g));this.state=15,h()},h=()=>{const d=new O;if(this.modelSetting===null||this._modelMatrix===null){k("Failed to setupLayout().");return}this.modelSetting.getLayoutMap(d),this._modelMatrix.setupFromLayout(d),this.state=16,m()},m=()=>{this.state=17,this.model.saveParameters(),this.allMotionCount=0,this.motionCount=0;const d=[],g=this.modelSetting.getMotionGroupCount();for(let c=0;c<g;c++)d[c]=this.modelSetting.getMotionGroupName(c),this.allMotionCount+=this.modelSetting.getMotionCount(d[c]);for(let c=0;c<g;c++)this.preLoadMotionGroup(d[c]);g==0&&this.reloadTextures()}}setupTextures(){if(this.state===20){const e=this.modelSetting.getTextureCount();for(let i=0;i<e;i++){if(this.modelSetting.getTextureFileName(i)===""){I.printMessage("getTextureFileName null");continue}const r=this.modelSetting.getTextureFileName(i),a=W.join(this.modelHomeDir,r),o=n=>{this.getRenderer()?.bindTexture(i,n.id),this.textureCount++,this.textureCount>=e&&(this.state=22)};M.instance.textureManager.createTextureFromPngFile(a,!0,o),this.getRenderer()?.setIsPremultipliedAlpha(!0)}this.state=21}}reloadRenderer(){this.deleteRenderer(),this.createRenderer(),this.setupTextures()}update(){if(this.state!=22)return;const t=I.getDeltaTime();this.userTimeSeconds+=t,this._dragManager.update(t),this._dragX=this._dragManager.getX(),this._dragY=this._dragManager.getY();let e=!1;if(this.model.loadParameters(),this._motionManager.isFinished())this.startRandomMotion(ft.Idle,K.Idle);else{const i=this._motionManager.updateMotion(this.model,t),r=this._rightArmMotionManager.updateMotion(this.model,t),a=this._leftArmMotionManager.updateMotion(this.model,t);e=[i,r,a].some(o=>o)}if(this.model.saveParameters(),e||this._eyeBlink?.updateParameters(this.model,t),this._expressionManager?.updateMotion(this.model,t),this.model.addParameterValueById(this.idParamAngleX,this._dragX*30),this.model.addParameterValueById(this.idParamAngleY,this._dragY*30),this.model.addParameterValueById(this.idParamAngleZ,this._dragX*this._dragY*-30),this.model.addParameterValueById(this.idParamBodyAngleX,this._dragX*10),this.model.addParameterValueById(this.idParamEyeBallX,this._dragX),this.model.addParameterValueById(this.idParamEyeBallY,this._dragY),this._breath?.updateParameters(this.model,t),this._physics?.evaluate(this.model,t),this._lipsync){this.wavFileHandler?.update(t);const i=this.wavFileHandler.getRms();for(let r=0;r<this.lipSyncIds.getSize();++r)this.model.addParameterValueById(this.lipSyncIds.at(r),i,.8)}this._pose?.updateParameters(this.model,t),this.model.update()}startMotion(t,e,i,r){if(i==K.Force)this._motionManager.setReservePriority(i);else if(!this._motionManager.reserveMotion(i))return this._debugMode&&I.printMessage("[APP]can't start motion."),gt;const{motion:a,autoDelete:o}=this.getMotion(t,e,r),n=this.modelSetting.getMotionSoundFileName(t,e);if(n.localeCompare("")!=0){let l=this.modelHomeDir+n;this.wavFileHandler.start(l).catch()}return this._debugMode&&I.printMessage(`[APP]start motion: [${t}_${e}`),this._motionManager.startMotionPriority(a,o,i)}startRandomMotion(t,e,i){if(this.modelSetting.getMotionCount(t)==0)return gt;const r=Math.floor(Math.random()*this.modelSetting.getMotionCount(t));return this.startMotion(t,r,e,i)}getMotion(t,e,i){const r=this.modelSetting.getMotionFileName(t,e),a=`${t}_${e}`;let o=this.motions.getValue(a),n=!1;const l=W.join(this.modelHomeDir,r);return o==null?fetch(l).then(u=>u.arrayBuffer()).then(u=>{o=this.loadMotion(u,u.byteLength,null,i);let h=this.modelSetting.getMotionFadeInTimeValue(t,e);h>=0&&o.setFadeInTime(h),h=this.modelSetting.getMotionFadeOutTimeValue(t,e),h>=0&&o.setFadeOutTime(h),o.setEffectIds(this.eyeBlinkIds,this.lipSyncIds),n=!0}):o.setFinishedMotionHandler(i),{motion:o,autoDelete:n}}startHandMotion(t,e,i,r,a){if(r==K.Force)t.setReservePriority(r);else if(!t.reserveMotion(r))return this._debugMode&&I.printMessage("[APP]can't start motion."),gt;const{motion:o,autoDelete:n}=this.getMotion(e,i,a),l=this.modelSetting.getMotionSoundFileName(e,i);if(l.localeCompare("")!=0){let u=this.modelHomeDir+l;this.wavFileHandler.start(u).catch()}return this._debugMode&&I.printMessage(`[APP]start motion: ${name}`),t.startMotionPriority(o,n,r)}startRandomRightHandMotion(t,e,i){if(this.modelSetting.getMotionCount(t)==0)return gt;let r=Math.floor(Math.random()*this.modelSetting.getMotionCount(t));return this.startHandMotion(this._rightArmMotionManager,t,r,e,i)}startRandomLeftHandMotion(t,e,i){if(this.modelSetting.getMotionCount(t)==0)return gt;let r=Math.floor(Math.random()*this.modelSetting.getMotionCount(t));return this.startHandMotion(this._leftArmMotionManager,t,r,e,i)}setExpression(t){const e=this.expressions.getValue(t);this._debugMode&&I.printMessage(`[APP]expression: [${t}]`),e!=null?this._expressionManager.startMotionPriority(e,!1,K.Force):this._debugMode&&I.printMessage(`[APP]expression[${t}] is null`)}setRandomExpression(){if(this.expressions.getSize()==0)return;const t=Math.floor(Math.random()*this.expressions.getSize());for(let e=0;e<this.expressions.getSize();e++)if(e==t){const i=this.expressions._keyValues[e].first;this.setExpression(i);return}}motionEventFired(t){Q("{0} is fired on LAppModel!!",t.s)}hitOpacity(){return this._opacity<1}hitTest(t,e,i){if(this.hitOpacity())return!1;const r=this.modelSetting.getHitAreasCount();for(let a=0;a<r;a++)if(this.modelSetting.getHitAreaName(a)==t){const o=this.modelSetting.getHitAreaId(a);return this.isHit(o,e,i)}return!1}preLoadMotionGroup(t){for(let e=0;e<this.modelSetting.getMotionCount(t);e++){const i=this.modelSetting.getMotionFileName(t,e),r=`${t}_${e}`;this._debugMode&&I.printMessage(`[APP]load motion: ${i} => [${r}]`),fetch(W.join(this.modelHomeDir,i)).then(a=>a.arrayBuffer()).then(a=>{const o=this.loadMotion(a,a.byteLength,r);let n=this.modelSetting.getMotionFadeInTimeValue(t,e);n>=0&&o.setFadeInTime(n),n=this.modelSetting.getMotionFadeOutTimeValue(t,e),n>=0&&o.setFadeOutTime(n),o.setEffectIds(this.eyeBlinkIds,this.lipSyncIds),this.motions.getValue(r)!=null&&vt.delete(this.motions.getValue(r)),this.motions.setValue(r,o),this.motionCount++,this.motionCount>=this.allMotionCount&&this.reloadTextures()})}}reloadTextures(){this.state=20,this._motionManager?.stopAllMotions(),this._updating=!1,this._initialized=!0,this.createRenderer(),this.setupTextures(),this.getRenderer().startUp(M.gl)}releaseMotions(){this.motions.clear()}releaseExpressions(){this.expressions.clear()}doDraw(){if(this.model==null)return;const t=[0,0,M.canvas.width,M.canvas.height];this.getRenderer().setRenderState(M.frameBuffer,t),this.getRenderer().drawModel()}draw(t){this.model!==null&&this.state==22&&(t.multiplyByMatrix(this._modelMatrix),this.getRenderer().setMvpMatrix(t),this.doDraw())}release(){this._leftArmMotionManager.release(),this._rightArmMotionManager.release(),this.wavFileHandler.release(),super.release()}}class q{viewMatrix;models;sceneIndex;static _instance=null;static get instance(){return this.initialize()}constructor(){this.viewMatrix=new E,this.models=new x,this.sceneIndex=0,this.changeScene(0)}_finishedMotion=t=>{I.printMessage("Motion Finished: OK")};static initialize(){return this._instance==null&&(this._instance=new q),this._instance}static releaseInstance(){this._instance!=null&&(this._instance=void 0),this._instance=null}getModel(t){return t<this.models.getSize()?this.models.at(t):null}releaseAllModel(){for(let t=0;t<this.models.getSize();t++)this.models.at(t).release(),this.models.set(t,null);this.models.clear()}onDrag(t,e){for(let i=0;i<this.models.getSize();i++){const r=this.getModel(i);r&&r.setDragging(t,e)}}onTap(t,e){I.printMessage(`[APP]tap point: {x: ${t.toFixed(2)} y: ${e.toFixed(2)}}`);for(let i=0;i<this.models.getSize();i++){const r=this.models.at(i);if(r.modelSetting.getHitAreasCount()===0){I.printMessage(`[APP]hit area: [${R.Other}]`),r.startRandomMotion(ft.Tap,K.Normal,this._finishedMotion),It.emit(R.Other);return}r.hitTest(R.Head,t,e)?(I.printMessage(`[APP]hit area: [${R.Head}]`),r.setRandomExpression(),It.emit(R.Head)):r.hitTest(R.Left,t,e)?(I.printMessage(`[APP]hit area: [${R.Body+R.Left}]`),r.startRandomLeftHandMotion(ft.TapLeft,K.Normal,this._finishedMotion),It.emit(R.Left)):r.hitTest(R.Right,t,e)?(I.printMessage(`[APP]hit area: [${R.Body+R.Right}]`),r.startRandomRightHandMotion(ft.TapRight,K.Normal,this._finishedMotion),It.emit(R.Right)):r.hitTest(R.Body,t,e)&&(I.printMessage(`[APP]hit area: [${R.Body}]`),r.startRandomMotion(ft.TapBody,K.Normal,this._finishedMotion),It.emit(R.Body))}}onUpdate(){const{width:t,height:e}=M.canvas,i=this.models.getSize();for(let r=0;r<i;++r){const a=new E,o=this.getModel(r);o.getModel()&&(o.getModel().getCanvasWidth()>1&&t<e?(o.getModelMatrix().setWidth(2),a.scale(1,t/e)):a.scale(e/t,1),a.multiplyByMatrix(this.viewMatrix)),o.update(),o.draw(a)}}prevScene(){const t=(this.sceneIndex-1)%F.source.models.length;this.changeScene(t)}nextScene(){const t=(this.sceneIndex+1)%F.source.models.length;this.changeScene(t)}changeScene(t){this.sceneIndex=t,I.printMessage(`[APP]model index: ${this.sceneIndex}`);const e=F.source.models.at(t),i=W.join(F.source.path,e);let r=`${e}.model3.json`;this.releaseAllModel(),this.models.pushBack(new Fa),this.models.at(0).loadAssets(i,r)}setViewMatrix(t){for(let e=0;e<16;e++)this.viewMatrix.getArray()[e]=t.getArray()[e]}}class La{textures;constructor(){this.textures=new x}release(){for(let t=this.textures.begin();t.notEqual(this.textures.end());t.preIncrement())M.gl.deleteTexture(t.ptr().id);this.textures=new x}createTextureFromPngFile(t,e,i){for(let a=this.textures.begin();a.notEqual(this.textures.end());a.preIncrement())if(a.ptr().fileName==t&&a.ptr().usePremultply==e){a.ptr().img=new Image,a.ptr().img.onload=()=>i(a.ptr()),a.ptr().img.src=t;return}const r=new Image;r.onload=()=>{const a=M.gl,o=a.createTexture();a.bindTexture(a.TEXTURE_2D,o),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.LINEAR_MIPMAP_LINEAR),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,a.LINEAR),e&&a.pixelStorei(a.UNPACK_PREMULTIPLY_ALPHA_WEBGL,1),a.texImage2D(a.TEXTURE_2D,0,a.RGBA,a.RGBA,a.UNSIGNED_BYTE,r),a.generateMipmap(a.TEXTURE_2D),a.bindTexture(a.TEXTURE_2D,null);const n=new Da;n!=null&&(n.fileName=t,n.width=r.width,n.height=r.height,n.id=o,n.img=r,n.usePremultply=e,this.textures.pushBack(n)),i(n)},r.src=t}releaseTextures(){for(let t=0;t<this.textures.getSize();t++)this.textures.set(t,null);this.textures.clear()}releaseTextureByTexture(t){for(let e=0;e<this.textures.getSize();e++)if(this.textures.at(e).id==t){this.textures.set(e,null),this.textures.remove(e);break}}releaseTextureByFilePath(t){for(let e=0;e<this.textures.getSize();e++)if(this.textures.at(e).fileName==t){this.textures.set(e,null),this.textures.remove(e);break}}}class Da{img;id=null;width=0;height=0;usePremultply;fileName}class ws extends E{constructor(){super(),this._screenLeft=0,this._screenRight=0,this._screenTop=0,this._screenBottom=0,this._maxLeft=0,this._maxRight=0,this._maxTop=0,this._maxBottom=0,this._maxScale=0,this._minScale=0}adjustTranslate(t,e){this._tr[0]*this._maxLeft+(this._tr[12]+t)>this._screenLeft&&(t=this._screenLeft-this._tr[0]*this._maxLeft-this._tr[12]),this._tr[0]*this._maxRight+(this._tr[12]+t)<this._screenRight&&(t=this._screenRight-this._tr[0]*this._maxRight-this._tr[12]),this._tr[5]*this._maxTop+(this._tr[13]+e)<this._screenTop&&(e=this._screenTop-this._tr[5]*this._maxTop-this._tr[13]),this._tr[5]*this._maxBottom+(this._tr[13]+e)>this._screenBottom&&(e=this._screenBottom-this._tr[5]*this._maxBottom-this._tr[13]);const i=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,t,e,0,1]);E.multiply(i,this._tr,this._tr)}adjustScale(t,e,i){const r=this.getMaxScale(),a=this.getMinScale(),o=i*this._tr[0];o<a?this._tr[0]>0&&(i=a/this._tr[0]):o>r&&this._tr[0]>0&&(i=r/this._tr[0]);const n=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,t,e,0,1]),l=new Float32Array([i,0,0,0,0,i,0,0,0,0,1,0,0,0,0,1]),u=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,-t,-e,0,1]);E.multiply(u,this._tr,this._tr),E.multiply(l,this._tr,this._tr),E.multiply(n,this._tr,this._tr)}setScreenRect(t,e,i,r){this._screenLeft=t,this._screenRight=e,this._screenBottom=i,this._screenTop=r}setMaxScreenRect(t,e,i,r){this._maxLeft=t,this._maxRight=e,this._maxTop=r,this._maxBottom=i}setMaxScale(t){this._maxScale=t}setMinScale(t){this._minScale=t}getMaxScale(){return this._maxScale}getMinScale(){return this._minScale}isMaxScale(){return this.getScaleX()>=this._maxScale}isMinScale(){return this.getScaleX()<=this._minScale}getScreenLeft(){return this._screenLeft}getScreenRight(){return this._screenRight}getScreenBottom(){return this._screenBottom}getScreenTop(){return this._screenTop}getMaxLeft(){return this._maxLeft}getMaxRight(){return this._maxRight}getMaxBottom(){return this._maxBottom}getMaxTop(){return this._maxTop}_screenLeft;_screenRight;_screenTop;_screenBottom;_maxLeft;_maxRight;_maxTop;_maxBottom;_maxScale;_minScale}var Rs;(s=>{s.CubismViewMatrix=ws})(Rs||(Rs={}));class ka{texture;vertexBuffer;uvBuffer;indexBuffer;rect;positionLocation;uvLocation;textureLocation;positionArray;uvArray;indexArray;firstDraw;hitCallback;constructor(t,e,i,r,a,o){this.rect=new Oa,this.rect.left=t-i*.5,this.rect.right=t+i*.5,this.rect.up=e+r*.5,this.rect.down=e-r*.5,this.texture=a,this.vertexBuffer=null,this.uvBuffer=null,this.indexBuffer=null,this.positionLocation=null,this.uvLocation=null,this.textureLocation=null,this.positionArray=null,this.uvArray=null,this.indexArray=null,this.firstDraw=!0,this.hitCallback=o}release(){this.rect=null;const t=M.gl;t.deleteTexture(this.texture),this.texture=null,t.deleteBuffer(this.uvBuffer),this.uvBuffer=null,t.deleteBuffer(this.vertexBuffer),this.vertexBuffer=null,t.deleteBuffer(this.indexBuffer),this.indexBuffer=null}getTexture(){return this.texture}render(t){if(this.texture==null)return;const e=M.gl;if(this.firstDraw){this.positionLocation=e.getAttribLocation(t,"position"),e.enableVertexAttribArray(this.positionLocation),this.uvLocation=e.getAttribLocation(t,"uv"),e.enableVertexAttribArray(this.uvLocation),this.textureLocation=e.getUniformLocation(t,"texture"),e.uniform1i(this.textureLocation,0),this.uvArray=new Float32Array([1,0,0,0,0,1,1,1]),this.uvBuffer=e.createBuffer();{const i=M.canvas.width,r=M.canvas.height;this.positionArray=new Float32Array([(this.rect.right-i*.5)/(i*.5),(this.rect.up-r*.5)/(r*.5),(this.rect.left-i*.5)/(i*.5),(this.rect.up-r*.5)/(r*.5),(this.rect.left-i*.5)/(i*.5),(this.rect.down-r*.5)/(r*.5),(this.rect.right-i*.5)/(i*.5),(this.rect.down-r*.5)/(r*.5)]),this.vertexBuffer=e.createBuffer()}this.indexArray=new Uint16Array([0,1,2,3,2,0]),this.indexBuffer=e.createBuffer(),this.firstDraw=!1}e.bindBuffer(e.ARRAY_BUFFER,this.uvBuffer),e.bufferData(e.ARRAY_BUFFER,this.uvArray,e.STATIC_DRAW),e.vertexAttribPointer(this.uvLocation,2,e.FLOAT,!1,0,0),e.bindBuffer(e.ARRAY_BUFFER,this.vertexBuffer),e.bufferData(e.ARRAY_BUFFER,this.positionArray,e.STATIC_DRAW),e.vertexAttribPointer(this.positionLocation,2,e.FLOAT,!1,0,0),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,this.indexBuffer),e.bufferData(e.ELEMENT_ARRAY_BUFFER,this.indexArray,e.DYNAMIC_DRAW),e.bindTexture(e.TEXTURE_2D,this.texture),e.drawElements(e.TRIANGLES,this.indexArray.length,e.UNSIGNED_SHORT,0)}isHit(t,e){const{height:i}=M.canvas,r=i-e;return t>=this.rect.left&&t<=this.rect.right&&r<=this.rect.up&&r>=this.rect.down}}class Oa{left;right;up;down}class Na{startY;startX;lastX;lastY;lastX1;lastY1;lastX2;lastY2;lastTouchDistance;deltaX;deltaY;scale;touchSingle;flipAvailable;constructor(){this.startX=0,this.startY=0,this.lastX=0,this.lastY=0,this.lastX1=0,this.lastY1=0,this.lastX2=0,this.lastY2=0,this.lastTouchDistance=0,this.deltaX=0,this.deltaY=0,this.scale=1,this.touchSingle=!1,this.flipAvailable=!1}getCenterX(){return this.lastX}getCenterY(){return this.lastY}getDeltaX(){return this.deltaX}getDeltaY(){return this.deltaY}getStartX(){return this.startX}getStartY(){return this.startY}getScale(){return this.scale}getX(){return this.lastX}getY(){return this.lastY}getX1(){return this.lastX1}getY1(){return this.lastY1}getX2(){return this.lastX2}getY2(){return this.lastY2}isSingleTouch(){return this.touchSingle}isFlickAvailable(){return this.flipAvailable}disableFlick(){this.flipAvailable=!1}touchesBegan(t,e){this.lastX=t,this.lastY=e,this.startX=t,this.startY=e,this.lastTouchDistance=-1,this.flipAvailable=!0,this.touchSingle=!0}touchesMoved(t,e){this.lastX=t,this.lastY=e,this.lastTouchDistance=-1,this.touchSingle=!0}getFlickDistance(){return this.calculateDistance(this.startX,this.startY,this.lastX,this.lastY)}calculateDistance(t,e,i,r){return Math.sqrt((t-i)*(t-i)+(e-r)*(e-r))}calculateMovingAmount(t,e){if(t>0!=e>0)return 0;const i=t>0?1:-1,r=Math.abs(t),a=Math.abs(e);return i*(r<a?r:a)}}class Ua{touchManager;deviceToScreen;viewMatrix;sprites=[];programId;released=!1;constructor(){this.programId=null,this.released=!1,this.touchManager=new Na,this.deviceToScreen=new E,this.viewMatrix=new ws}initialize(){const{width:t,height:e}=M.canvas,i=t/e,r=-i,a=i??Yt.Right,o=Yt.Bottom,n=Yt.Top;if(this.viewMatrix.setScreenRect(r,a,o,n),this.viewMatrix.scale(F.scale,F.scale),this.deviceToScreen.loadIdentity(),t>e){const l=Math.abs(a-r);this.deviceToScreen.scaleRelative(l/t,-l/t)}else{const l=Math.abs(n-o);this.deviceToScreen.scaleRelative(l/e,-l/e)}this.deviceToScreen.translateRelative(-t*.5,-e*.5),this.viewMatrix.setMaxScale(ue.Max),this.viewMatrix.setMinScale(ue.Min),this.viewMatrix.setMaxScreenRect(wt.Left,wt.Right,wt.Bottom,wt.Top)}release(){this.sprites.forEach(t=>t.release()),this.sprites.length=0,M.gl.deleteProgram(this.programId),this.released=!0}render(){const t=M.gl;t.useProgram(this.programId),this.sprites.forEach(e=>e.render(this.programId)),t.flush(),q.instance.setViewMatrix(this.viewMatrix),q.instance.onUpdate()}addSprite(t,e,i,r){M.instance.textureManager.createTextureFromPngFile(t,!1,a=>{const{width:o,height:n}=M.canvas,l=e?e.x:o-a.width*.5,u=e?e.y:n-a.height*.5,h=i?i.width:a.width,m=i?i.height:a.height,d=new ka(l,u,h,m,a.id,r);this.sprites.push(d)})}initializeSprite(){this.programId=M.instance.createShader()}onTouchesBegan(t,e){this.touchManager.touchesBegan(t,e)}onTouchesMoved(t,e){const i=this.transformViewX(this.touchManager.getX()),r=this.transformViewY(this.touchManager.getY());this.touchManager.touchesMoved(t,e),q.instance.onDrag(i,r)}onTouchesEnded(t,e){q.instance.onDrag(0,0);{const i=this.deviceToScreen.transformX(this.touchManager.getX()),r=this.deviceToScreen.transformY(this.touchManager.getY());"ontouchend"in M.canvas&&I.printMessage(`[APP]touchesEnded x: ${i} y: ${r}`),q.instance.onTap(i,r),this.sprites.forEach(a=>{a.isHit(t,e)&&a.hitCallback()})}}transformViewX(t){const e=this.deviceToScreen.transformX(t);return this.viewMatrix.invertTransformX(e)}transformViewY(t){const e=this.deviceToScreen.transformY(t);return this.viewMatrix.invertTransformY(e)}transformScreenX(t){return this.deviceToScreen.transformX(t)}transformScreenY(t){return this.deviceToScreen.transformY(t)}}class M{cubismOption;view;captured;textureManager;static _instance=null;static frameBuffer=null;static canvas=null;static gl=null;canvasId="live2d-canvas";loopId=0;static get instance(){return this._instance==null&&(this._instance=new M),this._instance}constructor(){this.captured=!1,this.cubismOption=new Us,this.view=new Ua,this.textureManager=new La}static releaseInstance(){this._instance!=null&&this._instance.release(),this._instance=null}initialize(){const t=M.canvas=this.getCanvas(),e=M.gl=t.getContext("webgl")||t.getContext("experimental-webgl");return e?(M.frameBuffer||(M.frameBuffer=e.getParameter(e.FRAMEBUFFER_BINDING)),e.enable(e.BLEND),e.blendFunc(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA),this.onEvent(),this.view.initialize(),this.initializeCubism(),!0):(alert("Cannot initialize WebGL. This browser does not support."),M.gl=null,ht.body.innerHTML="This browser does not support the <code>&lt;canvas&gt;</code> element.",!1)}getCanvas(){let t=ht.querySelector(`#${this.canvasId}`);return t?this.release():(t=ht.createElement("canvas"),t.setAttribute("id",this.canvasId)),F.canvas==="auto"?this._resizeCanvas():(t.width=F.canvas.width||t.width,t.height=F.canvas.height||t.height),F.target.appendChild(t),t}onEvent(){const t=M.canvas;"ontouchend"in t?(t.ontouchstart=ja,t.ontouchmove=Ga,t.ontouchend=Es,t.ontouchcancel=Es):(t.onmousedown=za,t.onmousemove=Xa,t.onmouseup=Ya)}onResize(){this._resizeCanvas(),this.view.initialize(),this.view.initializeSprite();const{width:t,height:e}=M.canvas;M.gl.viewport(0,0,t,e)}release(){this.textureManager.release(),this.view.release(),cancelAnimationFrame(this.loopId),q.releaseInstance(),V.dispose()}run(){const t=()=>{if(!M.instance)return;I.updateTime();const e=M.gl;e.clearColor(0,0,0,0),e.enable(e.DEPTH_TEST),e.depthFunc(e.LEQUAL),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT),e.clearDepth(1),e.enable(e.BLEND),e.blendFunc(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA),this.view.render(),this.loopId=requestAnimationFrame(t)};t()}createShader(){const t=M.gl,e=t.createShader(t.VERTEX_SHADER);if(e===null)return I.printMessage("failed to create vertexShader"),null;const i=`
        precision mediump float;
        attribute vec3 position;
        attribute vec2 uv;
        varying vec2 vuv;
        void main(void)
        {
           gl_Position = vec4(position, 1.0);
           vuv = uv;
        }
      `;t.shaderSource(e,i),t.compileShader(e);const r=t.createShader(t.FRAGMENT_SHADER);if(r==null)return I.printMessage("failed to create fragmentShader"),null;const a=`
        precision mediump float;
        varying vec2 vuv;
        uniform sampler2D texture;
        void main(void)
        {
           gl_FragColor = texture2D(texture, vuv);
        }
      `;t.shaderSource(r,a),t.compileShader(r);const o=t.createProgram();return t.attachShader(o,e),t.attachShader(o,r),t.deleteShader(e),t.deleteShader(r),t.linkProgram(o),t.useProgram(o),o}initializeCubism(){this.cubismOption.logFunction=I.printMessage,this.cubismOption.loggingLevel=Mt.LogLevel_Error,V.startUp(this.cubismOption),V.initialize(),q.initialize(),I.updateTime(),this.view.initializeSprite()}_resizeCanvas(){M.canvas.width=window.innerWidth,M.canvas.height=window.innerHeight}}function za(s){if(M.instance.captured=!0,M.instance.view.released){I.printMessage("view released");return}const t=s.target.getBoundingClientRect(),e=s.pageX-t.left,i=s.pageY-t.top;M.instance.view.onTouchesBegan(e,i)}function Xa(s){if(!M.instance.captured)return;if(M.instance.view.released){I.printMessage("view released");return}const t=s.target.getBoundingClientRect(),e=s.clientX-t.left,i=s.clientY-t.top;M.instance.view.onTouchesMoved(e,i)}function Ya(s){if(M.instance.captured=!1,M.instance.view.released){I.printMessage("view released");return}const t=s.target.getBoundingClientRect(),e=s.clientX-t.left,i=s.clientY-t.top;M.instance.view.onTouchesEnded(e,i)}function ja(s){if(M.instance.captured=!0,M.instance.view.released){I.printMessage("view released");return}const t=s.target.getBoundingClientRect(),e=s.changedTouches[0].clientX-t.left,i=s.changedTouches[0].clientY-t.top;M.instance.view.onTouchesBegan(e,i)}function Ga(s){if(!M.instance.captured)return;if(M.instance.view.released){I.printMessage("view released");return}const t=s.target.getBoundingClientRect(),e=s.changedTouches[0].clientX-t.left,i=s.changedTouches[0].clientY-t.top;M.instance.view.onTouchesMoved(e,i)}function Es(s){if(M.instance.captured=!1,M.instance.view.released){I.printMessage("view released");return}const t=s.target.getBoundingClientRect(),e=s.changedTouches[0].clientX-t.left,i=s.changedTouches[0].clientY-t.top;M.instance.view.onTouchesEnded(e,i)}class As{static eventListener={[R.Head]:[],[R.Body]:[],[R.Left]:[],[R.Right]:[],[R.Other]:[]};static get model(){return M.instance}static get scene(){return q.instance}static get view(){return this.model.view}static async loadScript(){return new Promise(t=>{globalThis.Live2DCubismCore&&t(globalThis.Live2DCubismCore);const e=ht.createElement("script");e.src=F.cubismCorePath,ht.body.appendChild(e),e.onload=()=>t(globalThis.Live2DCubismCore)})}static async init(t){Ls(t),await this.loadScript(),this.model.initialize()&&(this.model.run(),this.listener())}static async release(){return this.model.release()}static listener(){window.addEventListener("beforeunload",()=>this.model.release()),window.addEventListener("resize",()=>F.canvas==="auto"&&this.model.onResize())}static on(t,e){this.eventListener[t]?.push(e)}static emit(t){this.eventListener[t]?.forEach(e=>e())}}var It=As;export{R as HitArea,As as Live2dWidget,It as default};
//# sourceMappingURL=live2dWidget.esm.js.map
